<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Royal Muhasebe</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#161b22">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Royal Muhasebe">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
<noscript><link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"></noscript>
<!-- Chart.js â€” defer ile yÃ¼kle, ilk render'Ä± bloke etmesin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" defer></script>
<!-- XLSX â€” defer ile yÃ¼kle, sadece export sÄ±rasÄ±nda gerekli -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* â”€â”€ GÄ°RÄ°Å EKRANI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#login-screen{
  position:fixed;inset:0;z-index:9999;
  background:#0d1117;
  display:flex;align-items:center;justify-content:center;
}
#login-screen.hidden{display:none}
.login-box{
  background:#161b22;border:1px solid #30363d;border-radius:16px;
  padding:48px 40px;text-align:center;max-width:380px;width:90%;
}
.login-logo{font-size:48px;margin-bottom:16px}
.login-title{font-size:22px;font-weight:700;color:#e6edf3;margin-bottom:8px}
.login-sub{font-size:14px;color:#8b949e;margin-bottom:32px;line-height:1.5}
.login-btn{
  display:flex;align-items:center;justify-content:center;gap:12px;
  width:100%;padding:14px 24px;border-radius:10px;border:1px solid #30363d;
  background:#21262d;color:#e6edf3;font-size:15px;font-weight:600;
  cursor:pointer;transition:all .2s;
}
.login-btn:hover{background:#30363d;border-color:#8b949e}
.login-btn svg{width:20px;height:20px}
.login-error{
  margin-top:16px;padding:10px 14px;border-radius:8px;
  background:rgba(248,81,73,.1);border:1px solid rgba(248,81,73,.3);
  color:#f85149;font-size:13px;display:none;
}
.login-loading{color:#8b949e;font-size:13px;margin-top:16px;display:none}
</style>
<style>
/* â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0d1117;
  --surface:#161b22;
  --surface2:#1c2333;
  --surface3:#21262d;
  --border:#30363d;
  --border2:#21262d;
  --text:#e6edf3;
  --text2:#8b949e;
  --text3:#484f58;
  /* Light mode renk geÃ§iÅŸi iÃ§in transition */
  color-scheme: dark;
}

/* â”€â”€ GÃœNDÃœZ MODU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
body.light-mode {
  --bg:#f0f4f8;
  --surface:#ffffff;
  --surface2:#e8edf2;
  --surface3:#dce3ea;
  --border:#c9d3dc;
  --border2:#dce3ea;
  --text:#1a2330;
  --text2:#4a5568;
  --text3:#8a9ab0;
  color-scheme: light;
}
body.light-mode .kpi-card{background:var(--surface);border-color:var(--border)}
body.light-mode .modal{background:var(--surface);border:1px solid var(--border)}
body.light-mode .modal-overlay{background:rgba(0,0,0,.35)}
body.light-mode .form-input,
body.light-mode .form-select,
body.light-mode .form-textarea{background:var(--surface);border-color:var(--border);color:var(--text)}
body.light-mode .btn-secondary{background:var(--surface2);border-color:var(--border);color:var(--text)}
body.light-mode table th{background:var(--surface2);color:var(--text2)}
body.light-mode table tbody tr:hover{background:var(--surface2)}
body.light-mode .nav-item:hover{background:rgba(0,0,0,.05)}
body.light-mode .toast{background:var(--surface);border-color:var(--border);color:var(--text)}
body.light-mode #sidebar{box-shadow:2px 0 8px rgba(0,0,0,.08)}
/* Transition for smooth switch - only active during theme change to avoid paint overhead */
body.theme-transitioning,
body.theme-transitioning #sidebar,
body.theme-transitioning .card,
body.theme-transitioning .nav-item,
body.theme-transitioning .modal,
body.theme-transitioning .form-input,
body.theme-transitioning .form-select,
body.theme-transitioning .form-textarea,
body.theme-transitioning .btn,
body.theme-transitioning .btn-icon,
body.theme-transitioning table td,
body.theme-transitioning table th,
body.theme-transitioning .kpi-card,
body.theme-transitioning .badge,
body.theme-transitioning .toast{
  transition:background-color .2s ease, border-color .2s ease, color .15s ease
}

/* Theme toggle button */
.theme-toggle{
  background:none;border:1px solid var(--border);border-radius:20px;
  padding:4px 10px;cursor:pointer;font-size:12px;color:var(--text2);
  display:flex;align-items:center;gap:6px;transition:all .2s;white-space:nowrap;
}
.theme-toggle:hover{border-color:var(--blue);color:var(--text)}

:root{
  --accent:#2ea043;
  --accent2:#388bfd;
  --accent3:#f78166;
  --accent4:#d2a8ff;
  --accent5:#ffa657;
  --red:#ff7b72;     --red-rgb:255,123,114;
  --yellow:#e3b341;  --yellow-rgb:227,179,65;
  --green:#3fb950;   --green-rgb:63,185,80;
  --blue:#58a6ff;    --blue-rgb:88,166,255;
  --purple:#bc8cff;  --purple-rgb:188,140,255;
  --orange:#ffa657;  --orange-rgb:255,166,87;
  --gray:#6e7681;    --gray-rgb:110,118,129;
  --teal:#39d353;
  --navy:#1f6feb;
  --r4:4px;--r8:8px;--r12:12px;--r16:16px;
  --shadow:0 1px 3px rgba(0,0,0,.4),0 4px 12px rgba(0,0,0,.3);
  --shadow2:0 8px 32px rgba(0,0,0,.5);
  --font:'DM Sans',sans-serif;
  --mono:'DM Mono',monospace;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font);font-size:14px;line-height:1.5;overflow:hidden}

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{display:flex;height:100vh}

/* â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sidebar{
  width:220px;min-width:220px;background:var(--surface);
  border-right:1px solid var(--border);display:flex;flex-direction:column;
  transition:width .2s ease;z-index:100;
}
.sb-logo{
  padding:20px 16px 16px;border-bottom:1px solid var(--border2);
  display:flex;align-items:center;gap:10px;
}
.sb-logo-icon{
  width:32px;height:32px;background:linear-gradient(135deg,var(--navy),var(--blue));
  border-radius:var(--r8);display:flex;align-items:center;justify-content:center;
  font-size:16px;flex-shrink:0;
}
.sb-logo-text{font-size:13px;font-weight:700;color:var(--text);line-height:1.2}
.sb-logo-sub{font-size:10px;color:var(--text2);font-weight:400}

.sb-nav{flex:1;padding:12px 8px;overflow-y:auto;display:flex;flex-direction:column;gap:2px}
.sb-section{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;
  letter-spacing:.08em;padding:8px 8px 4px;margin-top:4px}
.nav-item{
  display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:var(--r8);
  cursor:pointer;transition:all .15s;color:var(--text2);font-size:13px;font-weight:500;
  border:none;background:none;width:100%;text-align:left;
}
.nav-item:hover{background:var(--surface2);color:var(--text)}
.nav-item.active{background:rgba(46,160,67,.15);color:var(--green);border:1px solid rgba(46,160,67,.2)}
.nav-icon{width:18px;text-align:center;font-size:14px;flex-shrink:0}
.nav-badge{
  margin-left:auto;background:var(--red);color:#fff;font-size:10px;font-weight:700;
  padding:1px 6px;border-radius:20px;min-width:18px;text-align:center;
}
.nav-badge.yellow{background:var(--yellow);color:#000}
.nav-badge.blue{background:var(--blue);color:#000}

.sb-footer{padding:12px 8px;border-top:1px solid var(--border2)}
.sb-date{font-size:11px;color:var(--text3);padding:0 4px}

/* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#main{flex:1;display:flex;flex-direction:column;overflow:hidden}

/* â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#topbar{
  height:52px;background:var(--surface);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 20px;gap:12px;flex-shrink:0;
}
.topbar-title{font-size:15px;font-weight:600;color:var(--text)}
.topbar-subtitle{font-size:12px;color:var(--text2)}
.topbar-sep{width:1px;height:20px;background:var(--border);margin:0 4px}
.topbar-actions{margin-left:auto;display:flex;gap:8px;align-items:center}

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{
  display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:var(--r8);
  font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all .15s;font-family:var(--font);
}
.btn-primary{background:var(--green);color:#fff}
.btn-primary:hover{background:#3fc050;transform:translateY(-1px)}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{background:var(--surface3);border-color:var(--text3)}
.btn-danger{background:rgba(255,123,114,.15);color:var(--red);border:1px solid rgba(255,123,114,.3)}
.btn-danger:hover{background:rgba(255,123,114,.25)}
.btn-sm{padding:4px 10px;font-size:12px}
.btn-icon{padding:6px;border-radius:var(--r8);background:var(--surface2);color:var(--text2);
  border:1px solid var(--border);cursor:pointer;font-size:14px;transition:all .15s;line-height:1}
.btn-icon:hover{color:var(--text);background:var(--surface3)}

/* â”€â”€ CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#content{flex:1;overflow-y:auto;padding:20px;overflow-anchor:none;
  /* FIX: -webkit-overflow-scrolling iOS momentum scroll iÃ§in */
  -webkit-overflow-scrolling:touch}
/* overflow-anchor kapalÄ±: scroll konumu koruma hesabÄ± yapma â†’ daha hÄ±zlÄ± scroll */
.page{display:none}
.page.active{display:block;animation:pageIn .15s ease}


/* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r12);
  padding:16px;
}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.card-title{font-size:13px;font-weight:600;color:var(--text2);text-transform:uppercase;
  letter-spacing:.06em}
.card-action{font-size:12px;color:var(--blue);cursor:pointer}
.card-action:hover{text-decoration:underline}

/* â”€â”€ KPI GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.kpi-card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r12);
  padding:16px 18px;position:relative;overflow:hidden;transition:border-color .2s, transform .15s;cursor:default;
}
.kpi-card:hover{border-color:var(--text3)}

.kpi-card[onclick]:hover{
  border-color:var(--text3);
  transform:translateY(-2px);
  box-shadow:var(--shadow2);
}

.kpi-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
}
.kpi-card.green::before{background:linear-gradient(90deg,var(--green),transparent)}
.kpi-card.blue::before{background:linear-gradient(90deg,var(--blue),transparent)}
.kpi-card.red::before{background:linear-gradient(90deg,var(--red),transparent)}
.kpi-card.orange::before{background:linear-gradient(90deg,var(--orange),transparent)}
.kpi-card.purple::before{background:linear-gradient(90deg,var(--purple),transparent)}
.kpi-card.yellow::before{background:linear-gradient(90deg,var(--yellow),transparent)}
.kpi-label{font-size:11px;color:var(--text2);font-weight:500;margin-bottom:8px;
  text-transform:uppercase;letter-spacing:.06em}
.kpi-value{font-size:26px;font-weight:700;color:var(--text);line-height:1;margin-bottom:4px;font-variant-numeric:tabular-nums}
.kpi-sub{font-size:11px;color:var(--text3)}
.kpi-icon{position:absolute;top:14px;right:14px;font-size:20px;opacity:.4}
.kpi-trend{font-size:11px;margin-top:6px}
.kpi-trend.up{color:var(--green)}
.kpi-trend.down{color:var(--red)}

/* â”€â”€ GRID LAYOUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px}
.grid-6040{display:grid;grid-template-columns:3fr 2fr;gap:16px;margin-bottom:16px}
.grid-4060{display:grid;grid-template-columns:2fr 3fr;gap:16px;margin-bottom:16px}

/* â”€â”€ TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tbl-wrap{overflow-x:auto;border-radius:var(--r8)}
table{width:100%;border-collapse:collapse;font-size:13px;table-layout:fixed}
thead th{
  background:var(--surface2);color:var(--text2);font-size:11px;font-weight:600;
  text-transform:uppercase;letter-spacing:.06em;padding:10px 12px;text-align:left;
  border-bottom:1px solid var(--border);white-space:nowrap;position:sticky;top:0;
}
tbody tr{border-bottom:1px solid var(--border2);transition:background .1s}
tbody tr:hover{background:var(--surface2)}
tbody td{padding:10px 12px;color:var(--text);vertical-align:middle}
tbody td.mono{font-family:var(--mono);font-size:12px}
.tbl-empty{text-align:center;padding:40px;color:var(--text3);font-size:13px}

/* â”€â”€ STATUS BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge{
  display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;
  font-size:11px;font-weight:600;white-space:nowrap;
}
.badge::before{content:'';width:6px;height:6px;border-radius:50%;flex-shrink:0}
.badge-green{background:rgba(63,185,80,.15);color:var(--green);border:1px solid rgba(63,185,80,.25)}
.badge-green::before{background:var(--green)}
.badge-yellow{background:rgba(227,179,65,.15);color:var(--yellow);border:1px solid rgba(227,179,65,.25)}
.badge-yellow::before{background:var(--yellow)}
.badge-blue{background:rgba(88,166,255,.15);color:var(--blue);border:1px solid rgba(88,166,255,.25)}
.badge-blue::before{background:var(--blue)}
.badge-red{background:rgba(255,123,114,.15);color:var(--red);border:1px solid rgba(255,123,114,.25)}
.badge-red::before{background:var(--red)}
.badge-gray{background:rgba(139,148,158,.15);color:var(--text2);border:1px solid rgba(139,148,158,.2)}
.badge-gray::before{background:var(--text2)}
.badge-orange{background:rgba(255,166,87,.15);color:var(--orange);border:1px solid rgba(255,166,87,.25)}
.badge-orange::before{background:var(--orange)}

/* â”€â”€ FORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.form-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.form-row{display:flex;flex-direction:column;gap:4px}
.form-label{font-size:11px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.06em}
.form-input,.form-select,.form-textarea{
  background:var(--surface2);border:1px solid var(--border);border-radius:var(--r8);
  color:var(--text);font-size:13px;padding:8px 12px;font-family:var(--font);
  width:100%;transition:border-color .15s,box-shadow .15s;outline:none;
}
.form-input:focus,.form-select:focus,.form-textarea:focus{
  border-color:var(--blue);box-shadow:0 0 0 3px rgba(88,166,255,.1)
}
.form-input::placeholder{color:var(--text3)}
.form-select option{background:var(--surface2)}
.form-textarea{resize:vertical;min-height:72px;line-height:1.5}
.form-required{color:var(--red);margin-left:2px}

/* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:1000;
  display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;
  transition:opacity .2s;backdrop-filter:blur(4px);
}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r16);
  width:90%;max-width:780px;max-height:90vh;overflow-y:auto;
  transform:translateY(8px) scale(.98);transition:transform .2s;box-shadow:var(--shadow2);
  /* FIX: iOS Safari'de -webkit-overflow-scrolling */
  -webkit-overflow-scrolling:touch;
}
/* FIX: Mobilde modal tam geniÅŸlik, kesilmesin */
@media(max-width:768px){
  .modal{width:96%;max-height:85vh;border-radius:var(--r12)}
  .modal-body{padding:16px}
  .modal-header{padding:14px 16px 12px}
  .modal-footer{padding:12px 16px}
  /* Form grid'leri mobilde tek kolona dÃ¼ÅŸÃ¼r */
  .form-grid,.form-grid-4{grid-template-columns:1fr 1fr !important}
  .form-grid-2{grid-template-columns:1fr !important}
}
.modal-overlay.open .modal{transform:translateY(0) scale(1)}
.modal-header{
  padding:20px 24px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;
  background:var(--surface);z-index:1;border-radius:var(--r16) var(--r16) 0 0;
}
.modal-title{font-size:16px;font-weight:700;color:var(--text)}
.modal-body{padding:24px}
.modal-footer{
  padding:16px 24px;border-top:1px solid var(--border);display:flex;
  justify-content:flex-end;gap:8px;background:var(--surface);
  position:sticky;bottom:0;border-radius:0 0 var(--r16) var(--r16);
}

/* â”€â”€ SEARCH & FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-bar{
  display:flex;align-items:center;gap:8px;background:var(--surface2);
  border:1px solid var(--border);border-radius:var(--r8);padding:6px 12px;
  flex:1;max-width:320px;
}
.search-bar input{background:none;border:none;color:var(--text);font-size:13px;
  outline:none;width:100%;font-family:var(--font)}
.search-bar input::placeholder{color:var(--text3)}

.filter-bar{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap}

/* â”€â”€ PAGE HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.page-title{font-size:20px;font-weight:700;color:var(--text)}
.page-sub{font-size:13px;color:var(--text2);margin-top:2px}

/* â”€â”€ PROGRESS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.progress{background:var(--surface2);border-radius:20px;height:6px;overflow:hidden}
.progress-fill{height:100%;border-radius:20px;transition:width .3s ease}

/* â”€â”€ ALERT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert{
  display:flex;align-items:flex-start;gap:10px;padding:12px 14px;
  border-radius:var(--r8);border:1px solid;margin-bottom:12px;
  font-size:13px;
}
.alert-red{background:rgba(255,123,114,.08);border-color:rgba(255,123,114,.25);color:var(--red)}
.alert-yellow{background:rgba(227,179,65,.08);border-color:rgba(227,179,65,.25);color:var(--yellow)}
.alert-green{background:rgba(63,185,80,.08);border-color:rgba(63,185,80,.25);color:var(--green)}
.alert-blue{background:rgba(88,166,255,.08);border-color:rgba(88,166,255,.25);color:var(--blue)}

/* â”€â”€ DASHBOARD WIDGET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.widget-toggle{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);cursor:pointer}
.widget-toggle input[type=checkbox]{accent-color:var(--blue);cursor:pointer}
.widget-grid{display:grid;gap:16px}

.odm-tab-btn{
  padding:6px 14px;border-radius:var(--r8);font-size:12px;font-weight:600;
  cursor:pointer;border:none;background:none;color:var(--text2);font-family:var(--font);
  transition:all .15s;
}
.odm-tab-btn.active{background:var(--surface3);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.3)}
.odm-tab-btn:hover:not(.active){color:var(--text)}

/* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text3)}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#toast-container{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r8);
  padding:12px 16px;font-size:13px;color:var(--text);box-shadow:var(--shadow2);
  animation:slideIn .2s ease;max-width:300px;display:flex;align-items:center;gap:8px;
}
.toast.success{border-color:rgba(63,185,80,.4);color:var(--green)}
.toast.error{border-color:rgba(255,123,114,.4);color:var(--red)}
.toast.warning{border-color:rgba(227,179,65,.4);color:var(--yellow)}
.toast.info{border-color:rgba(88,166,255,.4);color:var(--blue)}
.toast{transition:opacity .3s ease}

/* â”€â”€ FILE SYSTEM PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#fs-indicator{ transition: color .3s ease; }
#fs-connect-btn:hover, #fs-connect-btn:focus{
  border-color: var(--blue);
  color: var(--blue);
  outline: none;
}

/* â”€â”€ PWA STANDALONE MODU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* Uygulama olarak aÃ§Ä±ldÄ±ÄŸÄ±nda (adres Ã§ubuÄŸu yok) ekstra optimizasyon */
@media (display-mode: standalone) {
  /* Drag bÃ¶lgesi â€” standalone'da pencereyi sÃ¼rÃ¼klemek iÃ§in */
  #topbar {
    -webkit-app-region: drag;
    app-region: drag;
    padding-top: env(titlebar-area-height, 0);
  }
  /* Butonlar sÃ¼rÃ¼klemeyi engellemesin */
  #topbar button, #topbar select, #topbar input {
    -webkit-app-region: no-drag;
    app-region: no-drag;
  }
  /* PWA yÃ¼kleme butonu standalone'da gizle */
  #pwa-install-btn { display: none !important; }
  /* Safe area â€” notch olan ekranlar iÃ§in */
  #sidebar {
    padding-bottom: env(safe-area-inset-bottom, 0);
  }
  #main {
    padding-bottom: env(safe-area-inset-bottom, 0);
  }
}

/* Sayfa geÃ§iÅŸ animasyonu â€” daha akÄ±cÄ± */
@keyframes pageIn {
  from { opacity: 0; transform: translateY(4px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* â”€â”€ UTILITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.flex{display:flex}.items-center{align-items:center}.gap-8{gap:8px}.gap-12{gap:12px}
.ml-auto{margin-left:auto}.mb-16{margin-bottom:16px}.mt-8{margin-top:8px}
.text-sm{font-size:12px}.text-xs{font-size:11px}.text-muted{color:var(--text2)}
.text-red{color:var(--red)}.text-green{color:var(--green)}.text-blue{color:var(--blue)}
.text-orange{color:var(--orange)}.text-yellow{color:var(--yellow)}
.font-mono{font-family:var(--mono)}.font-bold{font-weight:700}.font-medium{font-weight:500}
.divider{height:1px;background:var(--border);margin:16px 0}
.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.w-full{width:100%}
.section-title{font-size:13px;font-weight:600;color:var(--text2);text-transform:uppercase;
  letter-spacing:.06em;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border2)}

/* â”€â”€ MOBÄ°L RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hamburger{
  display:none;background:none;border:1px solid var(--border);border-radius:var(--r8);
  padding:6px 8px;cursor:pointer;font-size:16px;color:var(--text2);line-height:1;
  flex-shrink:0;transition:all .15s;
}
.hamburger:hover{color:var(--text);border-color:var(--text3)}
#sidebar-overlay{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;
  backdrop-filter:blur(2px);
}
@media(max-width:768px){
  html,body{overflow:auto}
  #app{flex-direction:column;height:auto;min-height:100vh}
  #sidebar{
    position:fixed;top:0;left:0;height:100vh;z-index:200;
    transform:translateX(-100%);transition:transform .25s ease;
    box-shadow:4px 0 20px rgba(0,0,0,.5);
  }
  #sidebar.mobile-open{transform:translateX(0)}
  #sidebar-overlay.mobile-open{display:block}
  /* FIX: height:100vh kaldÄ±rÄ±ldÄ± â€” body overflow:auto ile Ã§akÄ±ÅŸÄ±yordu */
  #main{width:100%;height:auto;min-height:100vh;flex:1}
  #topbar{padding:0 12px;gap:8px}
  #content{padding:12px}
  .hamburger{display:flex;align-items:center;justify-content:center}
  .kpi-grid{grid-template-columns:1fr 1fr !important}
  .grid-2,.grid-3,.grid-6040,.grid-4060{grid-template-columns:1fr !important}
  .topbar-sep{display:none}
  .topbar-title{font-size:14px}
  .topbar-subtitle{display:none}
  /* #8 Cari mobile fix */
  #cari-layout{grid-template-columns:1fr !important}
  #cari-firma-panel{position:static !important; max-height:280px}
  #cari-firma-list{max-height:220px !important}
  /* FIX: backdrop-filter mobilde kapat â€” dÃ¼ÅŸÃ¼k RAM'li cihazlarda render bozulmasÄ± */
  .modal-overlay{backdrop-filter:none}
  #sidebar-overlay{backdrop-filter:none}
  /* FIX: Cari menÃ¼ butonlarÄ± mobilde her zaman gÃ¶rÃ¼nÃ¼r â€” hover touch'ta Ã§alÄ±ÅŸmaz */
  .cari-item-menu-btn{opacity:1 !important}
  /* FIX: table-layout:fixed mobilde kolonlarÄ± Ã§ok sÄ±kÄ±ÅŸtÄ±rÄ±yordu */
  table{table-layout:auto}
}
/* #10 CSS hover sÄ±nÄ±flarÄ± â€” inline onmouseover yerine */
.hover-bg:hover{background:var(--surface2) !important}
.hover-border-blue:hover{border-color:var(--blue) !important}
.cari-firma-item{transition:background .12s, border-color .12s}
.cari-firma-item:hover{background:var(--surface2)}
.cari-hareket-row{transition:background .1s}
.cari-hareket-row:hover{background:var(--surface2)}
/* Cari dropdown menu */
.cari-item-menu{position:relative;display:inline-block}
.cari-item-menu-btn{
  opacity:0;background:var(--surface2);border:1px solid var(--border);border-radius:6px;
  padding:2px 6px;cursor:pointer;font-size:11px;color:var(--text2);transition:opacity .15s;
  line-height:1.4;
}
.cari-firma-item:hover .cari-item-menu-btn{opacity:1}
.cari-item-menu-btn:hover{background:var(--surface3);color:var(--text)}
.cari-item-dropdown{
  position:absolute;right:0;top:calc(100% + 4px);z-index:200;
  background:var(--surface);border:1px solid var(--border);border-radius:var(--r8);
  box-shadow:var(--shadow2);min-width:150px;overflow:hidden;display:none;
}
.cari-item-dropdown.open{display:block}
.cari-item-dropdown button{
  display:flex;align-items:center;gap:8px;width:100%;padding:8px 12px;
  background:none;border:none;color:var(--text);font-size:12px;font-family:var(--font);
  cursor:pointer;text-align:left;transition:background .1s;
}
.cari-item-dropdown button:hover{background:var(--surface2)}
.cari-item-dropdown button.danger{color:var(--red)}
.vrm-yontem-lbl{display:flex;align-items:center;gap:6px;padding:8px 10px;border-radius:var(--r8);border:2px solid var(--border);cursor:pointer;font-size:12px;font-weight:600;transition:all .15s}
.vrm-yontem-lbl:has(input:checked){border-color:var(--purple);background:rgba(188,140,255,.12);color:var(--purple)}
.cari-item-dropdown .menu-sep{height:1px;background:var(--border);margin:4px 0}
/* ArÅŸiv badge */
.badge-arsiv{
  font-size:10px;background:rgba(227,179,65,.15);color:var(--yellow);
  border:1px solid rgba(227,179,65,.3);padding:1px 6px;border-radius:4px;
}
.firma-arsivlendi{opacity:0.55}
.firma-arsivlendi .cari-item-menu-btn{opacity:0.7!important}
.musteri-secim-item:hover{background:var(--surface2)}
</style>
</head>
<body>

<!-- â”€â”€ GÄ°RÄ°Å EKRANI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login-screen" class="hidden">
  <div class="login-box">
    <div class="login-logo">ğŸ”§</div>
    <div class="login-title">Royal Muhasebe</div>
    <div class="login-sub">Devam etmek iÃ§in GitHub hesabÄ±nÄ±zla giriÅŸ yapÄ±n</div>
    <button class="login-btn" onclick="githubLogin()">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/>
      </svg>
      GitHub ile GiriÅŸ Yap
    </button>
    <div class="login-error" id="login-error">GiriÅŸ baÅŸarÄ±sÄ±z. LÃ¼tfen tekrar deneyin.</div>
    <div class="login-loading" id="login-loading">â³ GiriÅŸ yapÄ±lÄ±yor...</div>
  </div>
</div>

<div id="sidebar-overlay" onclick="toggleSidebar()"></div>
<div id="app" style="display:none">
  <!-- SIDEBAR -->
  <nav id="sidebar">
    <div class="sb-logo">
      <div class="sb-logo-icon">ğŸ‘‘</div>
      <div>
        <div class="sb-logo-text">Royal</div>
        <div class="sb-logo-sub">Muhasebe & Ä°ÅŸ Takip</div>
      </div>
    </div>
    <div class="sb-nav">
      <div class="sb-section">Ana</div>
      <button class="nav-item active" onclick="navigate('dashboard')">
        <span class="nav-icon">ğŸ“Š</span> Dashboard
      </button>
      <div class="sb-section">KayÄ±tlar</div>
      <button class="nav-item" onclick="navigate('tadilatlar')">
        <span class="nav-icon">ğŸ”§</span> Ä°ÅŸ Emirleri
      </button>
      <button class="nav-item" onclick="navigate('tadilatlar-arsiv')">
        <span class="nav-icon">ğŸ—„</span> Ä°ÅŸ Emri ArÅŸivi
      </button>
      <button class="nav-item" onclick="navigate('odemeler')">
        <span class="nav-icon">ğŸ’³</span> MÃ¼ÅŸteri Ã–demeleri
      </button>
      <button class="nav-item" onclick="navigate('odemeler-arsiv')">
        <span class="nav-icon">ğŸ—„</span> Ã–deme ArÅŸivi
      </button>
      <button class="nav-item" onclick="navigate('ustalar')">
        <span class="nav-icon">ğŸ‘·</span> Usta Ã–demeleri
      </button>
      <button class="nav-item" onclick="navigate('ustalar-arsiv')">
        <span class="nav-icon">ğŸ—„</span> Usta Ã–deme ArÅŸivi
      </button>
      <button class="nav-item" onclick="navigate('personel')">
        <span class="nav-icon">ğŸ‘¥</span> Personel
      </button>
      <div class="sb-section">Analiz</div>
      <button class="nav-item" onclick="navigate('aylik')">
        <span class="nav-icon">ğŸ“…</span> AylÄ±k Ã–zet
      </button>
      <button class="nav-item" onclick="navigate('vade')">
        <span class="nav-icon">â°</span> Vade Takibi
        <span class="nav-badge red" id="badge-vade">0</span>
      </button>
      <button class="nav-item" onclick="navigate('musteri-karti')">
        <span class="nav-icon">ğŸ”</span> MÃ¼ÅŸteri KartÄ±
      </button>
      <button class="nav-item" onclick="navigate('usta-programi')">
        <span class="nav-icon">ğŸ“†</span> Usta ProgramÄ±
      </button>
      <button class="nav-item" onclick="navigate('hesap-defteri')">
        <span class="nav-icon">ğŸ“’</span> Hesap Defteri
      </button>
      <button class="nav-item" onclick="navigate('cari')">
        <span class="nav-icon">ğŸ¢</span> Cari Hesaplar
        <span class="nav-badge blue" id="badge-cari" style="display:none">0</span>
      </button>
      <div class="sb-section">Ayarlar</div>
      <button class="nav-item" onclick="navigate('fiyat-listesi')">
        <span class="nav-icon">ğŸ“‹</span> Fiyat Listesi
      </button>
      <button class="nav-item" onclick="navigate('tanimlar')">
        <span class="nav-icon">âš™ï¸</span> TanÄ±mlar
      </button>
      <div style="margin-top:auto;padding:8px">
        <div id="yedek-gosterge" style="font-size:10px;text-align:center;padding:4px;color:var(--text3);margin-bottom:4px"></div>
        
        <!-- PWA KURULUM BUTONU â€” sadece tarayÄ±cÄ±da gÃ¶rÃ¼nÃ¼r, uygulamaya yÃ¼kleyince kaybolur -->
        <button id="pwa-install-btn" onclick="pwaInstall()" style="display:none;width:100%;
          padding:8px 10px;background:linear-gradient(135deg,#1f6feb,#388bfd);
          border:none;border-radius:var(--r8);color:#fff;font-size:11px;font-weight:600;
          cursor:pointer;font-family:var(--font);align-items:center;justify-content:center;
          gap:6px;margin-bottom:8px;box-shadow:0 2px 8px rgba(88,166,255,0.3)">
          â¬‡ UygulamayÄ± MasaÃ¼stÃ¼ne YÃ¼kle
        </button>

        <!-- FILE SYSTEM BAÄLANTI PANELI -->
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--r8);padding:10px;margin-bottom:8px">
          <div id="fs-indicator" style="font-size:10px;text-align:center;margin-bottom:8px;line-height:1.4;color:var(--text3)">Kontrol ediliyor...</div>
          <div style="display:flex;gap:4px">
            <button id="fs-connect-btn" onclick="fsConnect()" 
              style="flex:1;padding:6px 4px;background:var(--surface3);border:1px solid var(--border);
              border-radius:var(--r8);color:var(--text);font-size:10px;cursor:pointer;font-family:var(--font)"
              title="Var olan .json dosyasÄ±nÄ± aÃ§">
              ğŸ“‚ Dosya SeÃ§
            </button>
            <button onclick="fsCreate()"
              style="flex:1;padding:6px 4px;background:var(--surface3);border:1px solid var(--border);
              border-radius:var(--r8);color:var(--text);font-size:10px;cursor:pointer;font-family:var(--font)"
              title="Yeni .json dosyasÄ± oluÅŸtur">
              âœ¨ Yeni Dosya
            </button>
          </div>
          <div style="font-size:9px;color:var(--text3);text-align:center;margin-top:6px">
            <span id="storage-size-indicator">â€”</span>
          </div>
        </div>

        <button onclick="openModal('modal-hakkinda')" style="width:100%;padding:8px;background:none;
          border:1px solid var(--border);border-radius:var(--r8);color:var(--text2);
          font-size:11px;cursor:pointer;font-family:var(--font);transition:all .15s"
          class="hover-border-blue">
          ğŸ‘‘ Royal v30 â€” HakkÄ±nda
        </button>
      </div>
    </div>
    <div class="sb-footer">
      <div class="sb-date" id="sb-date"></div>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn btn-secondary btn-sm" onclick="exportData()" style="flex:1">â¬‡ DÄ±ÅŸa Aktar</button>
        <button class="btn btn-secondary btn-sm" onclick="importData()" style="flex:1">â¬† Ä°Ã§e Aktar</button>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <div id="main">
    <!-- TOPBAR -->
    <div id="topbar">
      <button class="hamburger" onclick="toggleSidebar()" title="MenÃ¼">â˜°</button>
      <div>
        <div class="topbar-title" id="topbar-title">Dashboard</div>
        <div class="topbar-subtitle" id="topbar-sub">Genel bakÄ±ÅŸ ve Ã¶zet</div>
      </div>
      <div class="topbar-sep"></div>
      <button class="theme-toggle" id="theme-toggle-btn" onclick="toggleTheme()" title="GÃ¼ndÃ¼z / Gece modu">
        <span id="theme-icon">â˜€ï¸</span>
        <span id="theme-label">GÃ¼ndÃ¼z</span>
      </button>
      <span style="font-size:11px;color:var(--text3);padding:0 4px" title="Ctrl+N: Yeni kayÄ±t | Escape: Kapat">âŒ¨ Ctrl+N</span>
      <div class="topbar-actions" id="topbar-actions"></div>
    </div>

    <!-- CONTENT -->
    <div id="content">

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page active" id="page-dashboard">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
          <div>
            <div style="font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">HOÅ GELDÄ°NÄ°Z</div>
            <div style="font-size:22px;font-weight:700;color:var(--text)" id="db-greeting"></div>
          </div>
          <button class="btn btn-secondary" onclick="openWidgetSettings()">âš™ Widget AyarlarÄ±</button>
        </div>

        
        <div class="kpi-grid" id="kpi-grid"></div>

        
        <div id="widget-area"></div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TADÄ°LATLAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-tadilatlar">
        <div class="page-header">
          <div>
            <div class="page-title">Ä°ÅŸ Emirleri</div>
            <div class="page-sub" id="tad-count-sub">â€” kayÄ±t</div>
          </div>
          <div class="flex gap-8">
            <button class="btn btn-secondary" onclick="openTadExportModal()" style="display:flex;align-items:center;gap:6px"><span>ğŸ“¥</span> Excel'e Aktar</button>
            <button class="btn btn-primary" onclick="openModal('modal-tad')">+ Yeni Ä°ÅŸ KaydÄ±</button>
          </div>
        </div>
        <div class="filter-bar">
          <div class="search-bar">
            <span>ğŸ”</span>
            <input type="text" placeholder="MÃ¼ÅŸteri, adres, usta ara..." id="tad-search" oninput="dRenderTadilatlar()">
          </div>
          <select class="form-select" style="width:auto" id="tad-filter-durum" onchange="renderTadilatlar()">
            <option value="">TÃ¼m Durumlar</option>
            <option>TamamlandÄ±</option><option>Devam Ediyor</option>
            <option>Beklemede</option><option>Ä°ptal</option>
          </select>
          <select class="form-select" style="width:auto" id="tad-filter-usta" onchange="renderTadilatlar()">
            <option value="">TÃ¼m Ustalar</option>
          </select>
        </div>
        <div class="card" style="padding:0">
          <div class="tbl-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Tarih</th><th>MÃ¼ÅŸteri</th><th>Adres</th>
                  <th>Usta / YapÄ±lan Ä°ÅŸler</th><th>Kombi</th><th>Ã–deme</th><th>Durum</th><th>Ä°ÅŸlem</th>
                </tr>
              </thead>
              <tbody id="tad-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MÃœÅTERÄ° Ã–DEMELERÄ° â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-odemeler">
        <div class="page-header">
          <div>
            <div class="page-title">MÃ¼ÅŸteri Ã–demeleri</div>
            <div class="page-sub" id="odm-count-sub">â€” kayÄ±t</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary" onclick="openOdmExportModal()" style="display:flex;align-items:center;gap:6px"><span>ğŸ“¥</span> Excel'e Aktar</button>
            <button class="btn btn-primary" onclick="openModal('modal-odm')">+ Yeni Ã–deme</button>
          </div>
        </div>
        <div class="filter-bar">
          <div class="search-bar">
            <span>ğŸ”</span>
            <input type="text" placeholder="MÃ¼ÅŸteri, iÅŸ no ara..." id="odm-search" oninput="dRenderOdemeler()">
          </div>
          <select class="form-select" style="width:auto" id="odm-filter" onchange="renderOdemeler()">
            <option value="">TÃ¼m Durumlar</option>
            <option>Ã–dendi</option><option>Ã–denmedi</option><option>KÄ±smi Ã–deme</option>
          </select>
        </div>

        
        <div class="grid-3 mb-16" id="odm-summary"></div>

        <div class="card" style="padding:0">
          <div class="tbl-wrap">
            <table>
              <thead>
                <tr>
                  <th>Ä°ÅŸ No</th><th>MÃ¼ÅŸteri</th><th>Fatura</th><th>ğŸ’µ Nakit</th>
                  <th>ğŸ’³ Kart</th><th>Taksit</th><th>ğŸ¦ Havale</th><th>ğŸ“„ Ã‡ek</th>
                  <th>ğŸ“… Vadeli</th><th>Kalan</th><th>Vade</th><th>Durum</th><th>Ä°ÅŸlem</th>
                </tr>
              </thead>
              <tbody id="odm-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• USTA Ã–DEMELERÄ° â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-ustalar">
        <div class="page-header">
          <div class="page-title">Usta Ã–demeleri</div>
          <button class="btn btn-secondary" onclick="openUstaExportModal()" style="display:flex;align-items:center;gap:6px">
            <span>ğŸ“¥</span> Excel'e Aktar
          </button>
        </div>
        
        <div id="usta-kpi" class="kpi-grid" style="margin-bottom:20px"></div>
        
        <div style="display:flex;gap:4px;margin-bottom:16px;flex-wrap:wrap" id="usta-tabs"></div>
        
        <div id="usta-detay"></div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PERSONEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-personel">
        <div class="page-header">
          <div>
            <div class="page-title">ğŸ‘¥ Personel</div>
            <div class="page-sub" id="personel-sub">MaaÅŸ, masraf ve Ã¶demeler</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary" onclick="openPersonelExportModal()" style="display:flex;align-items:center;gap:6px">
              <span>ğŸ“¥</span> Excel'e Aktar
            </button>
            <button class="btn btn-primary" onclick="openPersonelModal()">+ Personel Ekle</button>
          </div>
        </div>

        <!-- KPI -->
        <div id="personel-kpi" class="kpi-grid" style="margin-bottom:20px"></div>

        <!-- Layout: sol liste, saÄŸ detay -->
        <div id="personel-layout" style="display:grid;grid-template-columns:260px 1fr;gap:16px;align-items:start">

          <!-- Sol: Personel Listesi -->
          <div class="card" style="padding:0;position:sticky;top:16px">
            <div style="padding:12px 16px;border-bottom:1px solid var(--border2);display:flex;align-items:center;justify-content:space-between">
              <div style="font-weight:700;font-size:13px">Ã‡alÄ±ÅŸanlar</div>
              <span class="text-xs text-muted" id="personel-count"></span>
            </div>
            <div style="padding:8px">
              <div class="search-bar" style="margin-bottom:8px">
                <span>ğŸ”</span>
                <input type="text" placeholder="Ã‡alÄ±ÅŸan ara..." id="personel-search" oninput="renderPersonelListe()" style="font-size:12px">
              </div>
              <label style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text3);cursor:pointer;padding:0 4px 4px">
                <input type="checkbox" id="personel-pasif-toggle" onchange="renderPersonelListe()" style="accent-color:var(--yellow)">
                ğŸ‘¤ Pasif Ã§alÄ±ÅŸanlarÄ± gÃ¶ster
              </label>
            </div>
            <div id="personel-liste" style="max-height:600px;overflow-y:auto;padding:0 8px 8px"></div>
          </div>

          <!-- SaÄŸ: Detay -->
          <div id="personel-detay">
            <div class="card" style="text-align:center;padding:48px 24px;color:var(--text3)">
              <div style="font-size:48px;margin-bottom:12px">ğŸ‘¥</div>
              <div style="font-size:15px;font-weight:600">Sol listeden Ã§alÄ±ÅŸan seÃ§in</div>
              <div style="font-size:13px;margin-top:6px">veya yeni personel ekleyerek baÅŸlayÄ±n</div>
            </div>
          </div>

        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CARÄ° HESAPLAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-cari">
        <div class="page-header">
          <div>
            <div class="page-title">ğŸ¢ Cari Hesaplar</div>
            <div class="page-sub" id="cari-sub">Firma bazlÄ± hesap takibi</div>
          </div>
          <button class="btn btn-primary" onclick="openCariFirmaModal()">+ Firma Ekle</button>
        </div>

        <!-- KPI -->
        <div id="cari-kpi" class="kpi-grid" style="margin-bottom:20px"></div>

        <!-- Ä°ki kolon: sol firma listesi, saÄŸ detay -->
        <div id="cari-layout" style="display:grid;grid-template-columns:280px 1fr;gap:16px;align-items:start">

          <!-- Sol: Firma Listesi -->
          <div id="cari-firma-panel" class="card" style="padding:0;position:sticky;top:16px">
            <div style="padding:12px 16px;border-bottom:1px solid var(--border2);display:flex;align-items:center;justify-content:space-between">
              <div style="font-weight:700;font-size:13px">Firmalar</div>
              <span class="text-xs text-muted" id="cari-firma-count"></span>
            </div>
            <div style="padding:8px">
              <div class="search-bar" style="margin-bottom:8px">
                <span>ğŸ”</span>
                <input type="text" placeholder="Firma ara..." id="cari-search" oninput="renderCari()" style="font-size:12px">
              </div>
              <label style="display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text3);cursor:pointer;padding:0 4px 4px">
                <input type="checkbox" id="cari-arsiv-toggle" onchange="renderCari()" style="accent-color:var(--yellow)">
                ğŸ“¦ ArÅŸivlenmiÅŸ firmalarÄ± gÃ¶ster
              </label>
            </div>
            <div id="cari-firma-list" style="max-height:600px;overflow-y:auto;padding:0 8px 8px"></div>
          </div>

          <!-- SaÄŸ: Firma DetayÄ± -->
          <div id="cari-detay">
            <div class="card" style="text-align:center;padding:48px 24px;color:var(--text3)">
              <div style="font-size:48px;margin-bottom:12px">ğŸ¢</div>
              <div style="font-size:15px;font-weight:600">Sol listeden bir firma seÃ§in</div>
              <div style="font-size:13px;margin-top:6px">veya yeni firma ekleyerek baÅŸlayÄ±n</div>
            </div>
          </div>

        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HESAP DEFTERÄ° â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-hesap-defteri">
        <div class="page-header">
          <div>
            <div class="page-title">Hesap Defteri</div>
            <div class="page-sub" id="hd-sub">Gelir & gider takibi</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary" onclick="openHdExportModal()" style="display:flex;align-items:center;gap:6px">
              <span>ğŸ“¥</span> Excel'e Aktar
            </button>
            <button class="btn btn-primary" onclick="openModal('modal-hd')">+ Manuel KayÄ±t</button>
          </div>
        </div>
        
        <div id="hd-kpi" class="kpi-grid" style="margin-bottom:20px"></div>
        
        <div class="filter-bar">
          <div class="search-bar">
            <span>ğŸ”</span>
            <input type="text" placeholder="Ara..." id="hd-search" oninput="dRenderHesapDefteri()">
          </div>
          <select class="form-select" style="width:auto" id="hd-filter-tip" onchange="renderHesapDefteri()">
            <option value="">TÃ¼mÃ¼</option>
            <option value="gelir">Gelirler</option>
            <option value="gider">Giderler</option>
          </select>
          <select class="form-select" style="width:auto" id="hd-filter-ay" onchange="renderHesapDefteri()">
            <option value="">TÃ¼m Aylar</option>
          </select>
        </div>
        <div class="grid-6040" style="margin-bottom:16px">
          <div class="card" style="padding:0">
            <div class="tbl-wrap">
              <table>
                <thead>
                  <tr><th>Tarih</th><th>TÃ¼r</th><th>Kategori</th><th>AÃ§Ä±klama</th><th>Tutar</th><th>Ä°ÅŸlem</th></tr>
                </thead>
                <tbody id="hd-tbody"></tbody>
              </table>
            </div>
          </div>
          <div>
            <div class="card" style="margin-bottom:12px">
              <div class="card-header"><div class="card-title">Kategori DaÄŸÄ±lÄ±mÄ±</div></div>
              <canvas id="chart-hd-kategori" height="220"></canvas>
            </div>
            <div class="card">
              <div class="card-header">
                <div class="card-title">AylÄ±k Gelir/Gider</div>
                <select class="form-select" id="hd-chart-yil" onchange="renderHesapDefteri()" style="width:auto;padding:4px 8px;font-size:12px"></select>
              </div>
              <canvas id="chart-hd-aylik" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AYLIK Ã–ZET â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-aylik">
        <div class="page-header">
          <div class="page-title">AylÄ±k Ã–zet</div>
          <div class="flex gap-8" style="align-items:center">
            <select class="form-select" id="aylik-yil-sec" style="width:140px"
              onchange="renderAylik()">
              <option value="">YÄ±l SeÃ§</option>
            </select>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text2);cursor:pointer">
              <input type="checkbox" id="aylik-show-arsiv" onchange="renderAylik()"> ArÅŸivleri dahil et
            </label>
          </div>
        </div>
        <div class="grid-6040">
          <div class="card" style="padding:0">
            <div class="tbl-wrap">
              <table>
                <thead>
                  <tr><th>Ay</th><th>Ä°ÅŸ</th><th>Tam.</th><th>Devam</th><th>Bekl.</th><th>Fatura</th><th title="Ä°ÅŸ aÃ§Ä±lÄ±ÅŸ tarihine gÃ¶re gruplandÄ±rÄ±lÄ±r">Tahsilat â“˜</th><th>Kalan</th><th>%</th></tr>
                </thead>
                <tbody id="aylik-tbody"></tbody>
              </table>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">AylÄ±k Trend</div></div>
            <canvas id="chart-aylik" height="300"></canvas>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VADE TAKÄ°BÄ° â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-vade">
        <div class="page-header">
          <div class="page-title">Vade Takibi</div>
          <div class="page-sub">BugÃ¼n: <span id="vade-bugun"></span></div>
        </div>
        <div id="vade-sections"></div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MÃœÅTERÄ° KARTI â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-musteri-karti">
        <div class="page-header">
          <div class="page-title">MÃ¼ÅŸteri KartÄ±</div>
        </div>
        <div class="card" style="margin-bottom:16px">
          <div style="display:flex;gap:12px;align-items:center">
            <div class="search-bar" style="flex:1">
              <span style="font-size:18px">ğŸ”</span>
              <input type="text" placeholder="MÃ¼ÅŸteri adÄ± veya Ä°ÅŸ No ile arayÄ±n..." id="mk-search"
                oninput="dRenderMusteriKarti()" style="font-size:15px">
            </div>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text2);cursor:pointer;white-space:nowrap">
              <input type="checkbox" id="mk-show-arsiv" onchange="renderMusteriKarti()"> ArÅŸivleri gÃ¶ster
            </label>
          </div>
        </div>
        <div id="mk-result"></div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• USTA PROGRAMI â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-usta-programi">
        <div class="page-header">
          <div>
            <div class="page-title">Usta ProgramÄ±</div>
            <div class="page-sub" id="up-hafta-label"></div>
          </div>
          <div class="flex gap-8">
            <button class="btn btn-secondary" onclick="haftaDegistir(-1)">â† Ã–nceki Hafta</button>
            <button class="btn btn-secondary" onclick="haftaDegistir(0)">Bu Hafta</button>
            <button class="btn btn-secondary" onclick="haftaDegistir(1)">Sonraki Hafta â†’</button>
            <label style="display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text2);cursor:pointer;margin-left:8px">
              <input type="checkbox" id="prog-show-arsiv" onchange="renderUstaProgrami()"> ArÅŸivleri gÃ¶ster
            </label>
          </div>
        </div>
        <div id="up-content"></div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FÄ°YAT LÄ°STESÄ° â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-fiyat-listesi">
        <div class="page-header">
          <div class="page-title">Usta Fiyat Listesi</div>
          <div style="display:flex;align-items:center;gap:12px">
            <span id="fiyat-kayit-ind" style="font-size:12px;color:var(--green);opacity:0;transition:opacity .3s"></span>
            <button class="btn btn-primary" onclick="saveFiyat()">ğŸ’¾ Kaydet</button>
          </div>
        </div>
        <div class="card" style="padding:0">
          <div class="tbl-wrap">
            <table id="fiyat-tablo">
              <thead id="fiyat-thead"></thead>
              <tbody id="fiyat-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TANIMLAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-tanimlar">
        <div class="page-header">
          <div class="page-title">TanÄ±mlar</div>
          <button class="btn btn-primary" onclick="saveTanimlar()">ğŸ’¾ Kaydet</button>
        </div>
        <div class="grid-3">
          <div class="card">
            <div class="section-title">Ustalar</div>
            <textarea class="form-textarea" id="tanim-ustalar" style="min-height:260px"></textarea>
            <div class="text-xs text-muted mt-8">Her satÄ±ra bir usta adÄ± yazÄ±n</div>
          </div>
          <div class="card">
            <div class="section-title">Ä°ÅŸ Tipleri</div>
            <textarea class="form-textarea" id="tanim-is" style="min-height:260px"></textarea>
            <div class="text-xs text-muted mt-8">Her satÄ±ra bir iÅŸ tipi yazÄ±n</div>
          </div>
          <div class="card">
            <div class="section-title">Kombi MarkalarÄ± & Modelleri</div>
            <div id="marka-editor"></div>
            <button class="btn btn-secondary btn-sm mt-8" onclick="addMarka()">+ Marka Ekle</button>
          </div>
          <div class="card">
            <div class="section-title">Gider Kategorileri</div>
            <textarea class="form-textarea" id="tanim-gider-kat" style="min-height:200px"></textarea>
            <div class="text-xs text-muted mt-8">Her satÄ±ra bir kategori yazÄ±n</div>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• USTA Ã–DEME ARÅÄ°VÄ° â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-ustalar-arsiv">
        <div class="page-header">
          <div class="page-title">ğŸ—„ Usta Ã–deme ArÅŸivi</div>
        </div>
        <div class="card mb-16">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <select class="form-select" id="ustalar-arsiv-sec" onchange="renderUstalarArsiv()" style="max-width:200px">
              <option value="">TÃ¼m Ustalar</option>
            </select>
            <input type="text" class="form-input" id="ustalar-arsiv-search" placeholder="AÃ§Ä±klama ara..."
              oninput="dRenderUstalarArsiv()" style="max-width:220px">
            <span class="text-sm text-muted" id="ustalar-arsiv-count"></span>
          </div>
        </div>
        <div class="card" style="padding:0">
          <div class="tbl-wrap">
            <table>
              <thead>
                <tr>
                  <th>Usta</th><th>Tarih</th><th>AÃ§Ä±klama</th><th>TÃ¼r</th><th>Tutar</th><th>Ä°ÅŸlem</th>
                </tr>
              </thead>
              <tbody id="ustalar-arsiv-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ä°Å EMRÄ° ARÅÄ°VÄ° â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-tadilatlar-arsiv">
        <div class="page-header">
          <div class="page-title">ğŸ—„ Ä°ÅŸ Emri ArÅŸivi</div>
        </div>
        <div class="card mb-16">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input type="text" class="form-input" id="tad-arsiv-search" placeholder="MÃ¼ÅŸteri, adres ara..."
              oninput="dRenderTadilatlarArsiv()" style="max-width:260px">
            <span class="text-sm text-muted" id="tad-arsiv-count"></span>
          </div>
        </div>
        <div class="card" style="padding:0">
          <div class="tbl-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Tarih</th><th>MÃ¼ÅŸteri</th><th>Adres</th>
                  <th>Usta</th><th>Kombi</th><th>Durum</th><th>Ä°ÅŸlem</th>
                </tr>
              </thead>
              <tbody id="tad-arsiv-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• Ã–DEME ARÅÄ°VÄ° â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="page" id="page-odemeler-arsiv">
        <div class="page-header">
          <div class="page-title">ğŸ—„ Ã–deme ArÅŸivi</div>
        </div>
        <div class="card mb-16">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input type="text" class="form-input" id="odm-arsiv-search" placeholder="MÃ¼ÅŸteri, iÅŸ no ara..."
              oninput="dRenderOdemelerArsiv()" style="max-width:260px">
            <span class="text-sm text-muted" id="odm-arsiv-count"></span>
          </div>
        </div>
        <div class="card" style="padding:0">
          <div class="tbl-wrap">
            <table>
              <thead>
                <tr>
                  <th>Ä°ÅŸ No</th><th>MÃ¼ÅŸteri</th><th>Fatura</th><th>Tahsilat</th>
                  <th>Kalan</th><th>Durum</th><th>Tarih</th><th>Ä°ÅŸlem</th>
                </tr>
              </thead>
              <tbody id="odm-arsiv-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /main -->
</div><!-- /app -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALLER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<div class="modal-overlay" id="modal-tad">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-tad-title">Yeni Ä°ÅŸ KaydÄ±</div>
      <button class="btn-icon" onclick="closeModal('modal-tad')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid" style="margin-bottom:12px">
        <div class="form-row">
          <label class="form-label">KayÄ±t Tarihi <span class="form-required">*</span></label>
          <input type="date" class="form-input" id="f-tad-tarih">
        </div>
        <div class="form-row" style="position:relative">
          <label class="form-label">MÃ¼ÅŸteri AdÄ± SoyadÄ± <span class="form-required">*</span></label>
          <input type="text" class="form-input" id="f-tad-musteri" placeholder="Ad Soyad"
            oninput="dMusteriAutocomplete(this)" autocomplete="off">
          <div id="musteri-suggestions" style="position:absolute;z-index:200;background:var(--surface);
            border:1px solid var(--border);border-radius:var(--r8);width:100%;max-height:160px;
            overflow-y:auto;display:none;box-shadow:var(--shadow2)"></div>
        </div>
        <div class="form-row">
          <label class="form-label">Telefon</label>
          <input type="text" class="form-input" id="f-tad-tel" placeholder="05xx xxx xx xx">
        </div>
      </div>
      <div class="form-grid" style="margin-bottom:12px">
        <div class="form-row">
          <label class="form-label">ğŸ—“ Ä°ÅŸ BaÅŸlama Tarihi</label>
          <input type="date" class="form-input" id="f-tad-baslama">
        </div>
        <div class="form-row">
          <label class="form-label">ğŸ Tahmini BitiÅŸ Tarihi</label>
          <input type="date" class="form-input" id="f-tad-bitis">
        </div>
        <div class="form-row">
          <label class="form-label">Adres</label>
          <input type="text" class="form-input" id="f-tad-adres" placeholder="Mahalle, sokak, no">
        </div>
      </div>
      <div class="form-grid" style="margin-bottom:12px">
        <div class="form-row">
          <label class="form-label">Kombi MarkasÄ±</label>
          <select class="form-select" id="f-tad-marka" onchange="updateModelSelect()"></select>
        </div>
        <div class="form-row">
          <label class="form-label">Kombi Modeli</label>
          <select class="form-select" id="f-tad-model"></select>
        </div>
        <div class="form-row">
          <label class="form-label">Genel Durum</label>
          <select class="form-select" id="f-tad-durum">
            <option>Devam Ediyor</option><option>TamamlandÄ±</option>
            <option>Beklemede</option><option>Ä°ptal</option>
          </select>
        </div>
      </div>

      
      <div style="margin-bottom:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <label class="form-label" style="margin:0">Usta & YapÄ±lan Ä°ÅŸler <span class="form-required">*</span></label>
          <button class="btn btn-secondary btn-sm" type="button" onclick="addUstaRow()">+ Usta / Ä°ÅŸ Ekle</button>
        </div>
        <div id="usta-rows-container" style="display:flex;flex-direction:column;gap:8px"></div>
      </div>

      <div class="form-grid-2" style="margin-bottom:12px">
        <div class="form-row">
          <label class="form-label">Seri No</label>
          <input type="text" class="form-input" id="f-tad-seri">
        </div>
        <div class="form-row">
          <label class="form-label">Eksikler / YapÄ±lacaklar</label>
          <input type="text" class="form-input" id="f-tad-eksik">
        </div>
      </div>
      <div class="form-row" style="margin-bottom:10px">
        <label class="form-label">ğŸ“ YapÄ±lan Ä°ÅŸler / AÃ§Ä±klama</label>
        <textarea class="form-textarea" id="f-tad-aciklama" placeholder="YapÄ±lan iÅŸlerin detayÄ±, deÄŸiÅŸtirilen parÃ§alar, mÃ¼ÅŸteriye bilgi verildi mi..." style="min-height:72px"></textarea>
      </div>
      <div class="form-row">
        <label class="form-label">ğŸ—’ Ä°Ã§ Notlar</label>
        <textarea class="form-textarea" id="f-tad-not" style="min-height:48px" placeholder="Takip notu, hatÄ±rlatma..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-tad')">Ä°ptal</button>
      <button class="btn btn-primary" onclick="saveTadilat()">ğŸ’¾ Kaydet</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-odm">
  <div class="modal" style="max-width:860px">
    <div class="modal-header">
      <div class="modal-title" id="modal-odm-title">Yeni Ã–deme KaydÄ±</div>
      <button class="btn-icon" onclick="closeModal('modal-odm')">âœ•</button>
    </div>
    <div class="modal-body">

      
      <div class="form-grid" style="margin-bottom:16px">
        <div class="form-row" style="position:relative">
          <label class="form-label">Ä°ÅŸ No <span class="form-required">*</span></label>
          <div style="display:flex;gap:6px">
            <input type="number" class="form-input" id="f-odm-isno" placeholder="1" oninput="autoFillMusteri()">
            <button type="button" class="btn btn-secondary" onclick="openIsSecModal()"
              style="white-space:nowrap;padding:0 10px;font-size:12px">ğŸ“‹ SeÃ§</button>
          </div>
        </div>
        <div class="form-row">
          <label class="form-label">MÃ¼ÅŸteri (otomatik)</label>
          <input type="text" class="form-input" id="f-odm-musteri" readonly style="color:var(--green)">
        </div>
        <div class="form-row">
          <label class="form-label">TC Kimlik</label>
          <input type="text" class="form-input" id="f-odm-tc" placeholder="11 haneli TC">
        </div>
      </div>

      
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;
        background:var(--surface2);border:1px solid var(--border);border-radius:var(--r12);
        padding:14px;margin-bottom:16px">
        <div class="form-row">
          <label class="form-label">Toplam Fatura (â‚º) <span class="form-required">*</span></label>
          <input type="number" class="form-input" id="f-odm-tutar" placeholder="0" oninput="calcOdeme()" style="font-size:15px;font-weight:700">
        </div>
        <div class="form-row">
          <label class="form-label">Toplam Ã–denen</label>
          <input type="text" class="form-input" id="f-odm-toplam" readonly style="color:var(--green);font-weight:700;font-size:15px">
        </div>
        <div class="form-row">
          <label class="form-label">Kalan BorÃ§</label>
          <input type="text" class="form-input" id="f-odm-kalan" readonly style="color:var(--red);font-weight:700;font-size:15px">
        </div>
        <div class="form-row">
          <label class="form-label">Ã–deme Durumu</label>
          <div id="odm-durum-gosterge" style="padding:8px 12px;border-radius:var(--r8);
            background:var(--surface2);border:1px solid var(--border);font-size:13px;color:var(--text2)">
            Tutar girilince otomatik hesaplanÄ±r
          </div>
        </div>
      </div>

      
      <div style="margin-bottom:16px">
        <div style="display:flex;gap:4px;margin-bottom:12px;background:var(--surface2);
          padding:4px;border-radius:var(--r8);width:fit-content">
          <button class="odm-tab-btn active" onclick="switchOdmTab('nakit',this)">ğŸ’µ Nakit</button>
          <button class="odm-tab-btn" onclick="switchOdmTab('kart',this)">ğŸ’³ Kredi KartÄ±</button>
          <button class="odm-tab-btn" onclick="switchOdmTab('havale',this)">ğŸ¦ Havale/EFT</button>
          <button class="odm-tab-btn" onclick="switchOdmTab('cek',this)">ğŸ“„ Ã‡ek</button>
          <button class="odm-tab-btn" onclick="switchOdmTab('vadeli',this)">ğŸ“… Vadeli</button>
        </div>

        
        <div class="odm-tab" id="odm-tab-nakit">
          <div style="display:grid;grid-template-columns:1fr 2fr;gap:12px;align-items:end">
            <div class="form-row">
              <label class="form-label">Nakit Tutar (â‚º)</label>
              <input type="number" class="form-input" id="f-odm-nakit" placeholder="0" oninput="calcOdeme()" style="font-size:15px">
            </div>
            <div style="padding:10px;background:var(--surface2);border-radius:var(--r8);border:1px solid var(--border)">
              <div class="text-xs text-muted">Nakit Ã¶deme en hÄ±zlÄ± ve en basit yÃ¶ntemdir. Tutar girin, kaydedin.</div>
            </div>
          </div>
        </div>

        
        <div class="odm-tab" id="odm-tab-kart" style="display:none">
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:10px">
            <div class="form-row">
              <label class="form-label">Kart TutarÄ± (â‚º)</label>
              <input type="number" class="form-input" id="f-odm-kart" placeholder="0" oninput="calcOdeme()" style="font-size:15px">
            </div>
            <div class="form-row">
              <label class="form-label">Taksit SayÄ±sÄ±</label>
              <select class="form-select" id="f-odm-taksit" onchange="calcTaksit()">
                <option value="0">PeÅŸin (Taksitsiz)</option>
                <option value="2">2 Taksit</option><option value="3">3 Taksit</option>
                <option value="4">4 Taksit</option><option value="5">5 Taksit</option>
                <option value="6">6 Taksit</option><option value="9">9 Taksit</option>
                <option value="12">12 Taksit</option><option value="18">18 Taksit</option>
                <option value="24">24 Taksit</option><option value="36">36 Taksit</option>
              </select>
            </div>
            <div class="form-row">
              <label class="form-label">Taksit TutarÄ± (otomatik)</label>
              <input type="text" class="form-input" id="f-odm-taksit-tutar" readonly style="color:var(--purple);font-weight:700">
            </div>
          </div>
          
          <div id="taksit-progress-area" style="display:none;background:var(--surface2);border:1px solid var(--border);
            border-radius:var(--r8);padding:12px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
              <div class="text-sm font-bold">Taksit Takibi</div>
              <div class="text-xs text-muted">Ã–denen taksit sayÄ±sÄ±nÄ± girin</div>
            </div>
            <div style="display:flex;align-items:center;gap:12px">
              <input type="number" class="form-input" id="f-odm-taksit-odenen" placeholder="0"
                min="0" oninput="calcTaksit()" style="width:80px">
              <span class="text-muted">/</span>
              <span id="taksit-total-label" class="font-bold text-purple" style="color:var(--purple)">0</span>
              <span class="text-muted text-sm">taksit Ã¶dendi</span>
              <div style="flex:1">
                <div class="progress">
                  <div class="progress-fill" id="taksit-progress-bar" style="background:var(--purple);width:0%"></div>
                </div>
              </div>
              <span id="taksit-pct-label" class="text-xs text-muted">0%</span>
            </div>
            <div id="taksit-kalan-info" class="text-xs text-muted mt-8"></div>
          </div>
        </div>

        
        <div class="odm-tab" id="odm-tab-havale" style="display:none">
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
            <div class="form-row">
              <label class="form-label">Havale/EFT TutarÄ± (â‚º)</label>
              <input type="number" class="form-input" id="f-odm-havale" placeholder="0" oninput="calcOdeme()" style="font-size:15px">
            </div>
            <div class="form-row">
              <label class="form-label">Banka / GÃ¶nderen</label>
              <input type="text" class="form-input" id="f-odm-havale-banka" placeholder="Akbank, Ziraat...">
            </div>
            <div class="form-row">
              <label class="form-label">AÃ§Ä±klama / Referans</label>
              <input type="text" class="form-input" id="f-odm-havale-ref" placeholder="Ref no veya aÃ§Ä±klama">
            </div>
          </div>
        </div>

        
        <div class="odm-tab" id="odm-tab-cek" style="display:none">
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
            <div class="form-row">
              <label class="form-label">Ã‡ek TutarÄ± (â‚º)</label>
              <input type="number" class="form-input" id="f-odm-cek" placeholder="0" oninput="calcOdeme()" style="font-size:15px">
            </div>
            <div class="form-row">
              <label class="form-label">Ã‡ek Tarihi</label>
              <input type="date" class="form-input" id="f-odm-cek-tarih">
            </div>
            <div class="form-row">
              <label class="form-label">Ã‡ek NumarasÄ±</label>
              <input type="text" class="form-input" id="f-odm-cek-no" placeholder="Ã‡ek seri no">
            </div>
            <div class="form-row">
              <label class="form-label">Ã‡ek Durumu</label>
              <select class="form-select" id="f-odm-cek-durum">
                <option>Beklemede</option>
                <option>Tahsil Edildi</option>
                <option>Ä°ade Edildi</option>
                <option>KarÅŸÄ±lÄ±ksÄ±z</option>
              </select>
            </div>
          </div>
        </div>

        
        <div class="odm-tab" id="odm-tab-vadeli" style="display:none">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
            <div class="form-row">
              <label class="form-label">Åimdi AlÄ±nan (â‚º)</label>
              <input type="number" class="form-input" id="f-odm-simdi" placeholder="0" oninput="calcVadeli()" style="font-size:15px">
            </div>
            <div class="form-row">
              <label class="form-label">Sonraya BÄ±rakÄ±lan (â‚º) â€” otomatik</label>
              <input type="text" class="form-input" id="f-odm-sonra" readonly style="color:var(--orange);font-weight:700;font-size:15px">
            </div>
          </div>
          
          <div style="margin-bottom:8px;display:flex;align-items:center;justify-content:space-between">
            <div class="text-sm font-bold">Vade PlanÄ±</div>
            <button class="btn btn-secondary btn-sm" onclick="addVadeRow()">+ Vade Ekle</button>
          </div>
          <div id="vade-rows-container" style="display:flex;flex-direction:column;gap:6px"></div>
          <div style="background:var(--surface2);border-radius:var(--r8);padding:10px;margin-top:10px">
            <div class="text-xs text-muted">ğŸ’¡ Her vade satÄ±rÄ± iÃ§in tutar ve tarih girin. Vade takibi sekmesinde otomatik gÃ¶rÃ¼nÃ¼r.</div>
          </div>
        </div>
      </div>

      
      <div class="form-row">
        <label class="form-label">Not</label>
        <input type="text" class="form-input" id="f-odm-not" placeholder="Ã–deme notu...">
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-odm')">Ä°ptal</button>
      <button class="btn btn-primary" onclick="saveOdeme()">ğŸ’¾ Kaydet</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-widgets">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title">âš™ Widget AyarlarÄ±</div>
      <button class="btn-icon" onclick="closeModal('modal-widgets')">âœ•</button>
    </div>
    <div class="modal-body" id="widget-settings-body"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-widgets')">Kapat</button>
      <button class="btn btn-primary" onclick="applyWidgets()">Uygula</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-usta-odm">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title" id="modal-usta-odm-title">Usta Ã–demesi Ekle</div>
      <button class="btn-icon" onclick="closeModal('modal-usta-odm')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-row" style="margin-bottom:12px">
        <label class="form-label">Usta</label>
        <input type="text" class="form-input" id="f-uodm-usta" readonly style="color:var(--blue);font-weight:700">
      </div>
      <div class="form-grid-2" style="margin-bottom:12px">
        <div class="form-row">
          <label class="form-label">Tarih <span class="form-required">*</span></label>
          <input type="date" class="form-input" id="f-uodm-tarih">
        </div>
        <div class="form-row">
          <label class="form-label">Tutar (â‚º) <span class="form-required">*</span></label>
          <input type="number" class="form-input" id="f-uodm-tutar" placeholder="0" style="font-size:16px;font-weight:700">
        </div>
      </div>
      <div class="form-row" style="margin-bottom:12px">
        <label class="form-label">Ã–deme TÃ¼rÃ¼</label>
        <select class="form-select" id="f-uodm-tur">
          <option>Nakit</option><option>Havale/EFT</option><option>Banka</option><option>DiÄŸer</option>
        </select>
      </div>
      <div class="form-row">
        <label class="form-label">AÃ§Ä±klama</label>
        <input type="text" class="form-input" id="f-uodm-aciklama" placeholder="Hangi iÅŸler iÃ§in, not...">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-usta-odm')">Ä°ptal</button>
      <button class="btn btn-primary" onclick="saveUstaOdemeModal()">ğŸ’¾ Kaydet</button>
    </div>
  </div>
</div>

<!-- â•â•â• USTA EXCEL EXPORT MODAL â•â•â• -->
<div class="modal-overlay" id="modal-usta-export">
  <div class="modal" style="max-width:520px">
    <div class="modal-header">
      <div class="modal-title">ğŸ“¥ Usta HakediÅŸ Excel Export</div>
      <button class="btn-icon" onclick="closeModal('modal-usta-export')">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:16px">

      <!-- Usta SeÃ§imi -->
      <div class="form-group">
        <label class="form-label">Usta SeÃ§imi</label>
        <select class="form-select" id="exp-usta-sec">
          <option value="__tumustalar__">ğŸ‘· TÃ¼m Ustalar</option>
        </select>
      </div>

      <!-- Ä°ÅŸ Tarihi AralÄ±ÄŸÄ± -->
      <div class="form-group">
        <label class="form-label">ğŸ“… Ä°ÅŸ Tarihi AralÄ±ÄŸÄ± <span class="text-xs text-muted">(iÅŸ/tadilat tarihi)</span></label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="date" class="form-input" id="exp-is-bas" style="flex:1">
          <span class="text-sm text-muted">â€”</span>
          <input type="date" class="form-input" id="exp-is-bit" style="flex:1">
        </div>
        <label style="display:flex;align-items:center;gap:6px;margin-top:6px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="exp-is-filtre-ac" onchange="toggleExportFilter('is')" checked>
          Bu filtreyi uygula
        </label>
      </div>

      <!-- Ã–deme Tarihi AralÄ±ÄŸÄ± -->
      <div class="form-group">
        <label class="form-label">ğŸ’³ Ã–deme Tarihi AralÄ±ÄŸÄ± <span class="text-xs text-muted">(yapÄ±lan Ã¶demeler)</span></label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="date" class="form-input" id="exp-odm-bas" style="flex:1">
          <span class="text-sm text-muted">â€”</span>
          <input type="date" class="form-input" id="exp-odm-bit" style="flex:1">
        </div>
        <label style="display:flex;align-items:center;gap:6px;margin-top:6px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="exp-odm-filtre-ac" onchange="toggleExportFilter('odm')" checked>
          Bu filtreyi uygula
        </label>
      </div>

      <!-- Sheet Tipi -->
      <div class="form-group">
        <label class="form-label">ğŸ“Š Excel DÃ¼zeni</label>
        <div style="display:flex;flex-direction:column;gap:8px">
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
            <input type="radio" name="exp-sheet-tip" value="ayri" checked> Her usta ayrÄ± sekme (sheet)
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
            <input type="radio" name="exp-sheet-tip" value="tek"> Tek sekme, ustaya gÃ¶re gruplu
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
            <input type="radio" name="exp-sheet-tip" value="her-ikisi"> Her ikisi de (2 ayrÄ± sekme)
          </label>
        </div>
      </div>

      <!-- Ã–nizleme -->
      <div id="exp-onizleme" style="background:var(--surface2);border-radius:var(--r8);padding:12px;font-size:12px;color:var(--text2);display:none"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-usta-export')">Ä°ptal</button>
      <button class="btn btn-secondary" onclick="ustaExportOnizle()" style="background:var(--surface2)">ğŸ‘ Ã–nizle</button>
      <button class="btn btn-primary" onclick="ustaExportExcel()">ğŸ“¥ Excel Ä°ndir</button>
    </div>
  </div>
</div>

<!-- â•â•â• CARÄ° FÄ°RMA EKLE/DÃœZENLE MODAL â•â•â• -->
<div class="modal-overlay" id="modal-cari-firma">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title" id="modal-cari-firma-title">ğŸ¢ Firma Ekle</div>
      <button class="btn-icon" onclick="closeModal('modal-cari-firma')">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:14px">
      <div class="form-grid-2">
        <div class="form-row" style="grid-column:1/-1">
          <label class="form-label">Firma AdÄ± <span class="form-required">*</span></label>
          <input type="text" class="form-input" id="f-cari-ad" placeholder="Ã–rn: ABC Teknik Servis">
        </div>
        <div class="form-row">
          <label class="form-label">SektÃ¶r / TÃ¼r</label>
          <select class="form-select" id="f-cari-sektor">
            <option>TedarikÃ§i</option>
            <option>Servis FirmasÄ±</option>
            <option>YÃ¼klenici</option>
            <option>Ortak</option>
            <option>DistribÃ¼tÃ¶r</option>
            <option>DiÄŸer</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">Yetkili / Ä°rtibat</label>
          <input type="text" class="form-input" id="f-cari-yetkili" placeholder="Ad Soyad">
        </div>
        <div class="form-row">
          <label class="form-label">Telefon</label>
          <input type="text" class="form-input" id="f-cari-tel" placeholder="05xx xxx xx xx">
        </div>
        <div class="form-row">
          <label class="form-label">E-posta</label>
          <input type="text" class="form-input" id="f-cari-email" placeholder="ornek@firma.com">
        </div>
        <div class="form-row" style="grid-column:1/-1">
          <label class="form-label">Not / Adres</label>
          <textarea class="form-textarea" id="f-cari-not" placeholder="Adres, anlaÅŸma detaylarÄ±..." style="min-height:64px"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-cari-firma')">Ä°ptal</button>
      <button class="btn btn-primary" onclick="saveCariFirma()">ğŸ’¾ Kaydet</button>
    </div>
  </div>
</div>

<!-- â•â•â• CARÄ° HAREKET EKLE MODAL â•â•â• -->
<div class="modal-overlay" id="modal-cari-hareket">
  <div class="modal" style="max-width:500px">
    <div class="modal-header">
      <div class="modal-title" id="modal-cari-hareket-title">Hareket Ekle</div>
      <button class="btn-icon" onclick="closeModal('modal-cari-hareket')">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:14px">
      <input type="hidden" id="f-ch-firma-id">
      <input type="hidden" id="f-ch-id">

      <!-- Hareket tipi -->
      <div class="form-row">
        <label class="form-label">Hareket Tipi <span class="form-required">*</span></label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <label style="display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:var(--r8);border:2px solid var(--border);cursor:pointer;transition:all .15s" id="lbl-ch-borc">
            <input type="radio" name="ch-tip" value="borc" onchange="chTipChange()" checked>
            <div><div style="font-weight:700;color:var(--red)">ğŸ“¤ BorÃ§</div><div style="font-size:10px;color:var(--text3)">Firmaya Ã¶dedik</div></div>
          </label>
          <label style="display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:var(--r8);border:2px solid var(--border);cursor:pointer;transition:all .15s" id="lbl-ch-alacak">
            <input type="radio" name="ch-tip" value="alacak" onchange="chTipChange()">
            <div><div style="font-weight:700;color:var(--green)">ğŸ“¥ Alacak</div><div style="font-size:10px;color:var(--text3)">Firmadan tahsil</div></div>
          </label>
        </div>
      </div>

      <div class="form-grid-2">
        <div class="form-row">
          <label class="form-label">Tutar (â‚º) <span class="form-required">*</span></label>
          <input type="number" class="form-input" id="f-ch-tutar" placeholder="0.00" style="font-size:16px;font-weight:700">
        </div>
        <div class="form-row">
          <label class="form-label">Tarih <span class="form-required">*</span></label>
          <input type="date" class="form-input" id="f-ch-tarih">
        </div>
        <div class="form-row">
          <label class="form-label">Ã–deme YÃ¶ntemi</label>
          <select class="form-select" id="f-ch-yontem">
            <option>Nakit</option><option>Havale/EFT</option>
            <option>Kart</option><option>Ã‡ek</option><option>Senet</option><option>DiÄŸer</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">Belge No <span class="text-xs text-muted">(fatura/irsaliye)</span></label>
          <input type="text" class="form-input" id="f-ch-belge" placeholder="Fatura no...">
        </div>
        <div class="form-row" style="grid-column:1/-1">
          <label class="form-label">AÃ§Ä±klama <span class="form-required">*</span></label>
          <input type="text" class="form-input" id="f-ch-aciklama" placeholder="Malzeme alÄ±mÄ±, servis bedeli...">
        </div>
        <div class="form-row" style="grid-column:1/-1">
          <label class="form-label">BaÄŸlÄ± Ä°ÅŸ Emri <span class="text-xs text-muted">(isteÄŸe baÄŸlÄ±)</span></label>
          <select class="form-select" id="f-ch-is-emri">
            <option value="">â€” BaÄŸlantÄ±sÄ±z â€”</option>
          </select>
        </div>
      </div>

      <!-- HD entegrasyon seÃ§eneÄŸi -->
      <div style="background:var(--surface2);border-radius:var(--r8);padding:12px;border:1px solid var(--border2)">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
          <input type="checkbox" id="f-ch-hd-yansit" checked style="width:16px;height:16px">
          <div>
            <div style="font-size:13px;font-weight:600">ğŸ“’ Hesap Defteri'ne yansÄ±t</div>
            <div style="font-size:11px;color:var(--text3);margin-top:2px" id="ch-hd-aciklama-preview">Otomatik kayÄ±t oluÅŸturulacak</div>
          </div>
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-cari-hareket')">Ä°ptal</button>
      <button class="btn btn-primary" onclick="saveCariHareket()">ğŸ’¾ Kaydet</button>
    </div>
  </div>
</div>

<!-- â•â•â• CARÄ° EXCEL EXPORT MODAL â•â•â• -->
<div class="modal-overlay" id="modal-cari-export">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title">ğŸ“¥ Cari Hesaplar Excel Export</div>
      <button class="btn-icon" onclick="closeModal('modal-cari-export')">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:14px">
      <div class="form-group">
        <label class="form-label">Firma SeÃ§imi</label>
        <select class="form-select" id="cari-exp-firma">
          <option value="__tumfirmalar__">ğŸ¢ TÃ¼m Firmalar</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ğŸ“… Tarih AralÄ±ÄŸÄ±</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="date" class="form-input" id="cari-exp-bas" style="flex:1">
          <span class="text-sm text-muted">â€”</span>
          <input type="date" class="form-input" id="cari-exp-bit" style="flex:1">
        </div>
        <label style="display:flex;align-items:center;gap:6px;margin-top:6px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="cari-exp-tarih-ac" onchange="cariExpToggle()" checked> Tarih filtresi uygula
        </label>
      </div>
      <div class="form-group">
        <label class="form-label">Hareket Tipi</label>
        <select class="form-select" id="cari-exp-tip">
          <option value="">TÃ¼mÃ¼ (BorÃ§ + Alacak)</option>
          <option value="borc">YalnÄ±zca BorÃ§lar</option>
          <option value="alacak">YalnÄ±zca Alacaklar</option>
        </select>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="cari-exp-ozet" checked> Firma bazlÄ± Ã¶zet sekmesi ekle
        </label>
      </div>
      <div id="cari-exp-onizleme" style="background:var(--surface2);border-radius:var(--r8);padding:10px;font-size:12px;color:var(--text2);display:none"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-cari-export')">Ä°ptal</button>
      <button class="btn btn-secondary" onclick="cariExportOnizle()" style="background:var(--surface2)">ğŸ‘ Ã–nizle</button>
      <button class="btn btn-primary" onclick="cariExportExcel()">ğŸ“¥ Excel Ä°ndir</button>
    </div>
  </div>
</div>

<!-- â•â•â• Ä°Å EMÄ°RLERÄ° EXCEL EXPORT MODAL â•â•â• -->
<div class="modal-overlay" id="modal-tad-export">
  <div class="modal" style="max-width:500px">
    <div class="modal-header">
      <div class="modal-title">ğŸ“¥ Ä°ÅŸ Emirleri Excel Export</div>
      <button class="btn-icon" onclick="closeModal('modal-tad-export')">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:14px">
      <div class="form-group">
        <label class="form-label">ğŸ“… Tarih AralÄ±ÄŸÄ±</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="date" class="form-input" id="tad-exp-bas" style="flex:1">
          <span class="text-sm text-muted">â€”</span>
          <input type="date" class="form-input" id="tad-exp-bit" style="flex:1">
        </div>
        <label style="display:flex;align-items:center;gap:6px;margin-top:6px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="tad-exp-tarih-ac" onchange="tadExpToggle()" checked> Tarih filtresi uygula
        </label>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div class="form-group">
          <label class="form-label">Durum</label>
          <select class="form-select" id="tad-exp-durum">
            <option value="">TÃ¼mÃ¼</option>
            <option>TamamlandÄ±</option><option>Devam Ediyor</option>
            <option>Beklemede</option><option>Ä°ptal</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Usta</label>
          <select class="form-select" id="tad-exp-usta">
            <option value="">TÃ¼m Ustalar</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="tad-exp-arsiv"> ArÅŸivlenmiÅŸ kayÄ±tlarÄ± dahil et
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;margin-top:6px">
          <input type="checkbox" id="tad-exp-ozet" checked> Ã–zet satÄ±rÄ± ekle
        </label>
      </div>
      <div id="tad-exp-onizleme" style="background:var(--surface2);border-radius:var(--r8);padding:10px;font-size:12px;color:var(--text2);display:none"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-tad-export')">Ä°ptal</button>
      <button class="btn btn-secondary" onclick="tadExportOnizle()" style="background:var(--surface2)">ğŸ‘ Ã–nizle</button>
      <button class="btn btn-primary" onclick="tadExportExcel()">ğŸ“¥ Excel Ä°ndir</button>
    </div>
  </div>
</div>

<!-- â•â•â• MÃœÅTERÄ° Ã–DEMELERÄ° EXCEL EXPORT MODAL â•â•â• -->
<div class="modal-overlay" id="modal-odm-export">
  <div class="modal" style="max-width:500px">
    <div class="modal-header">
      <div class="modal-title">ğŸ“¥ MÃ¼ÅŸteri Ã–demeleri Excel Export</div>
      <button class="btn-icon" onclick="closeModal('modal-odm-export')">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:14px">
      <div class="form-group">
        <label class="form-label">ğŸ“… Tarih AralÄ±ÄŸÄ± <span class="text-xs text-muted">(Ã¶deme kaydÄ± tarihi)</span></label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="date" class="form-input" id="odm-exp-bas" style="flex:1">
          <span class="text-sm text-muted">â€”</span>
          <input type="date" class="form-input" id="odm-exp-bit" style="flex:1">
        </div>
        <label style="display:flex;align-items:center;gap:6px;margin-top:6px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="odm-exp-tarih-ac" onchange="odmExpToggle()" checked> Tarih filtresi uygula
        </label>
      </div>
      <div class="form-group">
        <label class="form-label">Ã–deme Durumu</label>
        <select class="form-select" id="odm-exp-durum">
          <option value="">TÃ¼mÃ¼</option>
          <option>Ã–dendi</option><option>KÄ±smi Ã–deme</option><option>Ã–denmedi</option>
        </select>
      </div>
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="odm-exp-arsiv"> ArÅŸivlenmiÅŸ kayÄ±tlarÄ± dahil et
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;margin-top:6px">
          <input type="checkbox" id="odm-exp-ozet" checked> Tahsilat Ã¶zet sekmesi ekle (Nakit/Kart/Havale/Ã‡ek)
        </label>
      </div>
      <div id="odm-exp-onizleme" style="background:var(--surface2);border-radius:var(--r8);padding:10px;font-size:12px;color:var(--text2);display:none"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-odm-export')">Ä°ptal</button>
      <button class="btn btn-secondary" onclick="odmExportOnizle()" style="background:var(--surface2)">ğŸ‘ Ã–nizle</button>
      <button class="btn btn-primary" onclick="odmExportExcel()">ğŸ“¥ Excel Ä°ndir</button>
    </div>
  </div>
</div>

<!-- â•â•â• HESAP DEFTERÄ° EXCEL EXPORT MODAL â•â•â• -->
<div class="modal-overlay" id="modal-hd-export">
  <div class="modal" style="max-width:520px">
    <div class="modal-header">
      <div class="modal-title">ğŸ“¥ Hesap Defteri Excel Export</div>
      <button class="btn-icon" onclick="closeModal('modal-hd-export')">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:16px">

      <!-- Tarih AralÄ±ÄŸÄ± -->
      <div class="form-group">
        <label class="form-label">ğŸ“… Tarih AralÄ±ÄŸÄ±</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input type="date" class="form-input" id="hd-exp-bas" style="flex:1">
          <span class="text-sm text-muted">â€”</span>
          <input type="date" class="form-input" id="hd-exp-bit" style="flex:1">
        </div>
        <label style="display:flex;align-items:center;gap:6px;margin-top:6px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="hd-exp-tarih-ac" onchange="hdExpToggleTarih()" checked>
          Tarih filtresi uygula
        </label>
      </div>

      <!-- Tip Filtresi -->
      <div class="form-group">
        <label class="form-label">KayÄ±t Tipi</label>
        <select class="form-select" id="hd-exp-tip">
          <option value="">TÃ¼mÃ¼ (Gelir + Gider)</option>
          <option value="gelir">YalnÄ±zca Gelirler</option>
          <option value="gider">YalnÄ±zca Giderler</option>
        </select>
      </div>

      <!-- Kategori Filtresi -->
      <div class="form-group">
        <label class="form-label">Kategori <span class="text-xs text-muted">(boÅŸ = tÃ¼mÃ¼)</span></label>
        <select class="form-select" id="hd-exp-kategori">
          <option value="">TÃ¼m Kategoriler</option>
        </select>
      </div>

      <!-- Otomatik kayÄ±tlar -->
      <div class="form-group">
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
          <input type="checkbox" id="hd-exp-otomatik" checked>
          Otomatik oluÅŸturulan kayÄ±tlarÄ± dahil et
        </label>
        <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;margin-top:6px">
          <input type="checkbox" id="hd-exp-ozet" checked>
          Ã–zet satÄ±rÄ± ekle (toplam gelir / gider / net bakiye)
        </label>
      </div>

      <!-- Ã–nizleme -->
      <div id="hd-exp-onizleme" style="background:var(--surface2);border-radius:var(--r8);padding:12px;font-size:12px;color:var(--text2);display:none"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-hd-export')">Ä°ptal</button>
      <button class="btn btn-secondary" onclick="hdExportOnizle()" style="background:var(--surface2)">ğŸ‘ Ã–nizle</button>
      <button class="btn btn-primary" onclick="hdExportExcel()">ğŸ“¥ Excel Ä°ndir</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-hd">
  <div class="modal" style="max-width:520px">
    <div class="modal-header">
      <div class="modal-title" id="modal-hd-title">Manuel KayÄ±t</div>
      <button class="btn-icon" onclick="closeModal('modal-hd')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid-2" style="margin-bottom:12px">
        <div class="form-row">
          <label class="form-label">TÃ¼r <span class="form-required">*</span></label>
          <select class="form-select" id="f-hd-tip" onchange="updateHdKategori()">
            <option value="gelir">ğŸ“ˆ Gelir</option>
            <option value="gider">ğŸ“‰ Gider</option>
          </select>
        </div>
        <div class="form-row">
          <label class="form-label">Tarih <span class="form-required">*</span></label>
          <input type="date" class="form-input" id="f-hd-tarih">
        </div>
      </div>
      <div class="form-grid-2" style="margin-bottom:12px">
        <div class="form-row">
          <label class="form-label">Kategori</label>
          <select class="form-select" id="f-hd-kategori"></select>
        </div>
        <div class="form-row">
          <label class="form-label">Tutar (â‚º) <span class="form-required">*</span></label>
          <input type="number" class="form-input" id="f-hd-tutar" placeholder="0" style="font-size:16px;font-weight:700">
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">AÃ§Ä±klama</label>
        <input type="text" class="form-input" id="f-hd-aciklama" placeholder="AÃ§Ä±klama girin...">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-hd')">Ä°ptal</button>
      <button class="btn btn-primary" onclick="saveHdManuel()">ğŸ’¾ Kaydet</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-hakkinda">
  <div class="modal" style="max-width:440px">
    <div class="modal-header">
      <div class="modal-title">HakkÄ±nda</div>
      <button class="btn-icon" onclick="closeModal('modal-hakkinda')">âœ•</button>
    </div>
    <div class="modal-body" style="text-align:center;padding:32px 24px">
      <div style="font-size:48px;margin-bottom:16px">ğŸ‘‘</div>
      <div style="font-size:20px;font-weight:700;color:var(--text);margin-bottom:4px">
        Royal Muhasebe Ve Ä°ÅŸ Takip Sistemi
      </div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:24px">Versiyon 20.0</div>

      <div style="background:var(--surface2);border-radius:var(--r12);padding:16px;margin-bottom:20px;text-align:left">
        <div style="display:flex;flex-direction:column;gap:10px">
          <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:10px;border-bottom:1px solid var(--border2)">
            <span class="text-sm text-muted">GeliÅŸtirici</span>
            <span class="font-bold" style="color:var(--blue)">Fatih GÃ¶nen</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:10px;border-bottom:1px solid var(--border2)">
            <span class="text-sm text-muted">Platform</span>
            <span class="text-sm">Web TabanlÄ± MasaÃ¼stÃ¼</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:10px;border-bottom:1px solid var(--border2)">
            <span class="text-sm text-muted">Veri Depolama</span>
            <span class="text-sm" id="hakkinda-storage">HesaplanÄ±yor...</span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span class="text-sm text-muted">KayÄ±t SayÄ±sÄ±</span>
            <span class="text-sm" id="hakkinda-records">â€”</span>
          </div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:20px">
        <div style="padding:10px;background:var(--surface2);border-radius:var(--r8)">
          <div style="font-size:18px;font-weight:700;color:var(--blue)" id="hk-is">0</div>
          <div class="text-xs text-muted">Ä°ÅŸ Emri</div>
        </div>
        <div style="padding:10px;background:var(--surface2);border-radius:var(--r8)">
          <div style="font-size:18px;font-weight:700;color:var(--green)" id="hk-odm">0</div>
          <div class="text-xs text-muted">Ã–deme</div>
        </div>
        <div style="padding:10px;background:var(--surface2);border-radius:var(--r8)">
          <div style="font-size:18px;font-weight:700;color:var(--purple)" id="hk-hd">0</div>
          <div class="text-xs text-muted">Hesap KaydÄ±</div>
        </div>
      </div>

      <div style="font-size:11px;color:var(--text3);line-height:1.6">
        Bu yazÄ±lÄ±m Fatih GÃ¶nen tarafÄ±ndan geliÅŸtirilmiÅŸtir.<br>
        TÃ¼m haklarÄ± saklÄ±dÄ±r Â© 2025
      </div>
    </div>
    <div class="modal-footer" style="justify-content:center">
      <button class="btn btn-secondary" onclick="closeModal('modal-hakkinda')">Kapat</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-is-sec">
  <div class="modal" style="max-width:600px">
    <div class="modal-header">
      <div class="modal-title">Ä°ÅŸ Emri SeÃ§</div>
      <button class="btn-icon" onclick="closeModal('modal-is-sec')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="text" class="form-input" id="is-sec-search" placeholder="MÃ¼ÅŸteri adÄ± veya Ä°ÅŸ No ara..."
        oninput="dRenderIsSecList()" style="margin-bottom:12px">
      <div id="is-sec-list" style="max-height:360px;overflow-y:auto"></div>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<!-- Ã–zel Confirm Modali -->


<!-- â•â•â• PERSONEL EKLE/DÃœZENLE MODAL â•â•â• -->
<div class="modal-overlay" id="modal-personel">
  <div class="modal" style="max-width:460px">
    <div class="modal-header">
      <div class="modal-title" id="modal-personel-title">ğŸ‘¥ Personel Ekle</div>
      <button class="btn-icon" onclick="closeModal('modal-personel')">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:14px">
      <div class="form-grid-2">
        <div class="form-row" style="grid-column:1/-1">
          <label class="form-label">Ad Soyad <span class="form-required">*</span></label>
          <input type="text" class="form-input" id="f-prs-ad" placeholder="Ad Soyad">
        </div>
        <div class="form-row">
          <label class="form-label">Pozisyon</label>
          <input type="text" class="form-input" id="f-prs-pozisyon" placeholder="Teknisyen, Muhasebe...">
        </div>
        <div class="form-row">
          <label class="form-label">Telefon</label>
          <input type="text" class="form-input" id="f-prs-tel" placeholder="05xx xxx xx xx">
        </div>
        <div class="form-row">
          <label class="form-label">Hedef MaaÅŸ (â‚º)</label>
          <input type="number" class="form-input" id="f-prs-maas" placeholder="0">
        </div>
        <div class="form-row">
          <label class="form-label">Ä°ÅŸe BaÅŸlama</label>
          <input type="date" class="form-input" id="f-prs-baslama">
        </div>
        <div class="form-row" style="grid-column:1/-1">
          <label class="form-label">Not</label>
          <textarea class="form-textarea" id="f-prs-not" placeholder="Ek bilgiler..." style="min-height:56px"></textarea>
        </div>
      </div>
      <div class="form-row" id="prs-durum-row" style="display:none">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px">
          <input type="checkbox" id="f-prs-pasif" style="width:16px;height:16px">
          Pasif (iÅŸten ayrÄ±ldÄ±)
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-personel')">Ä°ptal</button>
      <button class="btn btn-primary" onclick="savePersonel()">ğŸ’¾ Kaydet</button>
    </div>
  </div>
</div>

<!-- â•â•â• PERSONEL Ä°ÅLEM MODAL â•â•â• -->
<div class="modal-overlay" id="modal-personel-islem">
  <div class="modal" style="max-width:480px">
    <div class="modal-header">
      <div class="modal-title" id="modal-personel-islem-title">Ä°ÅŸlem Ekle</div>
      <button class="btn-icon" onclick="closeModal('modal-personel-islem')">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:14px">
      <input type="hidden" id="f-pi-personel-id">
      <input type="hidden" id="f-pi-id">

      <!-- Ä°ÅŸlem Tipi -->
      <div class="form-row">
        <label class="form-label">Ä°ÅŸlem Tipi <span class="form-required">*</span></label>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
          <label class="vrm-yontem-lbl" id="lbl-pi-maas" style="flex-direction:column;align-items:flex-start;gap:2px">
            <input type="radio" name="pi-tip" value="maas" onchange="piTipChange()" checked>
            <div><div style="font-weight:700;color:var(--blue)">ğŸ’° MaaÅŸ</div><div style="font-size:10px;color:var(--text3)">MaaÅŸ Ã¶demesi</div></div>
          </label>
          <label class="vrm-yontem-lbl" id="lbl-pi-kasa" style="flex-direction:column;align-items:flex-start;gap:2px">
            <input type="radio" name="pi-tip" value="kasa" onchange="piTipChange()">
            <div><div style="font-weight:700;color:var(--orange)">ğŸ’µ Masraf KasasÄ±</div><div style="font-size:10px;color:var(--text3)">Masraf iÃ§in nakit</div></div>
          </label>
          <label class="vrm-yontem-lbl" id="lbl-pi-iade" style="flex-direction:column;align-items:flex-start;gap:2px">
            <input type="radio" name="pi-tip" value="iade" onchange="piTipChange()">
            <div><div style="font-weight:700;color:var(--green)">ğŸ§¾ Masraf Ä°adesi</div><div style="font-size:10px;color:var(--text3)">Kendi cebinden harcadÄ±</div></div>
          </label>
        </div>
      </div>

      <div class="form-grid-2">
        <div class="form-row">
          <label class="form-label">Tutar (â‚º) <span class="form-required">*</span></label>
          <input type="number" class="form-input" id="f-pi-tutar" placeholder="0.00" style="font-size:16px;font-weight:700">
        </div>
        <div class="form-row">
          <label class="form-label">Tarih <span class="form-required">*</span></label>
          <input type="date" class="form-input" id="f-pi-tarih">
        </div>
        <div class="form-row">
          <label class="form-label">Ã–deme YÃ¶ntemi</label>
          <select class="form-select" id="f-pi-yontem">
            <option>Nakit</option>
            <option>Havale/EFT</option>
            <option>Kart</option>
          </select>
        </div>
        <div class="form-row" id="pi-donem-row">
          <label class="form-label">DÃ¶nem <span class="text-xs text-muted">(maaÅŸ iÃ§in)</span></label>
          <input type="text" class="form-input" id="f-pi-donem" placeholder="Ocak 2025, 1. taksit...">
        </div>
        <div class="form-row" style="grid-column:1/-1">
          <label class="form-label">AÃ§Ä±klama</label>
          <input type="text" class="form-input" id="f-pi-aciklama" placeholder="AÃ§Ä±klama...">
        </div>
        <div class="form-row" style="grid-column:1/-1" id="pi-fis-row">
          <label class="form-label">FiÅŸ/Belge No <span class="text-xs text-muted">(masraf iadesi iÃ§in)</span></label>
          <input type="text" class="form-input" id="f-pi-fis" placeholder="FiÅŸ numarasÄ±...">
        </div>
      </div>

      <!-- HD Entegrasyon -->
      <div style="background:var(--surface2);border-radius:var(--r8);padding:12px;border:1px solid var(--border2)">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer">
          <input type="checkbox" id="f-pi-hd" checked style="width:16px;height:16px">
          <div>
            <div style="font-size:13px;font-weight:600">ğŸ“’ Hesap Defteri'ne yansÄ±t</div>
            <div style="font-size:11px;color:var(--text3);margin-top:2px" id="pi-hd-preview">Gider kaydÄ± otomatik oluÅŸturulacak</div>
          </div>
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-personel-islem')">Ä°ptal</button>
      <button class="btn btn-primary" onclick="savePersonelIslem()">ğŸ’¾ Kaydet</button>
    </div>
  </div>
</div>

<!-- â•â•â• PERSONEL EXCEL EXPORT MODAL â•â•â• -->
<div class="modal-overlay" id="modal-personel-export">
  <div class="modal" style="max-width:440px">
    <div class="modal-header">
      <div class="modal-title">ğŸ“¥ Personel Excel Export</div>
      <button class="btn-icon" onclick="closeModal('modal-personel-export')">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:14px">
      <div class="form-row">
        <label class="form-label">Ã‡alÄ±ÅŸan</label>
        <select class="form-select" id="prs-exp-personel">
          <option value="">TÃ¼m Ã‡alÄ±ÅŸanlar (Genel Ã–zet)</option>
        </select>
      </div>
      <div class="form-grid-2">
        <div class="form-row">
          <label class="form-label">BaÅŸlangÄ±Ã§</label>
          <input type="date" class="form-input" id="prs-exp-bas">
        </div>
        <div class="form-row">
          <label class="form-label">BitiÅŸ</label>
          <input type="date" class="form-input" id="prs-exp-bit">
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Kapsam</label>
        <div style="display:flex;flex-direction:column;gap:6px">
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="prs-exp-maas" checked style="accent-color:var(--blue)"> ğŸ’° MaaÅŸ Ã¶demeleri
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="prs-exp-kasa" checked style="accent-color:var(--orange)"> ğŸ’µ Masraf kasasÄ±
          </label>
          <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer">
            <input type="checkbox" id="prs-exp-iade" checked style="accent-color:var(--green)"> ğŸ§¾ Masraf iadeleri
          </label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-personel-export')">Ä°ptal</button>
      <button class="btn btn-primary" onclick="personelExportExcel()">ğŸ“¥ Excel Ä°ndir</button>
    </div>
  </div>
</div>

<!-- â•â•â• VÄ°RMAN MODAL â•â•â• -->
<div class="modal-overlay" id="modal-virman">
  <div class="modal" style="max-width:520px">
    <div class="modal-header">
      <div class="modal-title">â‡„ Virman Ä°ÅŸlemi</div>
      <button class="btn-icon" onclick="closeModal('modal-virman')">âœ•</button>
    </div>
    <div class="modal-body" style="display:flex;flex-direction:column;gap:14px">
      <input type="hidden" id="f-vrm-tip">
      <input type="hidden" id="f-vrm-kaynak-id">

      <!-- Bilgi Kutusu -->
      <div id="vrm-info-box" style="background:var(--surface2);border-radius:var(--r8);padding:12px;font-size:13px;color:var(--text2);border-left:3px solid var(--purple)"></div>

      <!-- Hedef Firma -->
      <div class="form-row" id="vrm-hedef-row">
        <label class="form-label">Hedef Firma <span class="form-required">*</span></label>
        <select class="form-select" id="f-vrm-hedef-firma" onchange="virmanTutarHint()">
          <option value="">â€” Firma SeÃ§ â€”</option>
        </select>
      </div>

      <!-- Tutar -->
      <div class="form-grid-2">
        <div class="form-row">
          <label class="form-label">Virman TutarÄ± (â‚º) <span class="form-required">*</span></label>
          <input type="number" class="form-input" id="f-vrm-tutar" placeholder="0.00" style="font-size:16px;font-weight:700" oninput="virmanTutarHint()">
          <div id="vrm-tutar-hint" style="font-size:11px;color:var(--text3);margin-top:4px"></div>
        </div>
        <div class="form-row">
          <label class="form-label">Tarih <span class="form-required">*</span></label>
          <input type="date" class="form-input" id="f-vrm-tarih">
        </div>
      </div>

      <!-- Ã–deme YÃ¶ntemi -->
      <div class="form-row">
        <label class="form-label">Ã–deme YÃ¶ntemi</label>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px">
          <label class="vrm-yontem-lbl" id="vrm-y-nakit">
            <input type="radio" name="vrm-yontem" value="Nakit" checked onchange="virmanYontemChange()">
            <span>ğŸ’µ Nakit</span>
          </label>
          <label class="vrm-yontem-lbl" id="vrm-y-havale">
            <input type="radio" name="vrm-yontem" value="Havale/EFT" onchange="virmanYontemChange()">
            <span>ğŸ¦ Havale</span>
          </label>
          <label class="vrm-yontem-lbl" id="vrm-y-cek">
            <input type="radio" name="vrm-yontem" value="Ã‡ek" onchange="virmanYontemChange()">
            <span>ğŸ“„ Ã‡ek</span>
          </label>
          <label class="vrm-yontem-lbl" id="vrm-y-kart">
            <input type="radio" name="vrm-yontem" value="Kart" onchange="virmanYontemChange()">
            <span>ğŸ’³ Kart</span>
          </label>
        </div>
      </div>

      <!-- Banka / Ã‡ek No (koÅŸullu) -->
      <div class="form-grid-2" id="vrm-banka-row" style="display:none">
        <div class="form-row">
          <label class="form-label">Banka</label>
          <input type="text" class="form-input" id="f-vrm-banka" placeholder="Banka adÄ±...">
        </div>
        <div class="form-row" id="vrm-cek-no-row" style="display:none">
          <label class="form-label">Ã‡ek No</label>
          <input type="text" class="form-input" id="f-vrm-cek-no" placeholder="Ã‡ek numarasÄ±...">
        </div>
      </div>

      <!-- AÃ§Ä±klama -->
      <div class="form-row">
        <label class="form-label">AÃ§Ä±klama</label>
        <input type="text" class="form-input" id="f-vrm-aciklama" placeholder="Virman aÃ§Ä±klamasÄ±...">
      </div>

      <!-- Ã–zet -->
      <div id="vrm-ozet" style="background:rgba(188,140,255,.08);border:1px solid rgba(188,140,255,.25);border-radius:var(--r8);padding:12px;font-size:12px;color:var(--text2);display:none"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-virman')">Ä°ptal</button>
      <button class="btn btn-primary" onclick="saveVirman()" style="background:var(--purple)">â‡„ VirmanÄ± Kaydet</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-confirm" style="z-index:2000">
  <div class="modal" style="max-width:420px">
    <div class="modal-header">
      <div class="modal-title" id="confirm-title">Onay</div>
      <button class="btn-icon" onclick="confirmReject()">âœ•</button>
    </div>
    <div class="modal-body">
      <p id="confirm-msg" style="font-size:14px;line-height:1.6;color:var(--text)"></p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="confirmReject()">Ä°ptal</button>
      <button class="btn btn-danger" id="confirm-ok-btn" onclick="confirmAccept()">Evet, Devam Et</button>
    </div>
  </div>
</div>

<input type="file" id="import-file" accept=".json" style="display:none" onchange="handleImport(event)">

<script>

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEY = 'dogalgaz_v9';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE BAÄLANTISI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://eonkgqrgtvmaubgnlanm.supabase.co';
const SUPABASE_KEY = 'sb_publishable_P4OnySUxegnaJ6nQcLbiGw_J4hA-oUW';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// GitHub ile giriÅŸ
async function githubLogin() {
  document.getElementById('login-error').style.display = 'none';
  document.getElementById('login-loading').style.display = 'block';
  const { error } = await _supabase.auth.signInWithOAuth({
    provider: 'github',
    options: { redirectTo: window.location.href }
  });
  if (error) {
    document.getElementById('login-loading').style.display = 'none';
    document.getElementById('login-error').style.display = 'block';
    document.getElementById('login-error').textContent = 'Hata: ' + error.message;
  }
}

// Ã‡Ä±kÄ±ÅŸ
async function cikisYap() {
  await _supabase.auth.signOut();
  toast('Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±', 'success');
}

// UygulamayÄ± gÃ¶ster ve veriyi yÃ¼kle
async function _showApp() {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('app').style.display = '';
  await loadDB();
  renderDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE SYSTEM ACCESS API â€” GerÃ§ek dosyaya kayÄ±t sistemi
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _fsHandle = null;
let _fsReady  = false;
let _fsSaving = false;

const FS_SUPPORTED = ('showOpenFilePicker' in window);

function _fsUpdateUI(){
  const ind = document.getElementById('fs-indicator');
  const btn = document.getElementById('fs-connect-btn');
  if(!ind) return;
  if(!FS_SUPPORTED){
    ind.textContent = 'âš  Sadece Chrome/Edge destekler';
    ind.style.color = 'var(--yellow)';
    return;
  }
  if(_fsReady && _fsHandle){
    ind.textContent = 'ğŸŸ¢ BaÄŸlÄ±: ' + _fsHandle.name;
    ind.style.color = 'var(--green)';
    if(btn) btn.textContent = 'ğŸ“‚ DosyayÄ± DeÄŸiÅŸtir';
  } else {
    ind.textContent = 'ğŸ”´ Dosya baÄŸlantÄ±sÄ± yok';
    ind.style.color = 'var(--red)';
    if(btn) btn.textContent = 'ğŸ“‚ Dosya SeÃ§';
  }
}

async function fsConnect(){
  if(!FS_SUPPORTED){ toast('Bu Ã¶zellik sadece Chrome/Edge tarayÄ±cÄ±larda Ã§alÄ±ÅŸÄ±r.','error'); return; }
  try{
    const [handle] = await window.showOpenFilePicker({
      types:[{ description:'Royal Muhasebe Verisi', accept:{'application/json':['.json']} }],
      multiple: false
    });
    _fsHandle = handle;
    _fsReady  = true;
    await _fsLoadFromFile();
    // localStorage artÄ±k kullanÄ±lmÄ±yor â€” temizle (5MB baskÄ±sÄ±nÄ± sÄ±fÄ±rla)
    try{ localStorage.removeItem(STORAGE_KEY); } catch(e){}
    _fsUpdateUI();
    toast('âœ… Dosyaya baÄŸlandÄ±: ' + handle.name + ' â€” localStorage temizlendi, sÄ±nÄ±r yok!', 'success');
    renderAll();
  } catch(e){
    if(e.name !== 'AbortError') toast('Dosya seÃ§ilemedi: ' + e.message, 'error');
  }
}

async function fsCreate(){
  if(!FS_SUPPORTED){ toast('Bu Ã¶zellik sadece Chrome/Edge tarayÄ±cÄ±larda Ã§alÄ±ÅŸÄ±r.','error'); return; }
  try{
    const handle = await window.showSaveFilePicker({
      suggestedName: 'royal_muhasebe_' + new Date().toISOString().slice(0,10) + '.json',
      types:[{ description:'Royal Muhasebe Verisi', accept:{'application/json':['.json']} }],
    });
    _fsHandle = handle;
    _fsReady  = true;
    await _fsWriteNow();
    // localStorage artÄ±k kullanÄ±lmÄ±yor â€” temizle
    try{ localStorage.removeItem(STORAGE_KEY); } catch(e){}
    _fsUpdateUI();
    toast('âœ… Yeni dosya oluÅŸturuldu: ' + handle.name + ' â€” artÄ±k sÄ±nÄ±r yok!', 'success');
  } catch(e){
    if(e.name !== 'AbortError') toast('Dosya oluÅŸturulamadÄ±: ' + e.message, 'error');
  }
}

async function _fsLoadFromFile(){
  if(!_fsHandle) return;
  try{
    const file = await _fsHandle.getFile();
    const text = await file.text();
    if(!text.trim()) return;
    const parsed = JSON.parse(text);
    if(parsed && parsed.tadilatlar){ DB = parsed; _migrateDB(); }
  } catch(e){ console.warn('Dosya okunamadÄ±, mevcut veri korunuyor:', e); }
}

async function _fsWriteNow(){
  if(!_fsHandle || !_fsReady || _fsSaving) return;
  _fsSaving = true;
  try{
    const writable = await _fsHandle.createWritable();
    await writable.write(JSON.stringify(DB, null, 2));
    await writable.close();
    const boyutKB = Math.round(JSON.stringify(DB).length * 2 / 1024);
    const szEl = document.getElementById('storage-size-indicator');
    if(szEl){ 
      szEl.textContent = boyutKB < 1024 
        ? boyutKB + ' KB âœ“ dosya' 
        : (boyutKB/1024).toFixed(1) + ' MB âœ“ dosya';
      szEl.style.color = 'var(--green)';
    }
  } catch(e){
    if(e.name === 'NotAllowedError'){
      toast('âš  Dosya izni gerekli â€” lÃ¼tfen tekrar izin verin.', 'warning');
      try{
        await _fsHandle.requestPermission({ mode: 'readwrite' });
        _fsSaving = false;
        await _fsWriteNow();
      } catch(e2){}
    } else {
      toast('Dosyaya yazÄ±lamadÄ±: ' + e.message, 'error');
    }
  } finally{ _fsSaving = false; }
}


// â”€â”€ DEBOUNCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function debounce(fn, ms){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}
const dRenderTadilatlar      = debounce(()=>renderTadilatlar(),      250);
const dRenderOdemeler        = debounce(()=>renderOdemeler(),        250);
const dRenderHesapDefteri    = debounce(()=>renderHesapDefteri(),    250);
const dRenderMusteriKarti    = debounce(()=>renderMusteriKarti(),    250);
const dRenderIsSecList       = debounce(()=>renderIsSecList(),       200);
const dMusteriAutocomplete   = debounce((el)=>musteriAutocomplete(el), 200);
const dRenderTadilatlarArsiv = debounce(()=>renderTadilatlarArsiv(), 250);
const dRenderOdemelerArsiv   = debounce(()=>renderOdemelerArsiv(),   250);
const dRenderUstalarArsiv    = debounce(()=>renderUstalarArsiv(),    250);



const DEFAULT_DATA = {
  tadilatlar: [],
  odemeler: [],
  fiyatlar: {},
  tanimlar: {
    ustalar: ["Mehmet Usta","Hasan Usta","Ali Usta","Yusuf Usta","Kadir Usta",
              "Ä°brahim Usta","Murat Usta","Serkan Usta","Emre Usta","Osman Usta"],
    isTipleri: ["Kombi bakÄ±mÄ±","Kombi arÄ±za tespiti","Kombi montajÄ±","Kombi sÃ¶kÃ¼m",
                "RadyatÃ¶r temizliÄŸi","Sistem yÄ±kama","Filtre deÄŸiÅŸimi","Gaz vanasÄ± deÄŸiÅŸimi",
                "AteÅŸleme elektrodu deÄŸiÅŸimi","Baca tesisatÄ±","Gaz boru tesisatÄ±",
                "SÄ±zdÄ±rmazlÄ±k testi","Devreye alma","Periyodik bakÄ±m","Acil mÃ¼dahale",
                "Termostat deÄŸiÅŸimi","Pompa deÄŸiÅŸimi","GenleÅŸme tankÄ± deÄŸiÅŸimi",
                "Su grubu deÄŸiÅŸimi","DiÄŸer"],
    markalar: {
      "Vaillant": ["ecoTEC Plus VU 20","ecoTEC Plus VU 25","ecoTEC Plus VU 30","ecoTEC Plus VU 35",
                   "ecoTEC Pro VU 20","ecoTEC Pro VU 25","ecoTEC Pro VU 28","turboTEC Plus VUW 242",
                   "turboTEC Plus VUW 282","ecoFIT Pure VU 25","ecoFIT Pure VU 30",
                   "aroTHERM plus VWL 35","aroTHERM plus VWL 55","aroTHERM plus VWL 75"],
      "Viessmann": ["Vitodens 100-W 19kW","Vitodens 100-W 25kW","Vitodens 100-W 30kW",
                    "Vitodens 111-W 19kW","Vitodens 200-W 19kW","Vitodens 200-W 25kW",
                    "Vitodens 222-W 19kW","Vitodens 300-W 19kW","Vitopend 100-W 24kW",
                    "Vitocal 200-S AWB 5kW","Vitocal 200-S AWB 7kW","Vitocal 200-S AWB 10kW"],
      "DemirdÃ¶kÃ¼m": ["Nitromix 24 BF","Nitromix 28 BF","Nitromix 32 BF","Confeo Duo 24",
                     "Confeo Duo 28","Confeo Plus 24","Confeo Hermetik 24","Arcondis 24 kW",
                     "Pelegrin 24","Pelegrin 28","Novella 24","Novella 28","Digidens 24","Digidens 28"]
    }
  },
  widgets: {
    aktif_isler: true,
    aylik_trend: true,
    usta_performans: true,
    gecikmiÅŸ_odemeler: true,
    odeme_dagilim: true,
    son_isler: true
  },
  ustaOdemeleri: {},
  hesapDefteri: [],
  giderKategorileri: ['YakÄ±t','Yemek','Malzeme','Temsil','Kira','Fatura','DiÄŸer'],
  cariFirmalar: [],
  cariHareketler: [],
  virmanlar: [],
  personeller: [],
  personelIslemler: [],
  nextId: 1
};

let DB = {};
let editingId = null;
let editingOdmId = null;
let chartInstance = null;
let chartAylikInstance = null;
let chartAylikOzetInstance = null; // #11 FIX: AylÄ±k Ã–zet sayfasÄ± iÃ§in ayrÄ± instance



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSONEL MODÃœLÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let secilenPersonelId = null;

function renderPersonel() {
  renderPersonelListe();
  renderPersonelKpi();
  if (secilenPersonelId) renderPersonelDetay(secilenPersonelId);
}

function renderPersonelKpi() {
  const personeller = (DB.personeller || []).filter(p => !p.pasif);
  const islemler = DB.personelIslemler || [];
  const topMaas = islemler.filter(i => i.tip === 'maas').reduce((s, i) => s + (i.tutar || 0), 0);
  const topKasa = islemler.filter(i => i.tip === 'kasa').reduce((s, i) => s + (i.tutar || 0), 0);
  const topIade = islemler.filter(i => i.tip === 'iade').reduce((s, i) => s + (i.tutar || 0), 0);
  const topOdeme = topMaas + topKasa + topIade;
  const el = document.getElementById('personel-kpi');
  if (!el) return;
  el.innerHTML = `
    <div class="kpi-card blue"><div class="kpi-icon">ğŸ‘¥</div>
      <div class="kpi-label">Aktif Personel</div>
      <div class="kpi-value">${personeller.length}</div></div>
    <div class="kpi-card green"><div class="kpi-icon">ğŸ’°</div>
      <div class="kpi-label">Toplam MaaÅŸ</div>
      <div class="kpi-value" style="font-size:18px">${fmt(topMaas)}</div></div>
    <div class="kpi-card orange"><div class="kpi-icon">ğŸ’µ</div>
      <div class="kpi-label">Masraf KasasÄ±</div>
      <div class="kpi-value" style="font-size:18px">${fmt(topKasa)}</div></div>
    <div class="kpi-card purple"><div class="kpi-icon">ğŸ§¾</div>
      <div class="kpi-label">Masraf Ä°adesi</div>
      <div class="kpi-value" style="font-size:18px">${fmt(topIade)}</div></div>`;
}

function renderPersonelListe() {
  const search = (document.getElementById('personel-search')?.value || '').toLowerCase();
  const pasifGoster = document.getElementById('personel-pasif-toggle')?.checked;
  let liste = (DB.personeller || []).filter(p => {
    if (!pasifGoster && p.pasif) return false;
    if (search) return (p.ad || '').toLowerCase().includes(search) || (p.pozisyon || '').toLowerCase().includes(search);
    return true;
  });
  document.getElementById('personel-count').textContent = liste.length + ' kiÅŸi';
  const el = document.getElementById('personel-liste');
  if (!el) return;
  if (liste.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text3);font-size:12px">Ã‡alÄ±ÅŸan bulunamadÄ±</div>';
    return;
  }
  el.innerHTML = liste.map(p => {
    const islemler = (DB.personelIslemler || []).filter(i => i.personelId === p.id);
    const topOdeme = islemler.reduce((s, i) => s + (i.tutar || 0), 0);
    const aktif = secilenPersonelId === p.id;
    return `<div onclick="selectPersonel('${p.id}')"
      style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--r8);cursor:pointer;margin-bottom:4px;transition:background .12s;border:1px solid ${aktif ? 'rgba(46,160,67,.4)' : 'transparent'};background:${aktif ? 'rgba(46,160,67,.1)' : 'transparent'}">
      <div style="width:36px;height:36px;border-radius:50%;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;${p.pasif ? 'opacity:.5' : ''}">
        ${p.pasif ? 'ğŸ‘¤' : 'ğŸ‘¤'}
      </div>
      <div style="flex:1;min-width:0">
        <div style="font-weight:600;font-size:13px;${p.pasif ? 'color:var(--text3)' : ''}">${esc(p.ad)}${p.pasif ? ' <span style="font-size:10px;color:var(--text3)">(Pasif)</span>' : ''}</div>
        <div style="font-size:11px;color:var(--text3)">${esc(p.pozisyon || 'â€”')}</div>
      </div>
      <div style="text-align:right;flex-shrink:0">
        <div style="font-size:12px;font-weight:700;color:var(--blue);font-family:var(--mono)">${fmt(topOdeme)}</div>
        <div style="font-size:10px;color:var(--text3)">${islemler.length} iÅŸlem</div>
      </div>
    </div>`;
  }).join('');
}

function selectPersonel(id) {
  secilenPersonelId = id;
  renderPersonelListe();
  renderPersonelDetay(id);
}

function renderPersonelDetay(personelId) {
  const el = document.getElementById('personel-detay');
  if (!el) return;
  const p = (DB.personeller || []).find(x => x.id === personelId);
  if (!p) { el.innerHTML = ''; return; }

  const islemler = (DB.personelIslemler || []).filter(i => i.personelId === personelId).slice().sort((a, b) => (b.tarih || '').localeCompare(a.tarih || ''));
  const topMaas = islemler.filter(i => i.tip === 'maas').reduce((s, i) => s + (i.tutar || 0), 0);
  const topKasa = islemler.filter(i => i.tip === 'kasa').reduce((s, i) => s + (i.tutar || 0), 0);
  const topIade = islemler.filter(i => i.tip === 'iade').reduce((s, i) => s + (i.tutar || 0), 0);
  const topOdeme = topMaas + topKasa + topIade;

  const islemHTML = islemler.length === 0
    ? `<div style="text-align:center;padding:32px;color:var(--text3)">HenÃ¼z iÅŸlem kaydÄ± yok</div>`
    : islemler.map(i => {
        const tipRenk = i.tip === 'maas' ? 'var(--blue)' : i.tip === 'kasa' ? 'var(--orange)' : 'var(--green)';
        const tipIkon = i.tip === 'maas' ? 'ğŸ’°' : i.tip === 'kasa' ? 'ğŸ’µ' : 'ğŸ§¾';
        const tipAd = i.tip === 'maas' ? 'MaaÅŸ' : i.tip === 'kasa' ? 'Masraf KasasÄ±' : 'Masraf Ä°adesi';
        return `<div style="display:flex;gap:12px;align-items:flex-start;padding:12px 16px;border-bottom:1px solid var(--border2)">
          <div style="width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;background:rgba(0,0,0,.06)">${tipIkon}</div>
          <div style="flex:1;min-width:0">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:3px">
              <span style="font-size:11px;font-weight:700;color:${tipRenk};background:rgba(0,0,0,.05);padding:1px 7px;border-radius:4px">${tipAd}</span>
              ${i.donem ? `<span style="font-size:11px;color:var(--text3)">${esc(i.donem)}</span>` : ''}
              ${i.hdYansitildi ? '<span style="font-size:10px;color:var(--blue)">ğŸ“’ HD</span>' : ''}
            </div>
            <div style="font-size:13px;font-weight:600;margin-bottom:3px">${esc(i.aciklama || tipAd)}</div>
            <div style="display:flex;gap:12px;font-size:11px;color:var(--text3)">
              <span>ğŸ“… ${fmtDate(i.tarih)}</span>
              <span>ğŸ’³ ${esc(i.yontem || 'â€”')}</span>
              ${i.fisNo ? `<span>ğŸ§¾ ${esc(i.fisNo)}</span>` : ''}
            </div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-weight:700;font-family:var(--mono);font-size:15px;color:${tipRenk}">${fmt(i.tutar)}</div>
            <div style="display:flex;gap:4px;justify-content:flex-end;margin-top:4px">
              <button class="btn-icon btn-sm" onclick="editPersonelIslem('${personelId}','${i.id}')" title="DÃ¼zenle" style="font-size:13px">âœ</button>
              <button class="btn-icon btn-sm" onclick="deletePersonelIslem('${personelId}','${i.id}')" title="Sil" style="color:var(--red);font-size:13px">ğŸ—‘</button>
            </div>
          </div>
        </div>`;
      }).join('');

  el.innerHTML = `<div>
    <!-- BaÅŸlÄ±k KartÄ± -->
    <div class="card" style="margin-bottom:14px">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px">
        <div style="flex:1">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
            <div style="font-size:22px;font-weight:800">${esc(p.ad)}</div>
            ${p.pozisyon ? `<span style="font-size:11px;background:var(--surface2);padding:3px 8px;border-radius:6px;color:var(--text2)">${esc(p.pozisyon)}</span>` : ''}
            ${p.pasif ? '<span style="font-size:11px;background:rgba(227,179,65,.15);color:var(--yellow);padding:3px 8px;border-radius:6px">Pasif</span>' : ''}
          </div>
          <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:12px;color:var(--text3)">
            ${p.tel ? `<span>ğŸ“ ${esc(p.tel)}</span>` : ''}
            ${p.hedefMaas ? `<span>ğŸ’° Hedef: ${fmt(p.hedefMaas)} TL/ay</span>` : ''}
            ${p.baslama ? `<span>ğŸ“… BaÅŸlama: ${fmtDate(p.baslama)}</span>` : ''}
          </div>
          ${p.not ? `<div style="margin-top:6px;font-size:12px;color:var(--text2);font-style:italic">${esc(p.not)}</div>` : ''}
        </div>
        <div style="display:flex;gap:6px;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn btn-secondary btn-sm" onclick="openPersonelModal('${p.id}')">âœ DÃ¼zenle</button>
          <button class="btn btn-secondary btn-sm" onclick="personelDetayExcel('${p.id}')">ğŸ“¥ Excel</button>
          <button class="btn btn-primary" onclick="openPersonelIslemModal('${p.id}')">+ Ä°ÅŸlem Ekle</button>
        </div>
      </div>

      <!-- Ã–zet KartlarÄ± -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:16px">
        <div style="padding:10px;background:var(--surface2);border-radius:var(--r8);text-align:center">
          <div style="font-size:10px;color:var(--text3);margin-bottom:4px">Toplam Ã–deme</div>
          <div style="font-weight:700;color:var(--blue);font-family:var(--mono)">${fmt(topOdeme)}</div>
        </div>
        <div style="padding:10px;background:var(--surface2);border-radius:var(--r8);text-align:center">
          <div style="font-size:10px;color:var(--text3);margin-bottom:4px">MaaÅŸ</div>
          <div style="font-weight:700;color:var(--blue);font-family:var(--mono)">${fmt(topMaas)}</div>
        </div>
        <div style="padding:10px;background:var(--surface2);border-radius:var(--r8);text-align:center">
          <div style="font-size:10px;color:var(--text3);margin-bottom:4px">Masraf KasasÄ±</div>
          <div style="font-weight:700;color:var(--orange);font-family:var(--mono)">${fmt(topKasa)}</div>
        </div>
        <div style="padding:10px;background:var(--surface2);border-radius:var(--r8);text-align:center">
          <div style="font-size:10px;color:var(--text3);margin-bottom:4px">Masraf Ä°adesi</div>
          <div style="font-weight:700;color:var(--green);font-family:var(--mono)">${fmt(topIade)}</div>
        </div>
      </div>
    </div>

    <!-- Ä°ÅŸlem GeÃ§miÅŸi -->
    <div class="card" style="padding:0">
      <div style="padding:12px 16px;border-bottom:1px solid var(--border2);display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:700">Ä°ÅŸlem GeÃ§miÅŸi</div>
        <span class="badge badge-blue">${islemler.length} kayÄ±t</span>
      </div>
      ${islemHTML}
    </div>
  </div>`;
}

// â”€â”€ PERSONEL EKLE/DÃœZENLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPersonelModal(personelId = null) {
  const p = personelId ? (DB.personeller || []).find(x => x.id === personelId) : null;
  document.getElementById('modal-personel-title').textContent = p ? 'âœ Personel DÃ¼zenle' : 'ğŸ‘¥ Personel Ekle';
  document.getElementById('f-prs-ad').value = p?.ad || '';
  document.getElementById('f-prs-pozisyon').value = p?.pozisyon || '';
  document.getElementById('f-prs-tel').value = p?.tel || '';
  document.getElementById('f-prs-maas').value = p?.hedefMaas || '';
  document.getElementById('f-prs-baslama').value = p?.baslama || today();
  document.getElementById('f-prs-not').value = p?.not || '';
  document.getElementById('f-prs-pasif').checked = p?.pasif || false;
  document.getElementById('prs-durum-row').style.display = p ? 'block' : 'none';
  document.getElementById('modal-personel')._editId = personelId;
  openModal('modal-personel');
  setTimeout(() => document.getElementById('f-prs-ad').focus(), 100);
}

function savePersonel() {
  const ad = document.getElementById('f-prs-ad').value.trim();
  if (!ad) { toast('Ad Soyad zorunlu', 'error'); return; }
  const editId = document.getElementById('modal-personel')._editId;
  const obj = {
    ad,
    pozisyon: document.getElementById('f-prs-pozisyon').value.trim(),
    tel: document.getElementById('f-prs-tel').value.trim(),
    hedefMaas: parseFloat(document.getElementById('f-prs-maas').value) || 0,
    baslama: document.getElementById('f-prs-baslama').value,
    not: document.getElementById('f-prs-not').value.trim(),
    pasif: document.getElementById('f-prs-pasif').checked
  };
  if (editId) {
    const idx = (DB.personeller || []).findIndex(x => x.id === editId);
    if (idx >= 0) DB.personeller[idx] = { ...DB.personeller[idx], ...obj };
    toast('Personel gÃ¼ncellendi', 'success');
  } else {
    obj.id = crypto.randomUUID ? crypto.randomUUID() : Date.now() + '';
    obj.eklenme = today();
    if (!DB.personeller) DB.personeller = [];
    DB.personeller.push(obj);
    secilenPersonelId = obj.id;
    toast('Personel eklendi', 'success');
  }
  saveDB();
  closeModal('modal-personel');
  renderPersonel();
}

// â”€â”€ Ä°ÅLEM EKLE/DÃœZENLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPersonelIslemModal(personelId, islemId = null) {
  const islem = islemId ? (DB.personelIslemler || []).find(i => i.id === islemId) : null;
  const p = (DB.personeller || []).find(x => x.id === personelId);
  document.getElementById('modal-personel-islem-title').textContent =
    (islem ? 'âœ Ä°ÅŸlem DÃ¼zenle' : '+ Ä°ÅŸlem Ekle') + (p ? ' â€” ' + p.ad : '');
  document.getElementById('f-pi-personel-id').value = personelId;
  document.getElementById('f-pi-id').value = islemId || '';
  document.querySelector(`input[name="pi-tip"][value="${islem?.tip || 'maas'}"]`).checked = true;
  document.getElementById('f-pi-tutar').value = islem?.tutar || '';
  document.getElementById('f-pi-tarih').value = islem?.tarih || today();
  document.getElementById('f-pi-yontem').value = islem?.yontem || 'Nakit';
  document.getElementById('f-pi-donem').value = islem?.donem || '';
  document.getElementById('f-pi-aciklama').value = islem?.aciklama || '';
  document.getElementById('f-pi-fis').value = islem?.fisNo || '';
  document.getElementById('f-pi-hd').checked = islem ? (islem.hdYansitildi || false) : true;
  piTipChange();
  openModal('modal-personel-islem');
  setTimeout(() => document.getElementById('f-pi-tutar').focus(), 100);
}

function editPersonelIslem(personelId, islemId) {
  openPersonelIslemModal(personelId, islemId);
}

function piTipChange() {
  const tip = document.querySelector('input[name="pi-tip"]:checked')?.value || 'maas';
  document.getElementById('pi-donem-row').style.display = tip === 'maas' ? 'block' : 'none';
  document.getElementById('pi-fis-row').style.display = tip === 'iade' ? 'block' : 'none';
  const hdPreview = document.getElementById('pi-hd-preview');
  if (tip === 'maas') hdPreview.textContent = 'Personel: MaaÅŸ kategorisiyle gider oluÅŸturulacak';
  else if (tip === 'kasa') hdPreview.textContent = 'Personel: Masraf AvansÄ± kategorisiyle gider oluÅŸturulacak';
  else hdPreview.textContent = 'Personel: Masraf Ä°adesi kategorisiyle gider oluÅŸturulacak';
  // Stil gÃ¼ncellemesi
  ['maas','kasa','iade'].forEach(t => {
    const lbl = document.getElementById('lbl-pi-' + t);
    if (lbl) lbl.style.borderColor = t === tip ? 'var(--blue)' : 'var(--border)';
  });
}

function savePersonelIslem() {
  const personelId = document.getElementById('f-pi-personel-id').value;
  const islemId = document.getElementById('f-pi-id').value;
  const tip = document.querySelector('input[name="pi-tip"]:checked')?.value || 'maas';
  const tutar = parseFloat(document.getElementById('f-pi-tutar').value) || 0;
  const tarih = document.getElementById('f-pi-tarih').value;

  if (!tutar || tutar <= 0) { toast('Tutar zorunlu', 'error'); return; }
  if (tutar < 0) { toast('Tutar negatif olamaz', 'error'); return; }
  if (!tarih) { toast('Tarih zorunlu', 'error'); return; }

  const p = (DB.personeller || []).find(x => x.id === personelId);
  const tipAd = tip === 'maas' ? 'MaaÅŸ' : tip === 'kasa' ? 'Masraf AvansÄ±' : 'Masraf Ä°adesi';
  const hdKat = tip === 'maas' ? 'Personel: MaaÅŸ' : tip === 'kasa' ? 'Personel: Masraf AvansÄ±' : 'Personel: Masraf Ä°adesi';
  const hdYansit = document.getElementById('f-pi-hd').checked;

  const obj = {
    id: islemId || (crypto.randomUUID ? crypto.randomUUID() : Date.now() + ''),
    personelId,
    tip,
    tutar,
    tarih,
    yontem: document.getElementById('f-pi-yontem').value,
    donem: document.getElementById('f-pi-donem').value.trim(),
    aciklama: document.getElementById('f-pi-aciklama').value.trim() || (p?.ad + ' â€” ' + tipAd),
    fisNo: document.getElementById('f-pi-fis').value.trim(),
    hdYansitildi: hdYansit,
    olusturma: Date.now()
  };

  if (!DB.personelIslemler) DB.personelIslemler = [];

  if (islemId) {
    // DÃ¼zenleme â€” eski HD kaydÄ±nÄ± sil
    const eski = DB.personelIslemler.find(i => i.id === islemId);
    if (eski?.hdKaynakId) {
      DB.hesapDefteri = (DB.hesapDefteri || []).filter(h => h.id !== eski.hdKaynakId);
    }
    const idx = DB.personelIslemler.findIndex(i => i.id === islemId);
    if (idx >= 0) DB.personelIslemler[idx] = obj;
    toast('Ä°ÅŸlem gÃ¼ncellendi', 'success');
  } else {
    DB.personelIslemler.push(obj);
    toast('Ä°ÅŸlem kaydedildi', 'success');
  }

  // HD'ye yansÄ±t
  if (hdYansit) {
    const hdId = 'prs_' + obj.id;
    obj.hdKaynakId = hdId;
    if (!DB.hesapDefteri) DB.hesapDefteri = [];
    DB.hesapDefteri.push({
      id: hdId,
      tarih,
      tip: 'gider',
      tutar,
      kategori: hdKat,
      aciklama: obj.aciklama,
      kaynakId: obj.id
    });
  }

  saveDB();
  closeModal('modal-personel-islem');
  renderPersonel();
  renderPersonelDetay(personelId);
}

async function deletePersonelIslem(personelId, islemId) {
  const islem = (DB.personelIslemler || []).find(i => i.id === islemId);
  if (!islem) return;
  const ok = await customConfirm(
    `Bu iÅŸlem kaydÄ± silinsin mi?\n${esc(islem.aciklama)} â€” ${fmt(islem.tutar)} TL`,
    'Ä°ÅŸlem Sil', 'ğŸ—‘ Sil', true
  );
  if (!ok) return;
  // BaÄŸlÄ± HD kaydÄ±nÄ± sil
  if (islem.hdKaynakId) {
    DB.hesapDefteri = (DB.hesapDefteri || []).filter(h => h.id !== islem.hdKaynakId);
  }
  DB.personelIslemler = DB.personelIslemler.filter(i => i.id !== islemId);
  saveDB();
  renderPersonel();
  renderPersonelDetay(personelId);
  toast('Ä°ÅŸlem silindi');
}

// â”€â”€ EXCEL EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openPersonelExportModal() {
  const sel = document.getElementById('prs-exp-personel');
  sel.innerHTML = '<option value="">TÃ¼m Ã‡alÄ±ÅŸanlar (Genel Ã–zet)</option>' +
    (DB.personeller || []).filter(p => !p.pasif).map(p =>
      `<option value="${p.id}">${esc(p.ad)}</option>`
    ).join('');
  const now = new Date();
  document.getElementById('prs-exp-bas').value = `${now.getFullYear()}-01-01`;
  document.getElementById('prs-exp-bit').value = today();
  openModal('modal-personel-export');
}

function personelDetayExcel(personelId) {
  // Direkt kiÅŸi bazlÄ± export â€” modal'Ä± seÃ§ili aÃ§ar
  openPersonelExportModal();
  setTimeout(() => {
    document.getElementById('prs-exp-personel').value = personelId;
  }, 50);
}

function personelExportExcel() {
  if (typeof XLSX === 'undefined') { toast('Excel kÃ¼tÃ¼phanesi yÃ¼klenmedi', 'error'); return; }

  const personelId = document.getElementById('prs-exp-personel').value;
  const bas = document.getElementById('prs-exp-bas').value;
  const bit = document.getElementById('prs-exp-bit').value;
  const inclMaas = document.getElementById('prs-exp-maas').checked;
  const inclKasa = document.getElementById('prs-exp-kasa').checked;
  const inclIade = document.getElementById('prs-exp-iade').checked;
  const fn = v => typeof v === 'number' ? parseFloat(v.toFixed(2)) : v;

  let islemler = (DB.personelIslemler || []).filter(i => {
    if (bas && i.tarih < bas) return false;
    if (bit && i.tarih > bit) return false;
    if (!inclMaas && i.tip === 'maas') return false;
    if (!inclKasa && i.tip === 'kasa') return false;
    if (!inclIade && i.tip === 'iade') return false;
    return true;
  });

  const wb = XLSX.utils.book_new();
  const tipAd = t => t === 'maas' ? 'MaaÅŸ' : t === 'kasa' ? 'Masraf KasasÄ±' : 'Masraf Ä°adesi';

  if (personelId) {
    // Tek kiÅŸi detay
    const p = (DB.personeller || []).find(x => x.id === personelId);
    const pIslemler = islemler.filter(i => i.personelId === personelId)
      .sort((a, b) => a.tarih.localeCompare(b.tarih));

    const rows = [['Tarih', 'Ä°ÅŸlem Tipi', 'DÃ¶nem', 'AÃ§Ä±klama', 'Ã–deme YÃ¶ntemi', 'FiÅŸ No', 'Tutar (â‚º)']];
    pIslemler.forEach(i => {
      rows.push([i.tarih, tipAd(i.tip), i.donem || '', i.aciklama || '', i.yontem || '', i.fisNo || '', fn(i.tutar)]);
    });
    const topMaas = pIslemler.filter(i => i.tip === 'maas').reduce((s, i) => s + i.tutar, 0);
    const topKasa = pIslemler.filter(i => i.tip === 'kasa').reduce((s, i) => s + i.tutar, 0);
    const topIade = pIslemler.filter(i => i.tip === 'iade').reduce((s, i) => s + i.tutar, 0);
    rows.push([]);
    rows.push(['', '', '', '', 'Toplam MaaÅŸ', '', fn(topMaas)]);
    rows.push(['', '', '', '', 'Toplam Masraf KasasÄ±', '', fn(topKasa)]);
    rows.push(['', '', '', '', 'Toplam Masraf Ä°adesi', '', fn(topIade)]);
    rows.push(['', '', '', '', 'GENEL TOPLAM', '', fn(topMaas + topKasa + topIade)]);

    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [10,18,14,30,14,12,14].map(w => ({ wch: w }));
    XLSX.utils.book_append_sheet(wb, ws, (p?.ad || 'Personel').slice(0, 31));
  } else {
    // Genel Ã¶zet â€” tÃ¼m personel
    const ozet = [['Ad Soyad', 'Pozisyon', 'Toplam MaaÅŸ (â‚º)', 'Masraf KasasÄ± (â‚º)', 'Masraf Ä°adesi (â‚º)', 'Genel Toplam (â‚º)']];
    (DB.personeller || []).forEach(p => {
      const pI = islemler.filter(i => i.personelId === p.id);
      const m = pI.filter(i => i.tip === 'maas').reduce((s, i) => s + i.tutar, 0);
      const k = pI.filter(i => i.tip === 'kasa').reduce((s, i) => s + i.tutar, 0);
      const ia = pI.filter(i => i.tip === 'iade').reduce((s, i) => s + i.tutar, 0);
      ozet.push([p.ad, p.pozisyon || '', fn(m), fn(k), fn(ia), fn(m + k + ia)]);
    });
    const wsOzet = XLSX.utils.aoa_to_sheet(ozet);
    wsOzet['!cols'] = [22, 16, 18, 18, 18, 18].map(w => ({ wch: w }));
    XLSX.utils.book_append_sheet(wb, wsOzet, 'Personel Ã–zet');

    // Her personel iÃ§in ayrÄ± sekme
    (DB.personeller || []).forEach(p => {
      const pIslemler = islemler.filter(i => i.personelId === p.id)
        .sort((a, b) => a.tarih.localeCompare(b.tarih));
      if (pIslemler.length === 0) return;
      const rows = [['Tarih', 'Ä°ÅŸlem Tipi', 'DÃ¶nem', 'AÃ§Ä±klama', 'YÃ¶ntem', 'Tutar (â‚º)']];
      pIslemler.forEach(i => {
        rows.push([i.tarih, tipAd(i.tip), i.donem || '', i.aciklama || '', i.yontem || '', fn(i.tutar)]);
      });
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws['!cols'] = [10, 18, 14, 30, 12, 14].map(w => ({ wch: w }));
      XLSX.utils.book_append_sheet(wb, ws, p.ad.slice(0, 31));
    });
  }

  const fileName = personelId
    ? `personel_${((DB.personeller||[]).find(p=>p.id===personelId)?.ad||'calisĞ°Ğ½').replace(/\s+/g,'_')}_${today()}.xlsx`
    : `personel_genel_${today()}.xlsx`;

  XLSX.writeFile(wb, fileName);
  closeModal('modal-personel-export');
  toast('Excel indirildi', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VÄ°RMAN SÄ°STEMÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * openVirmanModal('musteri', odemeId)  â€” MÃ¼ÅŸteri â†’ Firma virmani
 * openVirmanModal('firma', firmaId)    â€” Firma â†’ Firma virmani
 */
function openVirmanModal(tip, kaynakId) {
  document.getElementById('f-vrm-tip').value = tip;
  document.getElementById('f-vrm-kaynak-id').value = kaynakId;
  document.getElementById('f-vrm-tutar').value = '';
  document.getElementById('f-vrm-aciklama').value = '';
  document.getElementById('f-vrm-banka').value = '';
  document.getElementById('f-vrm-cek-no').value = '';
  document.getElementById('f-vrm-tarih').value = today();
  document.querySelector('input[name="vrm-yontem"][value="Nakit"]').checked = true;
  document.getElementById('vrm-banka-row').style.display = 'none';
  document.getElementById('vrm-cek-no-row').style.display = 'none';
  document.getElementById('vrm-ozet').style.display = 'none';
  document.getElementById('vrm-tutar-hint').textContent = '';

  // Hedef firma listesini doldur (kaynak firma hariÃ§)
  const kaynakFirmaId = tip === 'firma' ? kaynakId : null;
  const firmalar = (DB.cariFirmalar || []).filter(f => !f.arsivlendi && f.id !== kaynakFirmaId);
  const hedefSel = document.getElementById('f-vrm-hedef-firma');
  hedefSel.innerHTML = '<option value="">â€” Firma SeÃ§ â€”</option>' +
    firmalar.map(f => `<option value="${f.id}">${esc(f.ad)}</option>`).join('');

  // Bilgi kutusunu doldur
  const infoBox = document.getElementById('vrm-info-box');
  if (tip === 'musteri') {
    const odeme = (DB.odemeler || []).find(o => o.id === kaynakId);
    if (!odeme) { toast('Ã–deme bulunamadÄ±', 'error'); return; }
    const mevcutVirman = (DB.virmanlar || [])
      .filter(v => v.kaynakOdemeId === kaynakId)
      .reduce((s, v) => s + (v.tutar || 0), 0);
    const kalanVirmanlanabilir = (odeme.kalan || 0);
    infoBox.innerHTML = `
      <div style="font-weight:700;margin-bottom:6px">ğŸ‘¤ MÃ¼ÅŸteri: ${esc(odeme.musteri || '?')}</div>
      <div style="display:flex;gap:16px;flex-wrap:wrap">
        <span>Toplam: <strong>${fmt(odeme.tutar)}</strong></span>
        <span>Ã–denen: <strong style="color:var(--green)">${fmt(odeme.toplamOdenen || 0)}</strong></span>
        <span>Kalan: <strong style="color:var(--red)">${fmt(odeme.kalan || 0)}</strong></span>
        ${mevcutVirman > 0 ? `<span>Ã–nceki Virman: <strong style="color:var(--purple)">${fmt(mevcutVirman)}</strong></span>` : ''}
      </div>
      <div style="margin-top:6px;font-size:11px;color:var(--text3)">
        Virman tutarÄ± mÃ¼ÅŸterinin kalan borcundan dÃ¼ÅŸÃ¼lÃ¼r ve hedef firmaya aktarÄ±lÄ±r.
      </div>`;
    document.getElementById('vrm-tutar-hint').textContent =
      `Maks. virmanlanabilir: ${fmt(kalanVirmanlanabilir)} TL`;
  } else {
    const firma = (DB.cariFirmalar || []).find(f => f.id === kaynakId);
    if (!firma) { toast('Firma bulunamadÄ±', 'error'); return; }
    const fHareketler = (DB.cariHareketler || []).filter(h => h.firmaId === kaynakId);
    const topBorc = fHareketler.filter(h => h.tip === 'borc').reduce((s, h) => s + (h.tutar || 0), 0);
    const topAlacak = fHareketler.filter(h => h.tip === 'alacak').reduce((s, h) => s + (h.tutar || 0), 0);
    const netBakiye = topAlacak - topBorc;
    infoBox.innerHTML = `
      <div style="font-weight:700;margin-bottom:6px">ğŸ¢ Kaynak Firma: ${esc(firma.ad)}</div>
      <div style="display:flex;gap:16px;flex-wrap:wrap">
        <span>Toplam BorÃ§: <strong style="color:var(--red)">${fmt(topBorc)}</strong></span>
        <span>Toplam Alacak: <strong style="color:var(--green)">${fmt(topAlacak)}</strong></span>
        <span>Net: <strong style="color:${netBakiye >= 0 ? 'var(--green)' : 'var(--red)'}">${fmt(netBakiye)}</strong></span>
      </div>
      <div style="margin-top:6px;font-size:11px;color:var(--text3)">
        Bu firmadan hedef firmaya para aktarÄ±mÄ±. Her iki firmanÄ±n bakiyesini etkiler.
      </div>`;
  }

  openModal('modal-virman');
  setTimeout(() => document.getElementById('f-vrm-tutar').focus(), 150);
}

function virmanYontemChange() {
  const yontem = document.querySelector('input[name="vrm-yontem"]:checked')?.value || 'Nakit';
  const bankaRow = document.getElementById('vrm-banka-row');
  const cekRow = document.getElementById('vrm-cek-no-row');
  if (yontem === 'Havale/EFT') {
    bankaRow.style.display = 'grid';
    cekRow.style.display = 'none';
  } else if (yontem === 'Ã‡ek') {
    bankaRow.style.display = 'grid';
    cekRow.style.display = 'block';
  } else {
    bankaRow.style.display = 'none';
    cekRow.style.display = 'none';
  }
  virmanTutarHint();
}

function virmanTutarHint() {
  const tip = document.getElementById('f-vrm-tip').value;
  const kaynakId = document.getElementById('f-vrm-kaynak-id').value;
  const tutar = parseFloat(document.getElementById('f-vrm-tutar').value) || 0;
  const hedefId = document.getElementById('f-vrm-hedef-firma').value;
  const ozet = document.getElementById('vrm-ozet');

  if (tip === 'musteri' && tutar > 0) {
    const odeme = (DB.odemeler || []).find(o => o.id === kaynakId);
    if (odeme && tutar > (odeme.kalan || 0)) {
      document.getElementById('vrm-tutar-hint').innerHTML =
        `<span style="color:var(--red)">âš  Kalan borÃ§tan (${fmt(odeme.kalan)}) fazla olamaz</span>`;
    } else {
      document.getElementById('vrm-tutar-hint').textContent = '';
    }
  }

  if (tutar > 0 && hedefId) {
    const hedefFirma = (DB.cariFirmalar || []).find(f => f.id === hedefId);
    const yontem = document.querySelector('input[name="vrm-yontem"]:checked')?.value || 'Nakit';
    ozet.style.display = 'block';
    if (tip === 'musteri') {
      const odeme = (DB.odemeler || []).find(o => o.id === kaynakId);
      ozet.innerHTML = `
        <div style="font-weight:700;margin-bottom:8px;color:var(--purple)">â‡„ Virman Ã–zeti</div>
        <div>ğŸ“¤ <strong>${esc(odeme?.musteri || '?')}</strong> borcundan <strong>${fmt(tutar)}</strong> dÃ¼ÅŸÃ¼lÃ¼r</div>
        <div>ğŸ“¥ <strong>${esc(hedefFirma?.ad || '?')}</strong> hesabÄ±na <strong>${fmt(tutar)}</strong> aktarÄ±lÄ±r</div>
        <div style="margin-top:4px;font-size:11px;color:var(--text3)">Ã–deme yÃ¶ntemi: ${yontem}</div>`;
    } else {
      const kaynakFirma = (DB.cariFirmalar || []).find(f => f.id === kaynakId);
      ozet.innerHTML = `
        <div style="font-weight:700;margin-bottom:8px;color:var(--purple)">â‡„ Virman Ã–zeti</div>
        <div>ğŸ“¤ <strong>${esc(kaynakFirma?.ad || '?')}</strong> tarafÄ±ndan <strong>${fmt(tutar)}</strong> Ã¶denir</div>
        <div>ğŸ“¥ <strong>${esc(hedefFirma?.ad || '?')}</strong> hesabÄ±na <strong>${fmt(tutar)}</strong> alacak eklenir</div>
        <div style="margin-top:4px;font-size:11px;color:var(--text3)">Ã–deme yÃ¶ntemi: ${yontem}</div>`;
    }
  } else {
    ozet.style.display = 'none';
  }
}

function saveVirman() {
  const tip = document.getElementById('f-vrm-tip').value;
  const kaynakId = document.getElementById('f-vrm-kaynak-id').value;
  const hedefFirmaId = document.getElementById('f-vrm-hedef-firma').value;
  const tutar = parseFloat(document.getElementById('f-vrm-tutar').value) || 0;
  const tarih = document.getElementById('f-vrm-tarih').value;
  const odemeYontemi = document.querySelector('input[name="vrm-yontem"]:checked')?.value || 'Nakit';
  const banka = document.getElementById('f-vrm-banka').value.trim();
  const cekNo = document.getElementById('f-vrm-cek-no').value.trim();
  const aciklama = document.getElementById('f-vrm-aciklama').value.trim();

  // Validasyon
  if (!hedefFirmaId) { toast('Hedef firma seÃ§ilmedi', 'error'); return; }
  if (!tutar || tutar <= 0) { toast('Tutar zorunlu', 'error'); return; }
  if (!tarih) { toast('Tarih zorunlu', 'error'); return; }

  const hedefFirma = (DB.cariFirmalar || []).find(f => f.id === hedefFirmaId);
  if (!hedefFirma) { toast('Hedef firma bulunamadÄ±', 'error'); return; }

  if (tip === 'musteri') {
    const odeme = (DB.odemeler || []).find(o => o.id === kaynakId);
    if (!odeme) { toast('Ã–deme kaydÄ± bulunamadÄ±', 'error'); return; }
    if (tutar > (odeme.kalan || 0)) {
      toast(`Tutar, kalan borÃ§tan (${fmt(odeme.kalan)}) fazla olamaz`, 'error'); return;
    }

    // Virman kaydÄ±nÄ± oluÅŸtur
    const vrm = {
      id: crypto.randomUUID ? crypto.randomUUID() : Date.now() + '',
      tip: 'musteri_firma',
      tarih,
      kaynakTip: 'musteri',
      kaynakId: odeme.id,
      kaynakAd: odeme.musteri || '',
      hedefFirmaId,
      hedefFirmaAd: hedefFirma.ad,
      tutar,
      odemeYontemi,
      banka,
      cekNo,
      aciklama: aciklama || `${odeme.musteri} â†’ ${hedefFirma.ad} virmanÄ±`,
      kaynakOdemeId: odeme.id,
      olusturma: Date.now()
    };

    if (!DB.virmanlar) DB.virmanlar = [];
    DB.virmanlar.push(vrm);

    // Ã–deme kalanÄ±nÄ± gÃ¼ncelle
    const odemeIdx = DB.odemeler.findIndex(o => o.id === kaynakId);
    if (odemeIdx >= 0) {
      DB.odemeler[odemeIdx].kalan = Math.max(0, (DB.odemeler[odemeIdx].kalan || 0) - tutar);
      DB.odemeler[odemeIdx].toplamOdenen = (DB.odemeler[odemeIdx].toplamOdenen || 0) + tutar;
      if (DB.odemeler[odemeIdx].kalan <= 0) DB.odemeler[odemeIdx].durum = 'odendi';
    }

    // Hedef firmaya cari hareket ekle (alacak â€” bize olan borÃ§ azaldÄ±)
    if (!DB.cariHareketler) DB.cariHareketler = [];
    DB.cariHareketler.push({
      id: 'vrm_' + vrm.id,
      firmaId: hedefFirmaId,
      tip: 'alacak',
      tutar,
      tarih,
      yontem: odemeYontemi + (banka ? ' / ' + banka : '') + (cekNo ? ' #' + cekNo : ''),
      aciklama: vrm.aciklama,
      belgeNo: cekNo || '',
      hdYansitildi: false,
      virmanId: vrm.id
    });

    saveDB();
    closeModal('modal-virman');
    renderAll();
    toast(`â‡„ Virman kaydedildi â€” ${fmt(tutar)} TL â†’ ${hedefFirma.ad}`, 'success');

  } else {
    // Firma â†’ Firma virmani
    const kaynakFirma = (DB.cariFirmalar || []).find(f => f.id === kaynakId);
    if (!kaynakFirma) { toast('Kaynak firma bulunamadÄ±', 'error'); return; }
    if (kaynakFirma.id === hedefFirmaId) { toast('Kaynak ve hedef firma aynÄ± olamaz', 'error'); return; }

    const vrm = {
      id: crypto.randomUUID ? crypto.randomUUID() : Date.now() + '',
      tip: 'firma_firma',
      tarih,
      kaynakTip: 'firma',
      kaynakId: kaynakFirma.id,
      kaynakAd: kaynakFirma.ad,
      hedefFirmaId,
      hedefFirmaAd: hedefFirma.ad,
      tutar,
      odemeYontemi,
      banka,
      cekNo,
      aciklama: aciklama || `${kaynakFirma.ad} â†’ ${hedefFirma.ad} virmanÄ±`,
      kaynakOdemeId: null,
      olusturma: Date.now()
    };

    if (!DB.virmanlar) DB.virmanlar = [];
    DB.virmanlar.push(vrm);

    // Kaynak firmada borÃ§ oluÅŸur (firmadan para Ã§Ä±ktÄ±)
    if (!DB.cariHareketler) DB.cariHareketler = [];
    DB.cariHareketler.push({
      id: 'vrm_k_' + vrm.id,
      firmaId: kaynakFirma.id,
      tip: 'borc',
      tutar,
      tarih,
      yontem: odemeYontemi + (banka ? ' / ' + banka : '') + (cekNo ? ' #' + cekNo : ''),
      aciklama: `â‡„ Virman: ${kaynakFirma.ad} â†’ ${hedefFirma.ad}`,
      belgeNo: cekNo || '',
      hdYansitildi: false,
      virmanId: vrm.id
    });

    // Hedef firmada alacak oluÅŸur (firmaya para geldi)
    DB.cariHareketler.push({
      id: 'vrm_h_' + vrm.id,
      firmaId: hedefFirmaId,
      tip: 'alacak',
      tutar,
      tarih,
      yontem: odemeYontemi + (banka ? ' / ' + banka : '') + (cekNo ? ' #' + cekNo : ''),
      aciklama: `â‡„ Virman: ${kaynakFirma.ad} â†’ ${hedefFirma.ad}`,
      belgeNo: cekNo || '',
      hdYansitildi: false,
      virmanId: vrm.id
    });

    saveDB();
    closeModal('modal-virman');
    renderAll();
    toast(`â‡„ Virman kaydedildi â€” ${fmt(tutar)} TL: ${kaynakFirma.ad} â†’ ${hedefFirma.ad}`, 'success');
  }
}

async function deleteVirman(virmanId) {
  const vrm = (DB.virmanlar || []).find(v => v.id === virmanId);
  if (!vrm) return;
  const ok = await customConfirm(
    `Bu virman kaydÄ± silinsin mi?\n${esc(vrm.aciklama)} â€” ${fmt(vrm.tutar)} TL`,
    'VirmanÄ± Sil', 'ğŸ—‘ Sil', true
  );
  if (!ok) return;

  // BaÄŸlÄ± cari hareketleri sil
  DB.cariHareketler = (DB.cariHareketler || []).filter(h => h.virmanId !== virmanId);

  // MÃ¼ÅŸteri Ã¶deme bakiyesini geri al
  if (vrm.tip === 'musteri_firma' && vrm.kaynakOdemeId) {
    const idx = (DB.odemeler || []).findIndex(o => o.id === vrm.kaynakOdemeId);
    if (idx >= 0) {
      DB.odemeler[idx].kalan = (DB.odemeler[idx].kalan || 0) + vrm.tutar;
      DB.odemeler[idx].toplamOdenen = Math.max(0, (DB.odemeler[idx].toplamOdenen || 0) - vrm.tutar);
      if (DB.odemeler[idx].kalan > 0) DB.odemeler[idx].durum = 'bekliyor';
    }
  }

  DB.virmanlar = DB.virmanlar.filter(v => v.id !== virmanId);
  saveDB();
  renderAll();
  toast('Virman kaydÄ± silindi');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Eksik alanlarÄ± tamamla (migration)
function _migrateDB(){
  if(!DB.widgets)          DB.widgets          = DEFAULT_DATA.widgets;
  if(!DB.tanimlar)         DB.tanimlar         = DEFAULT_DATA.tanimlar;
  if(!DB.fiyatlar)         DB.fiyatlar         = {};
  if(!DB.ustaOdemeleri)    DB.ustaOdemeleri    = {};
  if(!DB.hesapDefteri)     DB.hesapDefteri     = [];
  if(!DB.giderKategorileri)DB.giderKategorileri= DEFAULT_DATA.giderKategorileri;
  if(!DB.cariFirmalar)     DB.cariFirmalar     = [];
  if(!DB.cariHareketler)   DB.cariHareketler   = [];
  if(!DB.virmanlar)        DB.virmanlar        = [];
  if(!DB.personeller)      DB.personeller      = [];
  if(!DB.personelIslemler) DB.personelIslemler = [];
  if(!DB.nextId){
    const ids = (DB.tadilatlar||[]).map(t=>t.id||0);
    DB.nextId = ids.length>0 ? Math.max(...ids)+1 : 1;
  }
}

async function loadDB(){
  DB = JSON.parse(JSON.stringify(DEFAULT_DATA));
  try {
    // TÃ¼m tablolarÄ± paralel Ã§ek
    const [
      { data: tadilatlar },
      { data: odemeler },
      { data: fiyatlarRow },
      { data: ustaOdRow },
      { data: hesapDefteri },
      { data: cariFirmalar },
      { data: cariHareketler },
      { data: virmanlar },
      { data: personeller },
      { data: personelIslemler },
      { data: tanimlarRow },
      { data: sayacRow }
    ] = await Promise.all([
      _supabase.from('tadilatlar').select('*').order('id'),
      _supabase.from('odemeler').select('*').order('id'),
      _supabase.from('fiyatlar').select('*').limit(1),
      _supabase.from('usta_odemeleri').select('*').limit(1),
      _supabase.from('hesap_defteri').select('*').order('tarih'),
      _supabase.from('cari_firmalar').select('*'),
      _supabase.from('cari_hareketler').select('*').order('tarih'),
      _supabase.from('virmanlar').select('*').order('tarih'),
      _supabase.from('personeller').select('*'),
      _supabase.from('personel_islemler').select('*').order('tarih'),
      _supabase.from('tanimlar').select('*').limit(1),
      _supabase.from('sayac').select('*').limit(1)
    ]);

    if (tadilatlar)       DB.tadilatlar       = tadilatlar;
    if (odemeler)         DB.odemeler         = odemeler;
    if (fiyatlarRow?.length)   DB.fiyatlar    = fiyatlarRow[0].data;
    if (ustaOdRow?.length)     DB.ustaOdemeleri = ustaOdRow[0].data;
    if (hesapDefteri)     DB.hesapDefteri     = hesapDefteri;
    if (cariFirmalar)     DB.cariFirmalar     = cariFirmalar;
    if (cariHareketler)   DB.cariHareketler   = cariHareketler;
    if (virmanlar)        DB.virmanlar        = virmanlar;
    if (personeller)      DB.personeller      = personeller;
    if (personelIslemler) DB.personelIslemler = personelIslemler;
    if (tanimlarRow?.length)   DB.tanimlar    = tanimlarRow[0].data;
    if (sayacRow?.length)      DB.nextId      = sayacRow[0].nextId;

    _migrateDB();
    const szEl = document.getElementById('storage-size-indicator');
    if(szEl){ szEl.textContent = 'â˜ Supabase'; szEl.style.color = 'var(--green)'; }
  } catch(e) {
    console.error('loadDB hatasÄ±:', e);
    toast('Veri yÃ¼klenirken hata: ' + e.message, 'error');
  }
}

// â”€â”€ CACHE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _hakedisCache = {};
let _odenenCache = {};
// TÃ¼m cache'i temizle (genel)
function invalidateCache(usta){ 
  if(usta){
    delete _hakedisCache[usta];
    delete _odenenCache[usta];
  } else {
    _hakedisCache = {}; 
    _odenenCache = {};
  }
}

function ustaHakedisCal(usta){
  if(_hakedisCache[usta] !== undefined) return _hakedisCache[usta];
  const val = DB.tadilatlar
    .filter(t=>!t.arsiv && (t.ustalar||[{usta:t.usta}]).some(u=>u.usta===usta))
    .reduce((s,t)=>{
      const uIsler=(t.ustalar||[{usta:t.usta,isTipi:t.isTipi,fiyat:0}]).filter(u=>u.usta===usta);
      return s+uIsler.reduce((ss,u)=>ss+(u.fiyat||getFiyat(usta,u.isTipi)||0),0);
    },0);
  _hakedisCache[usta] = val;
  return val;
}

// â”€â”€ DEBOUNCED SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _saveTimer = null;
function saveDB(){
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(()=>{ _doSave(); }, 600); // 300â†’600ms: daha az disk yazma
}

async function _doSave(){
  if(_fsReady && _fsHandle){
    _fsWriteNow();
    return;
  }
  // Supabase'e kaydet
  try {
    // Basit tablolar â€” upsert
    if(DB.tadilatlar?.length) {
      await _supabase.from('tadilatlar').upsert(DB.tadilatlar, {onConflict:'id'});
    }
    if(DB.odemeler?.length) {
      await _supabase.from('odemeler').upsert(DB.odemeler, {onConflict:'id'});
    }
    if(DB.hesapDefteri?.length) {
      await _supabase.from('hesap_defteri').upsert(DB.hesapDefteri, {onConflict:'id'});
    }
    if(DB.cariFirmalar?.length) {
      await _supabase.from('cari_firmalar').upsert(DB.cariFirmalar, {onConflict:'id'});
    }
    if(DB.cariHareketler?.length) {
      await _supabase.from('cari_hareketler').upsert(DB.cariHareketler, {onConflict:'id'});
    }
    if(DB.virmanlar?.length) {
      await _supabase.from('virmanlar').upsert(DB.virmanlar, {onConflict:'id'});
    }
    if(DB.personeller?.length) {
      await _supabase.from('personeller').upsert(DB.personeller, {onConflict:'id'});
    }
    if(DB.personelIslemler?.length) {
      await _supabase.from('personel_islemler').upsert(DB.personelIslemler, {onConflict:'id'});
    }
    // JSON blob tablolar
    await _supabase.from('tanimlar').upsert([{id: '00000000-0000-0000-0000-000000000001', data: DB.tanimlar}], {onConflict:'id'});
    await _supabase.from('fiyatlar').upsert([{id: '00000000-0000-0000-0000-000000000001', data: DB.fiyatlar}], {onConflict:'id'});
    await _supabase.from('usta_odemeleri').upsert([{id: '00000000-0000-0000-0000-000000000001', data: DB.ustaOdemeleri}], {onConflict:'id'});
    // Sayac
    await _supabase.from('sayac').update({nextId: DB.nextId}).gt('id','00000000-0000-0000-0000-000000000000');
    const szEl = document.getElementById('storage-size-indicator');
    if(szEl){ szEl.textContent = 'â˜ Kaydedildi'; szEl.style.color = 'var(--green)'; }
  } catch(e) {
    console.error('saveDB hatasÄ±:', e);
    toast('KayÄ±t hatasÄ±: ' + e.message, 'error');
  }
}

function saveDBNow(){
  clearTimeout(_saveTimer);
  _doSave();
}

function exportData(){
  const blob = new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `royal_yedek_${today()}.json`;
  a.click();
  localStorage.setItem('royal_son_yedek', today());
  updateYedekGostergesi();
  const msg = _fsReady
    ? 'Yedek indirildi âœ… (baÄŸlÄ± dosya zaten gÃ¼ncel)'
    : 'Veriler dÄ±ÅŸa aktarÄ±ldÄ± âœ… â€” gÃ¼venli bir yere kaydedin';
  toast(msg,'success');
}

function importData(){
  document.getElementById('import-file').click();
}

function handleImport(e){
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = async ev => {
    try{
      const parsed = JSON.parse(ev.target.result);
      if(!parsed.tadilatlar || !Array.isArray(parsed.tadilatlar)){
        toast('GeÃ§ersiz yedek dosyasÄ± â€” Royal Muhasebe yedeÄŸi deÄŸil','error');
        e.target.value=''; return;
      }
      const kayitSayisi = (DB.tadilatlar||[]).length + (DB.odemeler||[]).length;
      if(kayitSayisi>0){
        const ok = await customConfirm(
          'Mevcut '+kayitSayisi+' kayÄ±t silinip yedeÄŸiniz yÃ¼klenecek. Bu iÅŸlem geri alÄ±namaz. Devam edilsin mi?',
          'Veri Ä°Ã§e Aktar', 'â¬† YÃ¼kle', true
        );
        if(!ok){ e.target.value=''; return; }
      }
      DB = parsed;
      _migrateDB();
      saveDB(); renderAll();
      toast('Veriler baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±','success');
      if(_fsReady) toast('ğŸ’¾ Veriler baÄŸlÄ± dosyaya da kaydedildi','info');
    }catch(err){ toast('Dosya okunamadÄ± â€” geÃ§erli bir JSON dosyasÄ± seÃ§in','error'); }
  };
  reader.readAsText(file);
  e.target.value='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function today(){ return new Date().toISOString().slice(0,10); }

// XSS korumasÄ± - kullanÄ±cÄ± girdilerini innerHTML'e yerleÅŸtirmeden Ã¶nce temizle
const _escapeDiv = document.createElement('div');
function esc(str){
  if(str == null) return '';
  _escapeDiv.textContent = String(str);
  return _escapeDiv.innerHTML;
}


const _fmtNum = new Intl.NumberFormat('tr-TR');
const _fmtNum2 = new Intl.NumberFormat('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
function fmt(n){ return _fmtNum.format(n||0)+'â‚º'; }
function fmtN(n){ return _fmtNum2.format(n||0); }

const _fmtDateCache = {};
function fmtDate(d){
  if(!d) return 'â€”';
  if(_fmtDateCache[d]) return _fmtDateCache[d];
  try{
    // Fast path: YYYY-MM-DD format
    if(/^\d{4}-\d{2}-\d{2}$/.test(d)){
      const [y,m,dy] = d.split('-');
      const r = `${parseInt(dy)}.${parseInt(m)}.${y}`;
      _fmtDateCache[d] = r; return r;
    }
    const r = new Date(d).toLocaleDateString('tr-TR');
    _fmtDateCache[d] = r; return r;
  } catch(e){ return d; }
}

function diffDays(d){
  if(!d) return null;
  const diff = Math.round((new Date(d)-new Date(today()))/(1000*86400));
  return diff;
}

function durum2badge(d){
  const m = {'TamamlandÄ±':'green','Devam Ediyor':'yellow','Beklemede':'blue','Ä°ptal':'red'};
  return `<span class="badge badge-${m[d]||'gray'}">${d||'â€”'}</span>`;
}

function odemeBadge(d){
  const m = {'Ã–dendi':'green','Ã–denmedi':'red','KÄ±smi Ã–deme':'orange'};
  return `<span class="badge badge-${m[d]||'gray'}">${d||'â€”'}</span>`;
}

function vadeBadge(tarih, kalan){
  if(!tarih || kalan<=0) return '<span class="badge badge-green">âœ“ BorÃ§ Yok</span>';
  const d = diffDays(tarih);
  if(d===null) return 'â€”';
  if(d<0)  return `<span class="badge badge-red">ğŸ”´ ${Math.abs(d)}g gecikmiÅŸ</span>`;
  if(d===0)return `<span class="badge badge-orange">ğŸŸ  BugÃ¼n</span>`;
  if(d<=7) return `<span class="badge badge-yellow">ğŸŸ¡ ${d}g kaldÄ±</span>`;
  return `<span class="badge badge-blue">ğŸŸ¢ ${d}g kaldÄ±</span>`;
}

function getMusteri(isNo){
  const t = DB.tadilatlar.find(t=>t.id===Number(isNo));
  return t ? t.musteri : '';
}

function getFiyat(usta, isTipi){
  return DB.fiyatlar[usta]?.[isTipi] || 0;
}

const AYLAR = ["Ocak","Åubat","Mart","Nisan","MayÄ±s","Haziran",
               "Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];

function toast(msg, type='success'){
  const c = document.getElementById('toast-container');
  const d = document.createElement('div');
  d.className = `toast ${type}`;
  const icon = type==='success'?'âœ“' : type==='error'?'âœ•' : type==='warning'?'âš ' : 'â„¹';
  d.innerHTML = icon+' '+msg;
  // AynÄ± mesajdan Ã§ok sayÄ±da toast birikmesin
  const existing = [...c.children].find(el=>el.innerHTML===d.innerHTML);
  if(existing){ existing.remove(); }
  c.appendChild(d);
  const dur = type==='error' ? 5000 : 3000;
  setTimeout(()=>{ d.style.opacity='0'; setTimeout(()=>d.remove(),300); }, dur);
}

// â”€â”€ Ã–ZEL CONFIRM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _confirmResolve = null;
function customConfirm(msg, title='Onay', okLabel='Evet, Devam Et', danger=true){
  return new Promise(resolve=>{
    _confirmResolve = resolve;
    document.getElementById('confirm-msg').textContent = msg;
    document.getElementById('confirm-title').textContent = title;
    const btn = document.getElementById('confirm-ok-btn');
    btn.textContent = okLabel;
    btn.className = danger ? 'btn btn-danger' : 'btn btn-primary';
    document.getElementById('modal-confirm').classList.add('open');
  });
}
function confirmAccept(){
  document.getElementById('modal-confirm').classList.remove('open');
  if(_confirmResolve){ _confirmResolve(true); _confirmResolve=null; }
}
function confirmReject(){
  document.getElementById('modal-confirm').classList.remove('open');
  if(_confirmResolve){ _confirmResolve(false); _confirmResolve=null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pageConfig = {
  dashboard: {title:'Dashboard',sub:'Genel bakÄ±ÅŸ ve Ã¶zet'},
  tadilatlar: {title:'Ä°ÅŸ Emirleri',sub:'Ä°ÅŸ emirleri ve takip'},
  'tadilatlar-arsiv': {title:'Ä°ÅŸ Emri ArÅŸivi',sub:'ArÅŸivlenmiÅŸ iÅŸ emirleri'},
  odemeler: {title:'MÃ¼ÅŸteri Ã–demeleri',sub:'Ã–deme takibi'},
  'odemeler-arsiv': {title:'Ã–deme ArÅŸivi',sub:'ArÅŸivlenmiÅŸ Ã¶demeler'},
  ustalar: {title:'Usta Ã–demeleri',sub:'HakediÅŸ ve Ã¶deme'},
  'ustalar-arsiv': {title:'Usta Ã–deme ArÅŸivi',sub:'ArÅŸivlenmiÅŸ usta Ã¶demeleri'},
  aylik: {title:'AylÄ±k Ã–zet',sub:'12 aylÄ±k rapor'},
  vade: {title:'Vade Takibi',sub:'GecikmiÅŸ ve yaklaÅŸan Ã¶demeler'},
  'musteri-karti': {title:'MÃ¼ÅŸteri KartÄ±',sub:'MÃ¼ÅŸteri geÃ§miÅŸi ara'},
  'usta-programi': {title:'Usta ProgramÄ±',sub:'HaftalÄ±k iÅŸ daÄŸÄ±lÄ±mÄ±'},
  'hesap-defteri': {title:'Hesap Defteri',sub:'Gelir & gider takibi'},
  personel: {title:'Personel',sub:'MaaÅŸ, masraf ve Ã¶demeler'},
  cari: {title:'Cari Hesaplar',sub:'Firma bazlÄ± hesap takibi'},
  'fiyat-listesi': {title:'Usta Fiyat Listesi',sub:'Ä°ÅŸÃ§ilik Ã¼cretleri'},
  tanimlar: {title:'TanÄ±mlar',sub:'Liste yÃ¶netimi'}
};

// DOM cache â€” querySelectorAll her navigate'te Ã§alÄ±ÅŸmasÄ±n
let _navPageEls = null;
let _navItemEls = null;
let _navItemMap  = null;  // page -> nav-item el
let _activePage  = null;  // ÅŸu an aktif sayfa adÄ±

function navigate(page){
  if(page === _activePage) return; // AynÄ± sayfaya tÄ±klandÄ± â€” hiÃ§bir ÅŸey yapma

  // Ä°lk Ã§aÄŸrÄ±da DOM'u cache'le
  if(!_navPageEls){
    _navPageEls = Array.from(document.querySelectorAll('.page'));
    _navItemEls = Array.from(document.querySelectorAll('.nav-item'));
    _navItemMap = {};
    _navItemEls.forEach(el=>{
      const m = el.getAttribute('onclick')?.match(/navigate\('([^']+)'\)/);
      if(m) _navItemMap[m[1]] = el;
    });
  }

  // Eski sayfayÄ± gizle (tÃ¼m listeyi dÃ¶nme)
  if(_activePage){
    document.getElementById('page-'+_activePage)?.classList.remove('active');
    _navItemMap[_activePage]?.classList.remove('active');
  } else {
    // Ä°lk yÃ¼kleme â€” hepsini temizle
    _navPageEls.forEach(p=>p.classList.remove('active'));
    _navItemEls.forEach(n=>n.classList.remove('active'));
  }

  // Yeni sayfayÄ± gÃ¶ster
  const target = document.getElementById('page-'+page);
  if(target){ target.classList.add('active'); }
  _navItemMap[page]?.classList.add('active');
  _activePage = page;

  const cfg = pageConfig[page]||{};
  document.getElementById('topbar-title').textContent = cfg.title||page;
  document.getElementById('topbar-sub').textContent = cfg.sub||'';
  document.getElementById('sidebar')?.classList.remove('mobile-open');
  document.getElementById('sidebar-overlay')?.classList.remove('mobile-open');

  const ta = document.getElementById('topbar-actions');
  if(page==='tadilatlar'){
    ta.innerHTML=`<button class="btn btn-primary" onclick="openModal('modal-tad')">+ Yeni Ä°ÅŸ KaydÄ±</button>`;
  } else if(page==='odemeler'){
    ta.innerHTML=`<button class="btn btn-primary" onclick="openModal('modal-odm')">+ Yeni Ã–deme</button>`;
  } else {
    ta.innerHTML='';
  }

  const renders={
    dashboard:renderDashboard, tadilatlar:renderTadilatlar,
    odemeler:renderOdemeler, ustalar:renderUstalar,
    aylik:renderAylik, vade:renderVade,
    'musteri-karti':renderMusteriKarti,
    'usta-programi':renderUstaProgrami,
    'hesap-defteri':renderHesapDefteri,
    personel:renderPersonel,
    cari:renderCari,
    'fiyat-listesi':renderFiyatListesi,
    tanimlar:renderTanimlar
  };
  // rAF: sayfayÄ± Ã¶nce gÃ¶ster, sonra iÃ§eriÄŸi doldur â€” donma hissi ortadan kalkar
  if(renders[page]) requestAnimationFrame(()=>renders[page]());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){
  document.getElementById(id)?.classList.add('open');
  if(id==='modal-tad') initTadForm();
  if(id==='modal-odm') initOdmForm();
  if(id==='modal-hd'){
    document.getElementById('f-hd-tarih').value=today();
    document.getElementById('f-hd-tutar').value='';
    document.getElementById('f-hd-aciklama').value='';
    document.getElementById('f-hd-tip').value='gider';
    updateHdKategori();
  }
  if(id==='modal-hakkinda'){
    try{
      if(_fsReady && _fsHandle){
        // FS modunda storage-size-indicator'dan boyutu al (zaten gÃ¼ncelleniyor)
        const szEl = document.getElementById('storage-size-indicator');
        const boyutTxt = szEl ? szEl.textContent : 'â€”';
        document.getElementById('hakkinda-storage').textContent = boyutTxt + ' (dosya modu)';
      } else {
        const raw = localStorage.getItem(STORAGE_KEY)||'';
        const kb = (raw.length * 2 / 1024).toFixed(1);
        const pct = (raw.length * 2 / (5*1024*1024) * 100).toFixed(1);
        document.getElementById('hakkinda-storage').textContent = `${kb} KB / 5120 KB (%${pct})`;
      }
    } catch(e){ document.getElementById('hakkinda-storage').textContent = 'Bilinmiyor'; }
    const tadCount = DB.tadilatlar?.length||0;
    const tadArsiv = DB.tadilatlar?.filter(t=>t.arsiv).length||0;
    const odmCount = (DB.odemeler||[]).length;
    const odmArsiv = (DB.odemeler||[]).filter(o=>o.arsiv).length;
    const hdCount  = DB.hesapDefteri?.length||0;
    document.getElementById('hakkinda-records').textContent =
      (tadCount+odmCount+hdCount)+' toplam kayÄ±t ('+(tadArsiv+odmArsiv)+' arÅŸivde)';
    document.getElementById('hk-is').textContent  = tadCount-tadArsiv+' aktif / '+tadArsiv+' arÅŸiv';
    document.getElementById('hk-odm').textContent = odmCount-odmArsiv+' aktif / '+odmArsiv+' arÅŸiv';
    document.getElementById('hk-hd').textContent  = hdCount;
  }
}

function closeModal(id){
  document.getElementById(id)?.classList.remove('open');
  editingId=null; editingOdmId=null;
}

// Modal overlay click handler - sadece DOMContentLoaded iÃ§inde tanÄ±mlanÄ±yor

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ustaRowHTML(idx, usta='', isTipi='', fiyat=''){
  const uOpts = DB.tanimlar.ustalar.map(u=>`<option ${u===usta?'selected':''}>${u}</option>`).join('');
  const iOpts = DB.tanimlar.isTipleri.map(i=>`<option ${i===isTipi?'selected':''}>${i}</option>`).join('');
  return `<div class="usta-row" data-idx="${idx}" style="display:grid;grid-template-columns:1fr 1fr 120px 36px;gap:8px;
    background:var(--surface2);border:1px solid var(--border);border-radius:var(--r8);padding:10px">
    <div class="form-row" style="gap:3px">
      <label class="form-label" style="font-size:10px">Usta</label>
      <select class="form-select" style="padding:6px 8px" data-field="usta" onchange="calcUstaFiyat(this)">
        <option value="">â€” SeÃ§iniz â€”</option>${uOpts}
      </select>
    </div>
    <div class="form-row" style="gap:3px">
      <label class="form-label" style="font-size:10px">YapÄ±lan Ä°ÅŸ</label>
      <select class="form-select" style="padding:6px 8px" data-field="is" onchange="calcUstaFiyat(this)">
        <option value="">â€” SeÃ§iniz â€”</option>${iOpts}
      </select>
    </div>
    <div class="form-row" style="gap:3px">
      <label class="form-label" style="font-size:10px">Ãœcret (â‚º)</label>
      <input type="number" class="form-input" style="padding:6px 8px;font-family:var(--mono)"
        data-field="fiyat" value="${fiyat}" placeholder="0">
    </div>
    <div style="display:flex;align-items:flex-end;padding-bottom:1px">
      <button type="button" class="btn-icon" style="color:var(--red);width:36px;height:36px"
        onclick="removeUstaRow(this)">âœ•</button>
    </div>
  </div>`;
}

function addUstaRow(usta='', isTipi='', fiyat=''){
  const c = document.getElementById('usta-rows-container');
  const idx = c.children.length;
  const d = document.createElement('div');
  d.innerHTML = ustaRowHTML(idx, usta, isTipi, fiyat);
  c.appendChild(d.firstElementChild);
}

function removeUstaRow(btn){
  const row = btn.closest('.usta-row');
  if(document.querySelectorAll('.usta-row').length <= 1){
    toast('En az bir usta/iÅŸ satÄ±rÄ± olmalÄ±','error'); return;
  }
  row.remove();
}

function calcUstaFiyat(sel){
  const row = sel.closest('.usta-row');
  const usta = row.querySelector('[data-field="usta"]').value;
  const is   = row.querySelector('[data-field="is"]').value;
  if(usta && is){
    const f = getFiyat(usta, is);
    if(f>0) row.querySelector('[data-field="fiyat"]').value = f;
  }
}

function getUstaRows(){
  return [...document.querySelectorAll('.usta-row')].map(row=>({
    usta:  row.querySelector('[data-field="usta"]').value,
    isTipi:row.querySelector('[data-field="is"]').value,
    fiyat: parseFloat(row.querySelector('[data-field="fiyat"]').value)||0
  })).filter(r=>r.usta||r.isTipi);
}

function initTadForm(){
  const sf = s => document.getElementById(s);
  const mSel = sf('f-tad-marka');
  mSel.innerHTML = '<option value="">â€” SeÃ§iniz â€”</option>'+
    Object.keys(DB.tanimlar.markalar).map(m=>`<option>${m}</option>`).join('');
  updateModelSelect();

  const c = document.getElementById('usta-rows-container');
  c.innerHTML = '';

  if(editingId!==null){
    const t = DB.tadilatlar.find(t=>t.id===editingId);
    if(!t) return;
    sf('f-tad-tarih').value = t.tarih||'';
    sf('f-tad-musteri').value = t.musteri||'';
    sf('f-tad-tel').value = t.tel||'';
    sf('f-tad-adres').value = t.adres||'';
    sf('f-tad-baslama').value = t.baslama||'';
    sf('f-tad-bitis').value = t.bitis||'';
    sf('f-tad-marka').value = t.marka||'';
    updateModelSelect();
    sf('f-tad-model').value = t.model||'';
    sf('f-tad-durum').value = t.durum||'Devam Ediyor';
    sf('f-tad-seri').value = t.seriNo||'';
    sf('f-tad-eksik').value = t.eksikler||'';
    sf('f-tad-not').value = t.notlar||'';
    sf('f-tad-aciklama').value = t.aciklama||'';
    const ustalar = t.ustalar||[{usta:t.usta||'',isTipi:t.isTipi||'',fiyat:0}];
    ustalar.forEach(u=>addUstaRow(u.usta, u.isTipi, u.fiyat||''));
    document.getElementById('modal-tad-title').textContent='Ä°ÅŸ KaydÄ± DÃ¼zenle';
  } else {
    sf('f-tad-tarih').value = today();
    sf('f-tad-musteri').value='';sf('f-tad-tel').value='';
    sf('f-tad-adres').value='';sf('f-tad-baslama').value='';sf('f-tad-bitis').value='';
    sf('f-tad-seri').value='';sf('f-tad-eksik').value='';sf('f-tad-aciklama').value='';sf('f-tad-not').value='';
    addUstaRow();
    document.getElementById('modal-tad-title').textContent='Yeni Ä°ÅŸ KaydÄ±';
  }
}

function updateModelSelect(){
  const marka = document.getElementById('f-tad-marka')?.value;
  const mSel = document.getElementById('f-tad-model');
  if(!mSel) return;
  const modeller = DB.tanimlar.markalar[marka]||[];
  mSel.innerHTML = '<option value="">â€” SeÃ§iniz â€”</option>'+
    modeller.map(m=>`<option>${m}</option>`).join('');
}

function saveTadilat(){
  const g = id => document.getElementById(id)?.value?.trim();
  if(!g('f-tad-musteri')){ toast('MÃ¼ÅŸteri adÄ± zorunlu','error'); return; }
  if(!g('f-tad-tarih')){ toast('Tarih zorunlu','error'); return; }
  
  // Gelecek tarih uyarÄ±sÄ±
  const tarihVal = g('f-tad-tarih');
  if(tarihVal > today()){ toast('âš ï¸ Tarih bugÃ¼nden ileri girildi. Devam ediliyor...','info'); }
  
  // BitiÅŸ baÅŸlangÄ±Ã§tan Ã¶nce olamaz
  const baslamaVal = g('f-tad-baslama');
  const bitisVal = g('f-tad-bitis');
  if(baslamaVal && bitisVal && bitisVal < baslamaVal){ toast('BitiÅŸ tarihi baÅŸlamadan Ã¶nce olamaz','error'); return; }

  const ustalar = getUstaRows();
  if(ustalar.length===0){ toast('En az bir usta/iÅŸ seÃ§in','error'); return; }
  
  // Negatif fiyat kontrolÃ¼
  for(const u of ustalar){
    if((u.fiyat||0) < 0){ toast('Usta fiyatÄ± negatif olamaz','error'); return; }
  }

  const obj = {
    tarih:g('f-tad-tarih'), musteri:g('f-tad-musteri'),
    tel:g('f-tad-tel'), adres:g('f-tad-adres'),
    baslama:g('f-tad-baslama'), bitis:g('f-tad-bitis'),
    marka:g('f-tad-marka'), model:g('f-tad-model'),
    durum:g('f-tad-durum')||'Devam Ediyor',
    seriNo:g('f-tad-seri'), eksikler:g('f-tad-eksik'), aciklama:g('f-tad-aciklama'), notlar:g('f-tad-not'),
    ustalar,
    usta:    ustalar[0]?.usta||'',
    isTipi:  ustalar[0]?.isTipi||''
  };

  if(editingId!==null){
    const t = DB.tadilatlar.find(t=>t.id===editingId);
    if(t) Object.assign(t, obj);
    toast('KayÄ±t gÃ¼ncellendi','success');
    if((obj.durum==='TamamlandÄ±')){
      const mevcutOdm=DB.odemeler.find(o=>o.isNo===editingId);
      if(!mevcutOdm){
        setTimeout(()=>toast('ğŸ’³ Ä°ÅŸ tamamlandÄ± â€” Ã¶deme kaydÄ± henÃ¼z yok!','warning'),500);
      } else if(mevcutOdm.kalan>0){
        setTimeout(()=>toast('ğŸ’³ Ä°ÅŸ tamamlandÄ± â€” '+fmt(mevcutOdm.kalan)+' TL bakiye var','warning'),500);
      }
    }
  } else {
    const yeniId = DB.nextId++;
    DB.tadilatlar.push({id:yeniId, ...obj});
    toast('Ä°ÅŸ kaydÄ± eklendi','success');
    if((obj.durum==='TamamlandÄ±')){
      setTimeout(()=>toast('ğŸ’³ Ä°ÅŸ tamamlandÄ± â€” Ã¶deme kaydÄ± henÃ¼z yok!','warning'),500);
    }
  }
  invalidateCache();
  saveDB(); closeModal('modal-tad'); renderAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchOdmTab(tab, btn){
  document.querySelectorAll('.odm-tab').forEach(t=>t.style.display='none');
  document.querySelectorAll('.odm-tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('odm-tab-'+tab).style.display='block';
  btn.classList.add('active');
  // Aktif olmayan tablardaki deÄŸerleri sÄ±fÄ±rla â€” Ã§ift sayÄ±m Ã¶nlenir
  const clrIfHidden = (id) => {
    const el = document.getElementById(id);
    if(el && el.closest('.odm-tab') && el.closest('.odm-tab').style.display==='none') el.value='';
  };
  ['f-odm-nakit','f-odm-kart','f-odm-havale','f-odm-cek','f-odm-simdi'].forEach(clrIfHidden);
  calcOdeme();
}

function addVadeRow(tutar='', tarih=''){
  const c=document.getElementById('vade-rows-container');
  const d=document.createElement('div');
  d.style.cssText='display:grid;grid-template-columns:1fr 1fr 36px;gap:8px;align-items:end';
  d.innerHTML=`
    <div class="form-row" style="gap:3px">
      <label class="form-label" style="font-size:10px">Tutar (â‚º)</label>
      <input type="number" class="form-input" style="padding:6px 8px" value="${tutar}" placeholder="0" oninput="calcVadeli()">
    </div>
    <div class="form-row" style="gap:3px">
      <label class="form-label" style="font-size:10px">Vade Tarihi</label>
      <input type="date" class="form-input" style="padding:6px 8px" value="${tarih}">
    </div>
    <button type="button" class="btn-icon" style="color:var(--red);width:36px;height:36px"
      onclick="this.parentElement.remove();calcVadeli()">âœ•</button>`;
  c.appendChild(d);
}

function calcVadeli(){
  const tutar=parseFloat(document.getElementById('f-odm-tutar')?.value)||0;
  const simdi=parseFloat(document.getElementById('f-odm-simdi')?.value)||0;
  const sonra=Math.max(0,tutar-simdi);
  const el=document.getElementById('f-odm-sonra');
  if(el) el.value=fmt(sonra);
}

function calcTaksit(){
  const kart=parseFloat(document.getElementById('f-odm-kart')?.value)||0;
  const taksit=parseInt(document.getElementById('f-odm-taksit')?.value)||0;
  const ttEl=document.getElementById('f-odm-taksit-tutar');
  const pa=document.getElementById('taksit-progress-area');
  if(taksit>0 && kart>0){
    const tt=kart/taksit;
    if(ttEl) ttEl.value=fmt(tt);
    if(pa) pa.style.display='block';
    document.getElementById('taksit-total-label').textContent=taksit;
    const odenen=parseInt(document.getElementById('f-odm-taksit-odenen')?.value)||0;
    const pct=taksit>0?Math.round(odenen/taksit*100):0;
    const bar=document.getElementById('taksit-progress-bar');
    if(bar) bar.style.width=pct+'%';
    document.getElementById('taksit-pct-label').textContent=pct+'%';
    const kalanTaksit=taksit-odenen;
    const infoEl=document.getElementById('taksit-kalan-info');
    if(infoEl) infoEl.textContent=`Kalan: ${kalanTaksit} taksit Ã— ${fmt(tt)} = ${fmt(kalanTaksit*tt)}`;
  } else {
    if(ttEl) ttEl.value='';
    if(pa) pa.style.display='none';
  }
  calcOdeme();
}

function initOdmForm(){
  switchOdmTab('nakit', document.querySelector('.odm-tab-btn'));

  const sf=s=>document.getElementById(s);
  if(editingOdmId!==null){
    const o=DB.odemeler.find(o=>o.id===editingOdmId);
    if(!o) return;
    sf('f-odm-isno').value=o.isNo||'';
    sf('f-odm-musteri').value=getMusteri(o.isNo)||o.musteri||'';
    sf('f-odm-tc').value=o.tc||'';
    sf('f-odm-tutar').value=o.tutar||'';
    sf('f-odm-nakit').value=o.nakit||'';
    sf('f-odm-kart').value=o.kart||'';
    sf('f-odm-taksit').value=o.taksit||0;
    sf('f-odm-taksit-odenen').value=o.taksitOdenen||0;
    sf('f-odm-havale').value=o.havale||'';
    sf('f-odm-havale-banka').value=o.havaleBanka||'';
    sf('f-odm-havale-ref').value=o.havaleRef||'';
    sf('f-odm-cek').value=o.cek||'';
    sf('f-odm-cek-tarih').value=o.cekTarih||'';
    sf('f-odm-cek-no').value=o.cekNo||'';
    sf('f-odm-cek-durum').value=o.cekDurum||'Beklemede';
    sf('f-odm-simdi').value=o.simdi||'';
    sf('f-odm-not').value=o.not||'';
    const vc=document.getElementById('vade-rows-container');
    vc.innerHTML='';
    (o.vadeler||[]).forEach(v=>addVadeRow(v.tutar,v.tarih));
    document.getElementById('modal-odm-title').textContent='Ã–deme DÃ¼zenle';
    calcOdeme(); calcTaksit(); calcVadeli();
  } else {
    ['f-odm-isno','f-odm-tc','f-odm-tutar','f-odm-nakit','f-odm-kart','f-odm-taksit-odenen',
     'f-odm-havale','f-odm-havale-banka','f-odm-havale-ref',
     'f-odm-cek','f-odm-cek-no','f-odm-simdi','f-odm-not']
      .forEach(id=>{const el=sf(id);if(el)el.value='';});
    sf('f-odm-musteri').value='';
    sf('f-odm-taksit').value='0';
    sf('f-odm-cek-durum').value='Beklemede';
    sf('f-odm-toplam').value='';
    sf('f-odm-kalan').value='';
    sf('f-odm-taksit-tutar').value='';
    sf('f-odm-sonra').value='';
    document.getElementById('taksit-progress-area').style.display='none';
    document.getElementById('vade-rows-container').innerHTML='';
    document.getElementById('modal-odm-title').textContent='Yeni Ã–deme KaydÄ±';
    if(window._pendingIsNo){
      const sf=s=>document.getElementById(s);
      sf('f-odm-isno').value = window._pendingIsNo;
      sf('f-odm-musteri').value = getMusteri(window._pendingIsNo)||'';
      window._pendingIsNo = null;
    }
  }
}

function musteriAutocomplete(inp){
  const q = inp.value.trim().toLowerCase();
  const box = document.getElementById('musteri-suggestions');
  if(!box) return;
  if(q.length < 2){ box.style.display='none'; return; }
  const musteriListesi = [...new Set(DB.tadilatlar.map(t=>t.musteri).filter(Boolean))]
    .filter(m=>m.toLowerCase().includes(q)).slice(0,8);
  if(musteriListesi.length===0){ box.style.display='none'; return; }
  box.innerHTML = musteriListesi.map(m=>
    `<div onclick="document.getElementById('f-tad-musteri').value=this.dataset.val;document.getElementById('musteri-suggestions').style.display='none'"
      data-val="${esc(m)}"
      style="padding:8px 12px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--border2)"
      class="musteri-secim-item">${esc(m)}</div>`
  ).join('');
  box.style.display='block';
}

document.addEventListener('click', e=>{
  if(!e.target.closest('#musteri-suggestions') && e.target.id!=='f-tad-musteri'){
    const box=document.getElementById('musteri-suggestions');
    if(box) box.style.display='none';
  }
});

// Escape tuÅŸu ile aÃ§Ä±k modalÄ± kapat
document.addEventListener('keydown', e=>{
  if(e.key==='Escape'){
    const open=document.querySelector('.modal-overlay.open');
    if(open) open.classList.remove('open');
  }
  // Ctrl+N = Yeni Ä°ÅŸ KaydÄ± (aktif sayfaya gÃ¶re)
  if((e.ctrlKey||e.metaKey) && e.key==='n'){
    e.preventDefault();
    const active=document.querySelector('.page.active')?.id?.replace('page-','');
    if(active==='tadilatlar') openModal('modal-tad');
    else if(active==='odemeler') openModal('modal-odm');
    else if(active==='hesap-defteri') openModal('modal-hd');
    else openModal('modal-tad');
  }
});

function autoFillMusteri(){
  const isNo=document.getElementById('f-odm-isno').value;
  document.getElementById('f-odm-musteri').value=getMusteri(isNo);
}

function openIsSecModal(){
  openModal('modal-is-sec');
  document.getElementById('is-sec-search').value='';
  renderIsSecList();
}

function renderIsSecList(){
  const q=(document.getElementById('is-sec-search')?.value||'').toLowerCase();
  const list=[...DB.tadilatlar].reverse().filter(t=>{
    if(!q) return true;
    return (t.musteri||'').toLowerCase().includes(q)||(t.id+'').includes(q);
  }).slice(0,40);
  const box=document.getElementById('is-sec-list');
  if(!box) return;
  if(list.length===0){
    box.innerHTML='<div style="padding:20px;text-align:center;color:var(--text3)">KayÄ±t bulunamadÄ±</div>';
    return;
  }
  box.innerHTML=list.map(t=>{
    const odm=DB.odemeler.find(o=>o.isNo===t.id);
    const op=odm?(odm.kalan<=0?'<span class="badge badge-green" style="font-size:10px">âœ“ Ã–dendi</span>':'<span class="badge badge-red" style="font-size:10px">Bakiye Var</span>'):'<span class="badge" style="font-size:10px">Ã–deme Yok</span>';
    return `<div onclick="selectIsNo(${t.id})"
      style="padding:10px 12px;border-bottom:1px solid var(--border2);cursor:pointer;display:flex;align-items:center;gap:12px"
      class="musteri-secim-item" style="cursor:pointer">
      <span class="mono text-muted" style="min-width:40px">#${t.id}</span>
      <div style="flex:1">
        <div class="font-medium">${esc(t.musteri)||'â€”'}</div>
        <div class="text-xs text-muted">${esc(t.adres)||''} ${t.tarih?'â€¢ '+fmtDate(t.tarih):''}</div>
      </div>
      <div style="display:flex;gap:4px">${op} ${durum2badge(t.durum)}</div>
    </div>`;
  }).join('');
}

function selectIsNo(isNo){
  document.getElementById('f-odm-isno').value=isNo;
  document.getElementById('f-odm-musteri').value=getMusteri(isNo)||'';
  closeModal('modal-is-sec');
}

function calcOdeme(){
  const n=id=>parseFloat(document.getElementById(id)?.value)||0;
  const nakit=n('f-odm-nakit');
  const kart=n('f-odm-kart');
  const havale=n('f-odm-havale');
  const cek=n('f-odm-cek');
  const simdi=n('f-odm-simdi');
  const toplam=nakit+kart+havale+cek+simdi;
  const tutar=n('f-odm-tutar');
  const kalan=Math.max(0,tutar-toplam);
  document.getElementById('f-odm-toplam').value=fmt(toplam);
  const durumEl = document.getElementById('odm-durum-gosterge');
  if(durumEl){
    if(tutar>0 && toplam>tutar){
      durumEl.textContent = 'â›” Toplam tutar aÅŸÄ±ldÄ± â€” '+fmt(toplam-tutar)+' fazla';
      durumEl.style.color = 'var(--red)';
    } else {
      const durumTxt = kalan<=0 ? 'âœ… Ã–dendi' : toplam>0 ? 'âš ï¸ KÄ±smi Ã–deme â€” '+fmt(kalan)+' kalan' : 'ğŸ”´ Ã–denmedi';
      durumEl.textContent = durumTxt;
      durumEl.style.color = kalan<=0 ? 'var(--green)' : toplam>0 ? 'var(--yellow)' : 'var(--red)';
    }
  }
  document.getElementById('f-odm-kalan').value=fmt(kalan);
  calcVadeli();
}

async function saveOdeme(){
  const g=id=>document.getElementById(id)?.value?.trim();
  const n=id=>parseFloat(document.getElementById(id)?.value)||0;
  if(!g('f-odm-isno')){toast('Ä°ÅŸ No zorunlu','error');return;}
  const tutar=n('f-odm-tutar');
  if(!tutar){toast('Toplam tutar zorunlu','error');return;}
  if(tutar<0){toast('Tutar negatif olamaz','error');return;}

  if(editingOdmId===null){
    const isNo=parseInt(g('f-odm-isno'));
    const mevcutOdeme=DB.odemeler.find(o=>o.isNo===isNo);
    if(mevcutOdeme){
      const ok = await customConfirm(`Ä°ÅŸ No #${isNo} iÃ§in zaten bir Ã¶deme kaydÄ± var. GÃ¼ncelleme yapmak iÃ§in o kaydÄ± dÃ¼zenleyin. Yine de yeni kayÄ±t eklemek istiyor musunuz?`, 'MÃ¼kerrer KayÄ±t', '+ Yeni KayÄ±t Ekle', false);
      if(!ok) return;
    }
  }

  const nakit=n('f-odm-nakit'),kart=n('f-odm-kart');
  const havale=n('f-odm-havale'),cek=n('f-odm-cek'),simdi=n('f-odm-simdi');
  const toplam=nakit+kart+havale+cek+simdi;
  if(tutar>0 && toplam>tutar){
    toast('Toplam Ã¶deme fatura tutarÄ±nÄ± aÅŸÄ±yor â€” kayÄ±t iptal edildi','error');
    return;
  }
  const kalan=Math.max(0,tutar-toplam);
  const taksit=parseInt(g('f-odm-taksit'))||0;
  const taksitOdenen=parseInt(g('f-odm-taksit-odenen'))||0;

  const vadeRows=[...document.querySelectorAll('#vade-rows-container > div')];
  const vadeler=vadeRows.map(row=>{
    const inputs=row.querySelectorAll('input');
    return {tutar:parseFloat(inputs[0].value)||0, tarih:inputs[1].value};
  }).filter(v=>v.tutar>0||v.tarih);

  const anaVade=vadeler.length>0?vadeler[0].tarih:'';

  const obj={
    isNo:parseInt(g('f-odm-isno')),
    musteri:g('f-odm-musteri')||getMusteri(g('f-odm-isno')),
    tc:g('f-odm-tc'),
    tutar,nakit,kart,havale,cek,simdi,
    taksit,taksitOdenen,
    taksitTutar:taksit>0&&kart>0?kart/taksit:0,
    havaleBanka:g('f-odm-havale-banka'),
    havaleRef:g('f-odm-havale-ref'),
    cekTarih:g('f-odm-cek-tarih'),
    cekNo:g('f-odm-cek-no'),
    cekDurum:g('f-odm-cek-durum'),
    vadeler,
    vade:anaVade,
    toplamOdenen:toplam,
    kalan,
    durum: kalan<=0 ? 'Ã–dendi' : toplam>0 ? 'KÄ±smi Ã–deme' : 'Ã–denmedi',
    not:g('f-odm-not')
  };

  if(editingOdmId!==null){
    const idx=DB.odemeler.findIndex(o=>o.id===editingOdmId);
    const eskiToplamOdenen = idx>=0 ? (DB.odemeler[idx].toplamOdenen||0) : 0;
    if(idx>=0) DB.odemeler[idx]={...DB.odemeler[idx],...obj};
    hdOtomatikGelirEkle(obj, eskiToplamOdenen);
    toast('Ã–deme gÃ¼ncellendi','success');
  } else {
    obj.id=(typeof crypto!=='undefined'&&crypto.randomUUID)?crypto.randomUUID():Date.now();
    DB.odemeler.push(obj);
    hdOtomatikGelirEkle(obj, 0);
    toast('Ã–deme eklendi','success');
  }
  invalidateCache(); saveDB(); closeModal('modal-odm'); renderAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const h=new Date().getHours();
  const gr=h<12?'GÃ¼naydÄ±n ğŸŒ…':h<18?'Ä°yi gÃ¼nler â˜€':h<21?'Ä°yi akÅŸamlar ğŸŒ‡':'Ä°yi geceler ğŸŒ™';
  document.getElementById('db-greeting').textContent=gr+' â€” '+fmtDate(today());

    const tadList=DB.tadilatlar.filter(t=>!t.arsiv), odmList=DB.odemeler.filter(o=>!o.arsiv);
  const thisMonth=new Date().toISOString().slice(0,7);
  // Tek geÃ§iÅŸ: tÃ¼m KPI deÄŸerleri
  let toplamFatura=0,toplamTahsilat=0,toplamKalan=0,gecikmiÅŸ=0,buHaftaVade=0,thisMonthCount=0;
  const now=today();
  odmList.forEach(o=>{
    toplamFatura+=(o.tutar||0); toplamTahsilat+=(o.toplamOdenen||0); toplamKalan+=(o.kalan||0);
    if(o.vade&&o.kalan>0){ const d=diffDays(o.vade); if(d<0) gecikmiÅŸ++; else if(d<=7) buHaftaVade++; }
  });
  tadList.forEach(t=>{ if(t.tarih?.slice(0,7)===thisMonth) thisMonthCount++; });

  document.getElementById('kpi-grid').innerHTML=`
    <div class="kpi-card blue" onclick="navigate('tadilatlar')" style="cursor:pointer" title="Ä°ÅŸ Emirleri'ne git">
      <div class="kpi-icon">ğŸ”§</div>
      <div class="kpi-label">Bu Ay Ä°ÅŸ</div>
      <div class="kpi-value">${thisMonthCount}</div>
      <div class="kpi-sub">Toplam ${tadList.length} kayÄ±t</div>
    </div>
    <div class="kpi-card green" onclick="navigate('odemeler')" style="cursor:pointer" title="Ã–demeler'e git">
      <div class="kpi-icon">ğŸ’°</div>
      <div class="kpi-label">Toplam Fatura</div>
      <div class="kpi-value" style="font-size:20px">${fmt(toplamFatura)}</div>
      <div class="kpi-sub">Tahsilat: ${fmt(toplamTahsilat)}</div>
    </div>
    <div class="kpi-card red" onclick="navigate('vade')" style="cursor:pointer" title="Vade Takibi'ne git">
      <div class="kpi-icon">â³</div>
      <div class="kpi-label">AÃ§Ä±k BorÃ§</div>
      <div class="kpi-value" style="font-size:20px">${fmt(toplamKalan)}</div>
      <div class="kpi-sub ${gecikmiÅŸ>0?'text-red':''}">${gecikmiÅŸ>0?'âš  '+gecikmiÅŸ+' gecikmiÅŸ':'Gecikme yok'}</div>
    </div>
    <div class="kpi-card orange" onclick="navigate('vade')" style="cursor:pointer" title="Vade Takibi'ne git">
      <div class="kpi-icon">ğŸ“…</div>
      <div class="kpi-label">Bu Hafta Vadeli</div>
      <div class="kpi-value">${buHaftaVade}</div>
      <div class="kpi-sub">Ã¶deme geliyor</div>
    </div>
  `;

  const wa = document.getElementById('widget-area');
  wa.innerHTML='';
  const w=DB.widgets;
  const row1=[];
  if(w.son_isler) row1.push(widgetSonIsler());
  if(w.gecikmiÅŸ_odemeler) row1.push(widgetGecikmiÅŸ());
  if(row1.length>0){
    const d=document.createElement('div');
    d.className=row1.length===2?'grid-2':'';
    d.style.marginBottom='16px';
    row1.forEach(html=>{const c=document.createElement('div');c.innerHTML=html;d.appendChild(c.firstChild)});
    wa.appendChild(d);
  }
  const row2=[];
  if(w.aylik_trend) row2.push(widgetAylikTrend());
  if(w.odeme_dagilim) row2.push(widgetOdemeDagilim());
  if(row2.length>0){
    const d=document.createElement('div');
    d.className=row2.length===2?'grid-2':'';
    d.style.marginBottom='16px';
    row2.forEach(html=>{const c=document.createElement('div');c.innerHTML=html;d.appendChild(c.firstChild)});
    wa.appendChild(d);
  }
  if(w.usta_performans){
    const d=document.createElement('div');
    d.style.marginBottom='16px';
    d.innerHTML=widgetUstaPerformans();
    wa.appendChild(d);
  }
  if(w.aylik_trend) drawChartDashboard();
  if(w.odeme_dagilim) drawChartDagilim();
}

function widgetSonIsler(){
  const son=DB.tadilatlar.filter(t=>!t.arsiv).slice(-8).reverse();
  const rows=son.length===0
    ?'<tr><td colspan="5" class="tbl-empty">HenÃ¼z kayÄ±t yok</td></tr>'
    :son.map(t=>{
      const ustaTxt=(t.ustalar||[{usta:t.usta||'â€”'}])
        .map(u=>u.usta).filter(Boolean).join(', ')||'â€”';
      const isTxt=(t.ustalar||[{isTipi:t.isTipi||'â€”'}])
        .map(u=>u.isTipi).filter(Boolean).join(', ')||'â€”';
      return `<tr>
        <td class="mono">#${t.id}</td>
        <td>${esc(t.musteri)||'â€”'}</td>
        <td class="text-sm">${ustaTxt}</td>
        <td>${durum2badge(t.durum)}</td>
      </tr>`;
    }).join('');
  return `<div class="card">
    <div class="card-header"><div class="card-title">Son Ä°ÅŸ Emirleri</div>
    <span class="card-action" onclick="navigate('tadilatlar')">TÃ¼mÃ¼ â†’</span></div>
    <div class="tbl-wrap"><table><thead><tr><th>#</th><th>MÃ¼ÅŸteri</th><th>Ä°ÅŸ</th><th>Usta</th><th>Durum</th></tr></thead>
    <tbody>${rows}</tbody></table></div></div>`;
}

function widgetGecikmiÅŸ(){
  const gec=DB.odemeler.filter(o=>o.vade&&diffDays(o.vade)<0&&o.kalan>0).slice(0,6);
  const rows=gec.length===0
    ?'<tr><td colspan="4" class="tbl-empty" style="color:var(--green)">âœ“ GecikmiÅŸ Ã¶deme yok</td></tr>'
    :gec.map(o=>`<tr>
      <td class="mono text-red">#${o.isNo}</td>
      <td>${esc(o.musteri||getMusteri(o.isNo))||'â€”'}</td>
      <td class="text-red font-mono">${fmt(o.kalan)}</td>
      <td>${vadeBadge(o.vade,o.kalan)}</td>
    </tr>`).join('');
  return `<div class="card">
    <div class="card-header"><div class="card-title" style="color:var(--red)">âš  GecikmiÅŸ Ã–demeler</div>
    <span class="card-action" onclick="navigate('vade')">TÃ¼mÃ¼ â†’</span></div>
    <div class="tbl-wrap"><table><thead><tr><th>No</th><th>MÃ¼ÅŸteri</th><th>Kalan</th><th>Durum</th></tr></thead>
    <tbody>${rows}</tbody></table></div></div>`;
}

function widgetAylikTrend(){
  return `<div class="card">
    <div class="card-header"><div class="card-title">AylÄ±k Trend</div></div>
    <canvas id="chart-dash" height="200"></canvas></div>`;
}

function widgetOdemeDagilim(){
  // Tek geÃ§iÅŸ
  let nakit=0,kart=0,havale=0,cek=0;
  DB.odemeler.forEach(o=>{ if(o.arsiv) return; nakit+=(o.nakit||0); kart+=(o.kart||0); havale+=(o.havale||0); cek+=(o.cek||0); });
  return `<div class="card">
    <div class="card-header"><div class="card-title">Ã–deme DaÄŸÄ±lÄ±mÄ±</div></div>
    <canvas id="chart-dagilim" height="200"></canvas>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px">
      ${[['Nakit',nakit,'green'],['Kart',kart,'blue'],['Havale',havale,'purple'],['Ã‡ek',cek,'orange']]
        .map(([l,v,c])=>`<div style="display:flex;justify-content:space-between;padding:6px 10px;
          background:var(--surface2);border-radius:var(--r8)">
          <span class="text-sm text-muted">${l}</span>
          <span class="text-sm font-bold" style="color:var(--${c})">${fmt(v)}</span></div>`).join('')}
    </div></div>`;
}

function widgetUstaPerformans(){
  const ustalar=DB.tanimlar.ustalar;
  // Tek geÃ§iÅŸ: tÃ¼m tadilatlarÄ± bir kez tara
  const ustaIsMap={};
  ustalar.forEach(u=>{ ustaIsMap[u]={isler:0,tam:0}; });
  DB.tadilatlar.forEach(t=>{
    if(t.arsiv) return; // #13 fix: arÅŸivlileri dahil etme
    (t.ustalar||[{usta:t.usta}]).forEach(u=>{
      if(u.usta && ustaIsMap[u.usta]){
        ustaIsMap[u.usta].isler++;
        if(t.durum==='TamamlandÄ±') ustaIsMap[u.usta].tam++;
      }
    });
  });
  // #12 fix: hakediÅŸ iÃ§in cache kulllan
  const rows=ustalar.map(u=>({
    u, isler:ustaIsMap[u].isler, tam:ustaIsMap[u].tam,
    hakediÅŸ:ustaHakedisCal(u),
    pct:ustaIsMap[u].isler>0?Math.round(ustaIsMap[u].tam/ustaIsMap[u].isler*100):0
  })).sort((a,b)=>b.isler-a.isler);
  const maxIs=Math.max(...rows.map(r=>r.isler),1);
  return `<div class="card">
    <div class="card-header"><div class="card-title">Usta PerformansÄ±</div></div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:12px">
    ${rows.map(r=>`<div style="padding:12px;background:var(--surface2);border-radius:var(--r8);border:1px solid var(--border)">
      <div class="font-bold text-sm" style="margin-bottom:6px;color:var(--text)">${r.u.replace(' Usta','')}</div>
      <div style="font-size:22px;font-weight:700;color:var(--blue)">${r.isler}</div>
      <div class="text-xs text-muted">iÅŸ â€¢ ${r.tam} tam</div>
      <div class="progress mt-8"><div class="progress-fill" style="width:${r.isler/maxIs*100}%;background:var(--blue)"></div></div>
    </div>`).join('')}
    </div></div>`;
}

let _chartDashHash='', _chartDagilimHash='';

function drawChartDashboard(){
  const el=document.getElementById('chart-dash');
  if(!el) return;
  const yil = new Date().getFullYear();
  const data = new Array(12).fill(0);
  DB.tadilatlar.forEach(t=>{
    if(!t.tarih) return;
    const d = new Date(t.tarih);
    if(d.getFullYear()===yil) data[d.getMonth()]++;
  });
  const hash = yil+','+data.join(',');
  if(hash===_chartDashHash && chartInstance) return;
  _chartDashHash=hash;
  if(chartInstance){
    // Destroy yerine data gÃ¼ncelle â€” Ã§ok daha hÄ±zlÄ±
    chartInstance.data.datasets[0].data = data;
    chartInstance.data.datasets[0].label = 'Ä°ÅŸ SayÄ±sÄ± ('+yil+')';
    chartInstance.update('none'); // animasyon olmadan anlÄ±k gÃ¼ncelle
    return;
  }
  chartInstance=new Chart(el,{type:'bar',data:{
    labels:AYLAR,datasets:[{label:'Ä°ÅŸ SayÄ±sÄ± ('+yil+')',data,
      backgroundColor:'rgba(88,166,255,.6)',borderColor:'rgba(88,166,255,1)',
      borderWidth:1,borderRadius:4}]},
    options:{responsive:true,animation:{duration:200},plugins:{legend:{display:false}},
      scales:{x:{ticks:{color:'#8b949e',font:{size:10}},grid:{color:'#21262d'}},
              y:{ticks:{color:'#8b949e',font:{size:10}},grid:{color:'#21262d'}}}}
  });
}

function drawChartDagilim(){
  const el=document.getElementById('chart-dagilim');
  if(!el) return;
  const vals=[0,0,0,0];
  DB.odemeler.forEach(o=>{ if(o.arsiv) return; vals[0]+=(o.nakit||0); vals[1]+=(o.kart||0); vals[2]+=(o.havale||0); vals[3]+=(o.cek||0); });
  const hash=vals.join(',');
  if(hash===_chartDagilimHash && chartAylikInstance) return;
  _chartDagilimHash=hash;
  if(chartAylikInstance){
    chartAylikInstance.data.datasets[0].data = vals;
    chartAylikInstance.update('none');
    return;
  }
  chartAylikInstance=new Chart(el,{type:'doughnut',data:{
    labels:['Nakit','Kredi KartÄ±','Havale/EFT','Ã‡ek'],
    datasets:[{data:vals,backgroundColor:['rgba(63,185,80,.7)','rgba(88,166,255,.7)',
      'rgba(188,140,255,.7)','rgba(255,166,87,.7)'],borderWidth:0}]},
    options:{responsive:true,animation:{duration:200},
      plugins:{legend:{position:'bottom',labels:{color:'#8b949e',font:{size:11}}}},cutout:'65%'}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _tadPage = 0;
const TAD_PAGE_SIZE = 50;

function renderTadilatlar(){
  const search=document.getElementById('tad-search')?.value?.toLowerCase()||'';
  const fDurum=document.getElementById('tad-filter-durum')?.value||'';
  const fUsta=document.getElementById('tad-filter-usta')?.value||'';

  const uSel=document.getElementById('tad-filter-usta');
  if(uSel){
    const mevcutUsta = uSel.value;
    if(uSel.options.length-1 !== DB.tanimlar.ustalar.length){
      uSel.innerHTML='<option value="">TÃ¼m Ustalar</option>';
      DB.tanimlar.ustalar.forEach(u=>{const o=document.createElement('option');o.value=o.textContent=u;uSel.appendChild(o);});
      uSel.value = mevcutUsta;
    }
  }

  let list=[...DB.tadilatlar].filter(t=>!t.arsiv).reverse();
  if(search){ _tadPage=0; list=list.filter(t=>{
    const ustaTxt=(t.ustalar||[{usta:t.usta||'',isTipi:t.isTipi||''}]).map(u=>u.usta+u.isTipi).join(' ');
    return (t.musteri+t.adres+ustaTxt).toLowerCase().includes(search);
  });}
  if(fDurum){ _tadPage=0; list=list.filter(t=>t.durum===fDurum); }
  if(fUsta){  _tadPage=0; list=list.filter(t=>(t.ustalar||[{usta:t.usta}]).some(u=>u.usta===fUsta)); }

  const total=list.length;
  const totalPages=Math.ceil(total/TAD_PAGE_SIZE)||1;
  _tadPage=Math.min(_tadPage,totalPages-1);
  const page=list.slice(_tadPage*TAD_PAGE_SIZE, (_tadPage+1)*TAD_PAGE_SIZE);

  document.getElementById('tad-count-sub').textContent=
    `${total} kayÄ±t${total>TAD_PAGE_SIZE?' â€” sayfa '+(_tadPage+1)+'/'+totalPages:''}`;

  const tbody=document.getElementById('tad-tbody');
  tbody.innerHTML=page.length===0
    ?`<tr><td colspan="9" class="tbl-empty">KayÄ±t bulunamadÄ±</td></tr>`
    :page.map(t=>{
      const ustalar=t.ustalar||[{usta:t.usta||'â€”',isTipi:t.isTipi||'â€”',fiyat:0}];
      const ustaTxt=ustalar.map(u=>
        `<div style="display:flex;gap:4px;align-items:center">
          <span class="badge badge-blue" style="font-size:10px">${esc(u.usta)||'â€”'}</span>
          <span class="text-xs text-muted">${esc(u.isTipi)||''}</span>
          ${u.fiyat>0?`<span class="text-xs" style="color:var(--green);font-family:var(--mono)">${fmt(u.fiyat)}</span>`:''}
        </div>`).join('');
      const odmT=DB.odemeler.find(o=>o.isNo===t.id);
      const odmHtml=odmT
        ? `<div class="mono text-xs font-bold ${odmT.kalan>0?'text-red':'text-green'}">${odmT.kalan>0?'-'+fmt(odmT.kalan)+' kalan':'âœ“ Ã–dendi'}</div>
           <div class="text-xs text-muted">${fmt(odmT.toplamOdenen||0)} / ${fmt(odmT.tutar||0)}</div>`
        : '<span class="text-xs text-muted">â€”</span>';
      return `<tr>
        <td class="mono text-muted">#${t.id}</td>
        <td>${fmtDate(t.tarih)}</td>
        <td><div class="font-medium">${esc(t.musteri)||'â€”'}</div><div class="text-xs text-muted">${esc(t.tel)||''}</div></td>
        <td class="text-sm truncate" style="max-width:140px">${esc(t.adres)||'â€”'}</td>
        <td style="min-width:200px">${ustaTxt}</td>
        <td class="text-sm text-muted">${esc(t.marka)||''} ${t.model?'<br><span class="text-xs">'+esc(t.model)+'</span>':''}</td>
        <td>${odmHtml}</td>
        <td>${durum2badge(t.durum)}</td>
        <td>
          <div class="flex gap-8">
            <button class="btn-icon" title="DÃ¼zenle" onclick="editTadilat(${t.id})">âœ</button>
            <button class="btn-icon" title="Ã–deme" onclick="openOdemeFromIs(${t.id})" style="color:var(--blue)" title="Ã–deme Ekle/GÃ¶rÃ¼ntÃ¼le">ğŸ’³</button>
            <button class="btn-icon" onclick="arsivleTadilat(${t.id})" style="color:var(--yellow)" title="ArÅŸivle">ğŸ—„</button>
          </div>
        </td>
      </tr>`;
    }).join('');

  const existingPager=document.getElementById('tad-pager');
  if(existingPager) existingPager.remove();
  if(totalPages>1){
    const pager=document.createElement('div');
    pager.id='tad-pager';
    pager.style.cssText='display:flex;align-items:center;gap:8px;padding:12px 0;justify-content:center';
    pager.innerHTML=`
      <button class="btn btn-secondary" onclick="_tadPage=Math.max(0,_tadPage-1);renderTadilatlar()"
        ${_tadPage===0?'disabled':''}>â† Ã–nceki</button>
      <span class="text-sm text-muted">${_tadPage+1} / ${totalPages}</span>
      <button class="btn btn-secondary" onclick="_tadPage=Math.min(${totalPages-1},_tadPage+1);renderTadilatlar()"
        ${_tadPage===totalPages-1?'disabled':''}>Sonraki â†’</button>`;
    document.getElementById('tad-tbody').closest('table').after(pager);
  }
}

function editTadilat(id){ editingId=id; openModal('modal-tad'); }

function openOdemeFromIs(isNo){
  const mevcutOdeme = DB.odemeler.find(o=>o.isNo===isNo);
  if(mevcutOdeme){
    editingOdmId = mevcutOdeme.id;
  } else {
    editingOdmId = null;
    window._pendingIsNo = isNo;
  }
  navigate('odemeler');
  openModal('modal-odm');
}

async function arsivleTadilat(id){
  const t = DB.tadilatlar.find(x=>x.id===id);
  if(!t) return;
  const ilgiliOdeme = DB.odemeler.find(o=>o.isNo===id);
  let mesaj = 'Bu iÅŸ emri arÅŸive taÅŸÄ±nsÄ±n mÄ±?';
  if(ilgiliOdeme && !ilgiliOdeme.arsiv) mesaj += ' BaÄŸlÄ± Ã¶deme kaydÄ± aktif kalacak.';
  const ok = await customConfirm(mesaj, 'ArÅŸivle', 'ğŸ—„ ArÅŸive TaÅŸÄ±');
  if(!ok) return;
  t.arsiv = true;
  invalidateCache(); saveDB(); renderAll(); toast('Ä°ÅŸ emri arÅŸive taÅŸÄ±ndÄ±');
}

function geriAlTadilat(id){
  const t = DB.tadilatlar.find(x=>x.id===id);
  if(!t) return;
  t.arsiv = false;
  invalidateCache(); saveDB(); renderAll(); toast('Ä°ÅŸ emri aktife alÄ±ndÄ±','success');
}

async function kaliciSilTadilat(id){
  const ilgiliOdeme = DB.odemeler.find(o=>o.isNo===id);
  let mesaj = 'Bu iÅŸ emri kalÄ±cÄ± silinsin mi? Bu iÅŸlem geri alÄ±namaz.';
  if(ilgiliOdeme) mesaj += ' BaÄŸlÄ± Ã¶deme kaydÄ± silinmeyecek.';
  const ok = await customConfirm(mesaj, 'KalÄ±cÄ± Sil', 'ğŸ—‘ KalÄ±cÄ± Sil', true);
  if(!ok) return;
  DB.tadilatlar = DB.tadilatlar.filter(t=>t.id!==id);
  invalidateCache(); saveDB(); renderAll(); toast('Ä°ÅŸ emri kalÄ±cÄ± silindi');
}

function renderTadilatlarArsiv(){
  const search = (document.getElementById('tad-arsiv-search')?.value||'').toLowerCase();
  const list = DB.tadilatlar.filter(t=>t.arsiv===true).reverse().filter(t=>{
    if(!search) return true;
    const ustaTxt = (t.ustalar||[{usta:t.usta||''}]).map(u=>u.usta).join(' ');
    return (t.musteri+t.adres+ustaTxt).toLowerCase().includes(search);
  });
  document.getElementById('tad-arsiv-count').textContent = list.length+' arÅŸiv kaydÄ±';
  const tbody = document.getElementById('tad-arsiv-tbody');
  if(!tbody) return;
  tbody.innerHTML = list.length===0
    ? '<tr><td colspan="8" class="tbl-empty">ArÅŸivlenmiÅŸ iÅŸ emri yok</td></tr>'
    : list.map(t=>{
        const ustaTxt = (t.ustalar||[{usta:t.usta||'â€”',isTipi:t.isTipi||''}])
          .map(u=>u.usta).filter(Boolean).join(', ')||'â€”';
        return `<tr>
          <td class="mono text-muted">#${t.id}</td>
          <td>${fmtDate(t.tarih)}</td>
          <td><div class="font-medium">${esc(t.musteri)||'â€”'}</div><div class="text-xs text-muted">${esc(t.tel)||''}</div></td>
          <td class="text-sm truncate" style="max-width:120px">${esc(t.adres)||'â€”'}</td>
          <td class="text-sm">${ustaTxt}</td>
          <td class="text-sm text-muted">${esc(t.marka)||''} ${esc(t.model)||''}</td>
          <td>${durum2badge(t.durum)}</td>
          <td>
            <div class="flex gap-8">
              <button class="btn-icon" style="color:var(--green)" onclick="geriAlTadilat(${t.id})" title="Aktife Al">â†©</button>
              <button class="btn-icon" style="color:var(--red)" onclick="kaliciSilTadilat(${t.id})" title="KalÄ±cÄ± Sil">ğŸ—‘</button>
            </div>
          </td>
        </tr>`;
      }).join('');
}

/* deleteTadilat â€” duplicate removed, arsivleTadilat wrapper above handles it */

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _odmPage = 0;
const ODM_PAGE_SIZE = 50;

function renderOdemeler(){
  const search=document.getElementById('odm-search')?.value?.toLowerCase()||'';
  const fDur=document.getElementById('odm-filter')?.value||'';
  let list=[...DB.odemeler].filter(o=>!o.arsiv).reverse();
  if(search){ _odmPage=0; list=list.filter(o=>(o.musteri+(o.isNo+'')).toLowerCase().includes(search)); }
  if(fDur){   _odmPage=0; list=list.filter(o=>o.durum===fDur); }

  const total=list.length;
  const totalPages=Math.ceil(total/ODM_PAGE_SIZE)||1;
  _odmPage=Math.min(_odmPage,totalPages-1);

  document.getElementById('odm-count-sub').textContent=
    `${total} kayÄ±t${total>ODM_PAGE_SIZE?' â€” sayfa '+(_odmPage+1)+'/'+totalPages:''}`;

  // #14 fix: tek geÃ§iÅŸte tÃ¼m toplamlarÄ± hesapla
  let tot=0,tah=0,kal=0,nakit=0,kart=0,havale=0,cek=0;
  list.forEach(o=>{ tot+=(o.tutar||0); tah+=(o.toplamOdenen||0); kal+=(o.kalan||0); nakit+=(o.nakit||0); kart+=(o.kart||0); havale+=(o.havale||0); cek+=(o.cek||0); });

  // #14 fix: mÃ¼ÅŸteri adÄ± iÃ§in Map â€” O(n) lookup yerine O(1)
  const musteriMap = new Map(DB.tadilatlar.map(t=>[t.id, t.musteri||'']));

  document.getElementById('odm-summary').innerHTML=`
    <div class="card" style="padding:14px">
      <div class="kpi-label">Toplam Fatura</div>
      <div class="kpi-value" style="font-size:18px;color:var(--blue)">${fmt(tot)}</div>
      <div class="text-xs text-muted" style="margin-top:4px">${list.length} kayÄ±t</div>
    </div>
    <div class="card" style="padding:14px">
      <div class="kpi-label">Tahsilat DaÄŸÄ±lÄ±mÄ±</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:6px">
        ${[['ğŸ’µ Nakit',nakit,'green'],['ğŸ’³ Kart',kart,'blue'],['ğŸ¦ Havale',havale,'purple'],['ğŸ“„ Ã‡ek',cek,'orange']]
          .map(([l,v,c])=>`<div style="font-size:11px;display:flex;justify-content:space-between;
            padding:3px 6px;background:var(--surface2);border-radius:4px">
            <span style="color:var(--text2)">${l}</span>
            <span style="font-weight:700;color:var(--${c});font-family:var(--mono)">${fmt(v)}</span>
          </div>`).join('')}
      </div>
    </div>
    <div class="card" style="padding:14px">
      <div class="kpi-label">Kalan BorÃ§</div>
      <div class="kpi-value" style="font-size:18px;color:var(--red)">${fmt(kal)}</div>
      <div class="progress mt-8"><div class="progress-fill" style="width:${tot>0?Math.round(tah/tot*100):0}%;background:var(--green)"></div></div>
      <div class="text-xs text-muted mt-8">%${tot>0?Math.round(tah/tot*100):0} tahsil edildi</div>
    </div>
  `;

  const tbody=document.getElementById('odm-tbody');
  const page=list.slice(_odmPage*ODM_PAGE_SIZE, (_odmPage+1)*ODM_PAGE_SIZE);

  if(page.length===0){
    tbody.innerHTML=`<tr><td colspan="13" class="tbl-empty">KayÄ±t bulunamadÄ±</td></tr>`;
    document.getElementById('odm-pager')?.remove();
    return;
  }

  tbody.innerHTML=page.map(o=>{
    const musteri=o.musteri||musteriMap.get(o.isNo)||'â€”';
    const taksit=o.taksit||0;
    const taksitOdenen=o.taksitOdenen||0;
    const taksitPct=taksit>0?Math.round(taksitOdenen/taksit*100):0;

    const taksitHtml=taksit>0
      ?`<div style="white-space:nowrap">
          <span class="font-bold" style="color:var(--purple)">${taksitOdenen}/${taksit}</span>
          <span class="text-xs text-muted"> taksit</span>
        </div>
        <div class="progress" style="width:60px;margin-top:3px">
          <div class="progress-fill" style="width:${taksitPct}%;background:var(--purple)"></div>
        </div>
        <div class="text-xs text-muted">${fmt(o.taksitTutar||0)}/ay</div>`
      :'â€”';

    const cekHtml=o.cek>0
      ?`<div>${fmt(o.cek)}</div>
        ${o.cekNo?`<div class="text-xs text-muted">No: ${esc(o.cekNo)}</div>`:''}
        ${o.cekTarih?`<div class="text-xs text-muted">${fmtDate(o.cekTarih)}</div>`:''}
        ${o.cekDurum&&o.cekDurum!=='Beklemede'?`<span class="badge badge-${o.cekDurum==='Tahsil Edildi'?'green':'red'}" style="font-size:9px">${o.cekDurum}</span>`:''}`
      :'â€”';

    const vadeler=o.vadeler||[];
    const vadeTxt=vadeler.length>0
      ?vadeler.map(v=>`${fmt(v.tutar)} â€¢ ${fmtDate(v.tarih)}`).join('<br>')
      :(o.vade?`${fmtDate(o.vade)}`:'â€”');

    return `<tr>
      <td class="mono">#${o.isNo}</td>
      <td><div class="font-medium">${esc(musteri)}</div>${o.tc?`<div class="text-xs text-muted">${esc(o.tc)}</div>`:''}</td>
      <td class="mono font-bold">${fmt(o.tutar)}</td>
      <td class="mono text-sm ${o.nakit>0?'text-green':'text-muted'}">${o.nakit>0?fmt(o.nakit):'â€”'}</td>
      <td class="mono text-sm">${o.kart>0?fmt(o.kart):'â€”'}</td>
      <td class="text-sm">${taksitHtml}</td>
      <td class="mono text-sm" style="color:${o.havale>0?'var(--purple)':''}">
        ${o.havale>0?`<div>${fmt(o.havale)}</div>${o.havaleBanka?`<div class="text-xs text-muted">${esc(o.havaleBanka)}</div>`:''}`:'â€”'}
      </td>
      <td class="text-sm">${cekHtml}</td>
      <td class="text-sm text-muted">${o.simdi>0?`<div>Åimdi: ${fmt(o.simdi)}</div>${vadeTxt!=='â€”'?`<div class="text-xs">Vade: ${vadeTxt}</div>`:''}`:(vadeTxt!=='â€”'?vadeTxt:'â€”')}</td>
      <td class="mono font-bold ${o.kalan>0?'text-red':'text-green'}">${fmt(o.kalan)}${(()=>{const vl=(DB.virmanlar||[]).filter(v=>v.kaynakOdemeId===o.id);return vl.length>0?`<div class="text-xs" style="color:var(--purple);font-weight:400">â‡„ ${fmt(vl.reduce((s,v)=>s+(v.tutar||0),0))}</div>`:''})()}</td>
      <td>${vadeBadge(o.vade,o.kalan)}</td>
      <td>${odemeBadge(o.durum)}</td>
      <td>
        <div class="flex gap-8">
          <button class="btn-icon" data-odm-id="${o.id}" onclick="editOdeme(this.dataset.odmId)" title="DÃ¼zenle">âœ</button>
          <button class="btn-icon" data-odm-id="${o.id}" onclick="openVirmanModal('musteri',this.dataset.odmId)" style="color:var(--purple)" title="Virman">â‡„</button>
          <button class="btn-icon" data-odm-id="${o.id}" onclick="arsivleOdeme(this.dataset.odmId)" style="color:var(--yellow)" title="ArÅŸivle">ğŸ—„</button>
        </div>
      </td>
    </tr>`;
  }).join('');

  const existingPager=document.getElementById('odm-pager');
  if(existingPager) existingPager.remove();
  if(totalPages>1){
    const pager=document.createElement('div');
    pager.id='odm-pager';
    pager.style.cssText='display:flex;align-items:center;gap:8px;padding:12px 0;justify-content:center';
    pager.innerHTML=`
      <button class="btn btn-secondary" onclick="_odmPage=Math.max(0,_odmPage-1);renderOdemeler()"
        ${_odmPage===0?'disabled':''}>â† Ã–nceki</button>
      <span class="text-sm text-muted">${_odmPage+1} / ${totalPages}</span>
      <button class="btn btn-secondary" onclick="_odmPage=Math.min(${totalPages-1},_odmPage+1);renderOdemeler()"
        ${_odmPage===totalPages-1?'disabled':''}>Sonraki â†’</button>`;
    tbody.closest('table').after(pager);
  }
}

function editOdeme(id){ editingOdmId=id; openModal('modal-odm'); }
async function arsivleOdeme(id){
  const o = DB.odemeler.find(x=>x.id===id);
  if(!o) return;
  const ok = await customConfirm('Bu Ã¶deme arÅŸive taÅŸÄ±nsÄ±n mÄ±?', 'ArÅŸivle', 'ğŸ—„ ArÅŸive TaÅŸÄ±');
  if(!ok) return;
  o.arsiv = true;
  saveDB(); renderAll(); toast('Ã–deme arÅŸive taÅŸÄ±ndÄ±');
}

function geriAlOdeme(id){
  const o = DB.odemeler.find(x=>x.id===id);
  if(!o) return;
  o.arsiv = false;
  saveDB(); renderAll(); toast('Ã–deme aktife alÄ±ndÄ±','success');
}

async function kaliciSilOdeme(id){
  const ok = await customConfirm('Bu Ã¶deme kalÄ±cÄ± olarak silinsin mi? Bu iÅŸlem geri alÄ±namaz.', 'KalÄ±cÄ± Sil', 'ğŸ—‘ KalÄ±cÄ± Sil', true);
  if(!ok) return;
  const odeme = DB.odemeler.find(o=>o.id===id);
  DB.odemeler = DB.odemeler.filter(o=>o.id!==id);
  if(odeme){
    const hdKayit = DB.hesapDefteri.find(h=>h.kaynakId===odeme.id+'');
    if(hdKayit){
      const ok2 = await customConfirm('Bu Ã¶demeye ait Hesap Defteri gelir kaydÄ± da silinsin mi?\n"'+hdKayit.aciklama+'"', 'Hesap Defteri KaydÄ±', 'Evet, Sil', true);
      if(ok2) DB.hesapDefteri = DB.hesapDefteri.filter(h=>h.kaynakId!==odeme.id+'');
    }
  }
  saveDB(); renderAll(); toast('Ã–deme kalÄ±cÄ± silindi');
}

function renderOdemelerArsiv(){
  const search = (document.getElementById('odm-arsiv-search')?.value||'').toLowerCase();
  const list = DB.odemeler.filter(o=>o.arsiv===true).reverse().filter(o=>{
    if(!search) return true;
    return (o.musteri||'').toLowerCase().includes(search)||(o.isNo+'').includes(search);
  });
  document.getElementById('odm-arsiv-count').textContent = list.length+' arÅŸiv kaydÄ±';
  const tbody = document.getElementById('odm-arsiv-tbody');
  if(!tbody) return;
  tbody.innerHTML = list.length===0
    ? '<tr><td colspan="8" class="tbl-empty">ArÅŸivlenmiÅŸ Ã¶deme yok</td></tr>'
    : list.map(o=>`<tr>
        <td class="mono text-muted">#${o.isNo}</td>
        <td><div class="font-medium">${esc(o.musteri)||'â€”'}</div></td>
        <td class="mono">${fmt(o.tutar||0)}</td>
        <td class="mono text-green">${fmt(o.toplamOdenen||0)}</td>
        <td class="mono ${o.kalan>0?'text-red':'text-muted'}">${o.kalan>0?fmt(o.kalan):'â€”'}</td>
        <td>${odemeBadge(o.durum)}</td>
        <td class="text-sm text-muted">${fmtDate(o.tarih||'')}</td>
        <td>
          <div class="flex gap-8">
            <button class="btn-icon" style="color:var(--green)" data-odm-id="${o.id}" onclick="geriAlOdeme(this.dataset.odmId)" title="Aktife Al">â†©</button>
            <button class="btn-icon" style="color:var(--red)" data-odm-id="${o.id}" onclick="kaliciSilOdeme(this.dataset.odmId)" title="KalÄ±cÄ± Sil">ğŸ—‘</button>
          </div>
        </td>
      </tr>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let secilenUsta = null;

function renderUstalar(){
  const ustalar = DB.tanimlar.ustalar;
  let topHakedis=0, topOdenen=0;
  ustalar.forEach(u=>{ topHakedis+=ustaHakedisCal(u); topOdenen+=ustaOdenenCal(u); });
  const topKalan = topHakedis - topOdenen;
  document.getElementById('usta-kpi').innerHTML=`
    <div class="kpi-card purple"><div class="kpi-icon">ğŸ’¼</div>
      <div class="kpi-label">Toplam HakediÅŸ</div>
      <div class="kpi-value" style="font-size:20px">${fmt(topHakedis)}</div></div>
    <div class="kpi-card green"><div class="kpi-icon">âœ…</div>
      <div class="kpi-label">Toplam Ã–denen</div>
      <div class="kpi-value" style="font-size:20px">${fmt(topOdenen)}</div></div>
    <div class="kpi-card red"><div class="kpi-icon">â³</div>
      <div class="kpi-label">Toplam Kalan</div>
      <div class="kpi-value" style="font-size:20px">${fmt(topKalan)}</div></div>
    <div class="kpi-card blue"><div class="kpi-icon">ğŸ‘·</div>
      <div class="kpi-label">Usta SayÄ±sÄ±</div>
      <div class="kpi-value">${ustalar.length}</div></div>`;
  if(!secilenUsta || !ustalar.includes(secilenUsta)) secilenUsta = ustalar[0];
  document.getElementById('usta-tabs').innerHTML = ustalar.map(u=>{
    const hak=ustaHakedisCal(u), ode=ustaOdenenCal(u), kal=hak-ode;
    const pct=hak>0?Math.round(ode/hak*100):0;
    const renk=kal<=0?'green':pct>50?'blue':'orange';
    const icon=kal<=0?'âœ…':pct>0?'âš ï¸':'â³';
    return `<button onclick="selectUsta('${u}')" data-usta="${u}"
      style="padding:10px 14px;border-radius:var(--r8);cursor:pointer;
      border:1px solid ${secilenUsta===u?'var(--blue)':'var(--border)'};
      background:${secilenUsta===u?'var(--surface2)':'var(--surface)'};
      color:${secilenUsta===u?'var(--text)':'var(--text2)'};
      font-family:var(--font);font-size:13px;font-weight:600;transition:all .15s">
      ${u.replace(' Usta','')} ${icon}<br>
      <span style="font-size:10px;color:var(--${renk});font-weight:700">${pct}%</span>
    </button>`;
  }).join('');
  renderUstaDetay();
}

function selectUsta(usta){
  secilenUsta=usta;
  // Sadece tab highlight gÃ¼ncelle, full re-render yapma
  document.querySelectorAll('#usta-tabs button').forEach(btn=>{
    const isSelected = btn.dataset.usta===usta;
    btn.style.borderColor = isSelected ? 'var(--blue)' : 'var(--border)';
    btn.style.background  = isSelected ? 'var(--surface2)' : 'var(--surface)';
    btn.style.color       = isSelected ? 'var(--text)' : 'var(--text2)';
  });
  renderUstaDetay();
}

function ustaOdenenCal(usta){
  if(_odenenCache[usta] !== undefined) return _odenenCache[usta];
  const val = (DB.ustaOdemeleri[usta]||[]).reduce((s,o)=>s+(o.tutar||0),0);
  _odenenCache[usta] = val;
  return val;
}

function renderUstaDetay(){
  const usta=secilenUsta; if(!usta){document.getElementById('usta-detay').innerHTML='';return;}
  const isler=DB.tadilatlar.filter(t=>(t.ustalar||[{usta:t.usta}]).some(u=>u.usta===usta));
  const hakediÅŸ=ustaHakedisCal(usta), odenen=ustaOdenenCal(usta);
  const kalan=hakediÅŸ-odenen, pct=hakediÅŸ>0?Math.round(odenen/hakediÅŸ*100):0;
  const odmGecmisi=(DB.ustaOdemeleri[usta]||[]).slice().reverse();

  let durumBadge='';
  if(hakediÅŸ===0) durumBadge='<span class="badge badge-blue">Ä°ÅŸ KaydÄ± Yok</span>';
  else if(kalan<=0) durumBadge='<span class="badge badge-green" style="font-size:13px;padding:6px 12px">âœ… TamamlandÄ±</span>';
  else if(odenen>0) durumBadge='<span class="badge badge-yellow" style="font-size:13px;padding:6px 12px">âš ï¸ KÄ±smi Ã–dendi</span>';
  else durumBadge='<span class="badge badge-red" style="font-size:13px;padding:6px 12px">â³ Ã–deme Bekliyor</span>';

  const islerHTML=isler.length===0
    ?'<tr><td colspan="6" class="tbl-empty">Bu ustaya ait iÅŸ kaydÄ± yok</td></tr>'
    :isler.slice().reverse().map(t=>{
        const uIsler=(t.ustalar||[{usta:t.usta,isTipi:t.isTipi,fiyat:0}]).filter(u=>u.usta===usta);
        const isHak=uIsler.reduce((s,u)=>s+(u.fiyat||getFiyat(usta,u.isTipi)||0),0);
        return `<tr>
          <td class="mono">#${t.id}</td>
          <td>${fmtDate(t.baslama||t.tarih)}</td>
          <td><div>${esc(t.musteri)||'â€”'}</div><div class="text-xs text-muted">${esc(t.adres)||''}</div></td>
          <td>${uIsler.map(u=>`<span class="badge badge-blue" style="font-size:10px">${u.isTipi||''}</span>`).join(' ')}</td>
          <td class="mono font-bold" style="color:var(--purple)">${isHak>0?fmt(isHak):'â€”'}</td>
          <td>${durum2badge(t.durum)}</td></tr>`;
      }).join('');

  const odmHTML=odmGecmisi.length===0
    ?'<div style="text-align:center;padding:20px;color:var(--text3)">HenÃ¼z Ã¶deme yapÄ±lmamÄ±ÅŸ</div>'
    :odmGecmisi.map(o=>`
        <div style="display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid var(--border2)">
          <div style="width:80px;font-size:12px;color:var(--text2)">${fmtDate(o.tarih)}</div>
          <div style="flex:1"><div class="font-medium">${esc(o.aciklama)||'Ã–deme'}</div>
            <div class="text-xs text-muted">${o.tur||'Nakit'}</div></div>
          <div class="mono font-bold text-green">${fmt(o.tutar)}</div>
          <button class="btn-icon btn-sm" style="color:var(--yellow)"
            onclick="arsivleUstaOdeme('${usta}','${o.id}')" title="ArÅŸivle">ğŸ—„</button>
        </div>`).join('');

  document.getElementById('usta-detay').innerHTML=`
    <div class="grid-6040">
      <div>
        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div><div style="font-size:18px;font-weight:700">${usta}</div>
              <div class="text-sm text-muted">${isler.length} iÅŸ kaydÄ±</div></div>
            <div style="display:flex;gap:8px;align-items:center">
              ${durumBadge}
              <button class="btn btn-primary" onclick="openUstaOdmModal('${usta}')">+ Ã–deme Ekle</button>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px">
            <div style="padding:12px;background:var(--surface2);border-radius:var(--r8);text-align:center">
              <div class="text-xs text-muted">Toplam HakediÅŸ</div>
              <div style="font-size:20px;font-weight:700;color:var(--purple)">${fmt(hakediÅŸ)}</div></div>
            <div style="padding:12px;background:var(--surface2);border-radius:var(--r8);text-align:center">
              <div class="text-xs text-muted">Ã–denen</div>
              <div style="font-size:20px;font-weight:700;color:var(--green)">${fmt(odenen)}</div></div>
            <div style="padding:12px;background:var(--surface2);border-radius:var(--r8);text-align:center">
              <div class="text-xs text-muted">Kalan</div>
              <div style="font-size:20px;font-weight:700;color:${kalan>0?'var(--red)':' var(--green)'}">
                ${fmt(kalan>0?kalan:0)}</div></div>
          </div>
          <div class="progress" style="height:8px;margin-bottom:6px">
            <div class="progress-fill" style="width:${Math.min(pct,100)}%;
              background:${pct>=100?'var(--green)':pct>50?'var(--blue)':' var(--orange)'}"></div></div>
          <div class="text-xs text-muted">%${pct} Ã¶dendi</div>
        </div>
        <div class="card" style="padding:0">
          <div class="card-header" style="padding:12px 16px"><div class="card-title">Ä°ÅŸ KayÄ±tlarÄ±</div></div>
          <div class="tbl-wrap"><table>
            <thead><tr><th>#</th><th>Tarih</th><th>MÃ¼ÅŸteri</th><th>Ä°ÅŸler</th><th>HakediÅŸ</th><th>Durum</th></tr></thead>
            <tbody>${islerHTML}</tbody></table></div>
        </div>
      </div>
      <div class="card" style="padding:0">
        <div class="card-header" style="padding:12px 16px">
          <div class="card-title">Ã–deme GeÃ§miÅŸi</div>
          <span class="badge badge-green">${odmGecmisi.length} kayÄ±t</span></div>
        ${odmHTML}
      </div>
    </div>`;
}

function openUstaOdmModal(usta){
  document.getElementById('f-uodm-usta').value=usta;
  document.getElementById('f-uodm-tarih').value=today();
  document.getElementById('f-uodm-tutar').value='';
  document.getElementById('f-uodm-aciklama').value='';
  document.getElementById('f-uodm-tur').value='Nakit';
  document.getElementById('modal-usta-odm-title').textContent=usta+' â€” Ã–deme Ekle';
  openModal('modal-usta-odm');
}

function saveUstaOdemeModal(){
  const usta=document.getElementById('f-uodm-usta').value;
  const tarih=document.getElementById('f-uodm-tarih').value;
  const tutar=parseFloat(document.getElementById('f-uodm-tutar').value)||0;
  const tur=document.getElementById('f-uodm-tur').value;
  const aciklama=document.getElementById('f-uodm-aciklama').value.trim();
  if(!tutar){toast('Tutar zorunlu','error');return;}
  // FIX5: Negatif tutar kontrolu
  if(tutar < 0){toast('Tutar negatif olamaz','error');return;}

  const odmId = (typeof crypto!=='undefined'&&crypto.randomUUID)?crypto.randomUUID():Date.now()+'';
  if(!DB.ustaOdemeleri[usta]) DB.ustaOdemeleri[usta]=[];
  DB.ustaOdemeleri[usta].push({id:odmId, tarih, tutar, tur, aciklama});

  const hdAciklama = aciklama
    ? `${usta} â€” ${aciklama} (${tur})`
    : `${usta} â€” Usta Ã¶demesi (${tur})`;
  DB.hesapDefteri.push({
    id: 'uodm_'+odmId,
    tarih,
    tip: 'gider',
    kategori: 'Usta Ã–demesi',
    tutar,
    aciklama: hdAciklama,
    kaynakId: odmId,
    otomatik: true
  });

  invalidateCache(usta); saveDB(); closeModal('modal-usta-odm'); renderUstalar();
  toast('Ã–deme kaydedildi ve hesap defterine iÅŸlendi','success');
}

async function arsivleUstaOdeme(usta, id){
  const odeme = (DB.ustaOdemeleri[usta]||[]).find(o=>o.id===id);
  if(!odeme) return;
  const ok = await customConfirm('Bu Ã¶deme arÅŸive taÅŸÄ±nsÄ±n mÄ±?', 'ArÅŸivle', 'ğŸ—„ ArÅŸive TaÅŸÄ±');
  if(!ok) return;
  odeme.arsiv = true;
  saveDB(); renderUstalar(); toast('Ã–deme arÅŸive taÅŸÄ±ndÄ±');
}

function geriAlUstaOdeme(usta, id){
  const odeme = (DB.ustaOdemeleri[usta]||[]).find(o=>o.id===id);
  if(!odeme) return;
  odeme.arsiv = false;
  saveDB(); renderUstalarArsiv(); toast('Ã–deme aktife alÄ±ndÄ±','success');
}

async function kaliciSilUstaOdeme(usta, id){
  const ok = await customConfirm('Bu Ã¶deme kalÄ±cÄ± silinsin mi? Bu iÅŸlem geri alÄ±namaz.', 'KalÄ±cÄ± Sil', 'ğŸ—‘ KalÄ±cÄ± Sil', true);
  if(!ok) return;
  const hdKayit = DB.hesapDefteri.find(h=>h.id==='uodm_'+id);
  if(hdKayit){
    const ok2 = await customConfirm('Bu Ã¶demeye ait Hesap Defteri gider kaydÄ± da silinsin mi?\n"'+hdKayit.aciklama+'"', 'Hesap Defteri KaydÄ±', 'Evet, Sil', true);
    if(ok2) DB.hesapDefteri = DB.hesapDefteri.filter(h=>h.id!=='uodm_'+id);
  }
  DB.ustaOdemeleri[usta] = (DB.ustaOdemeleri[usta]||[]).filter(o=>o.id!==id);
  saveDB(); renderUstalarArsiv(); toast('Ã–deme kalÄ±cÄ± silindi');
}

function renderUstalarArsiv(){
  const sel = document.getElementById('ustalar-arsiv-sec');
  const search = (document.getElementById('ustalar-arsiv-search')?.value||'').toLowerCase();
  const filterUsta = sel?.value||'';

  if(sel && sel.options.length<=1){
    DB.tanimlar.ustalar.forEach(u=>{
      const o=document.createElement('option'); o.value=o.textContent=u; sel.appendChild(o);
    });
  }

  const rows = [];
  DB.tanimlar.ustalar.forEach(usta=>{
    if(filterUsta && usta!==filterUsta) return;
    (DB.ustaOdemeleri[usta]||[]).filter(o=>o.arsiv===true).forEach(o=>{
      if(search && !(o.aciklama||'').toLowerCase().includes(search)) return;
      rows.push({usta, ...o});
    });
  });
  rows.sort((a,b)=>b.tarih>a.tarih?1:-1);

  document.getElementById('ustalar-arsiv-count').textContent = rows.length+' arÅŸiv kaydÄ±';
  const tbody = document.getElementById('ustalar-arsiv-tbody');
  if(!tbody) return;
  tbody.innerHTML = rows.length===0
    ? '<tr><td colspan="6" class="tbl-empty">ArÅŸivlenmiÅŸ usta Ã¶demesi yok</td></tr>'
    : rows.map(o=>`<tr>
        <td class="font-medium">${esc(o.usta)}</td>
        <td class="text-sm text-muted">${fmtDate(o.tarih)}</td>
        <td>${esc(o.aciklama)||'â€”'}</td>
        <td class="text-sm text-muted">${o.tur||'Nakit'}</td>
        <td class="mono font-bold text-green">${fmt(o.tutar)}</td>
        <td>
          <div class="flex gap-8">
            <button class="btn-icon" style="color:var(--green)" data-usta="${esc(o.usta)}" data-id="${o.id}" onclick="geriAlUstaOdeme(this.dataset.usta,this.dataset.id)" title="Aktife Al">â†©</button>
            <button class="btn-icon" style="color:var(--red)" data-usta="${esc(o.usta)}" data-id="${o.id}" onclick="kaliciSilUstaOdeme(this.dataset.usta,this.dataset.id)" title="KalÄ±cÄ± Sil">ğŸ—‘</button>
          </div>
        </td>
      </tr>`).join('');
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAylik(){
  const yilEl = document.getElementById('aylik-yil-sec');
  const mevcutYil = yilEl ? parseInt(yilEl.value) || new Date().getFullYear() : new Date().getFullYear();

  const showArsivAylik = document.getElementById('aylik-show-arsiv')?.checked||false;
  const aktifTadilatlar = DB.tadilatlar.filter(t=>showArsivAylik || !t.arsiv);

  if(yilEl){
    const mevcutSecimYil = yilEl.value || new Date().getFullYear()+'';
    yilEl.innerHTML = '';
    const yillar=[...new Set(aktifTadilatlar.map(t=>t.tarih?.slice(0,4)).filter(Boolean))].sort().reverse();
    const thisYear = new Date().getFullYear()+'';
    if(!yillar.includes(thisYear)) yillar.unshift(thisYear);
    yillar.forEach(y=>{
      const o=document.createElement('option'); o.value=y; o.textContent=y+' YÄ±lÄ±';
      if(y===mevcutSecimYil+'') o.selected=true;
      yilEl.appendChild(o);
    });
  }

  const labels=[],isler=[],faturalar=[],tahsilatlar=[];
  const rows=AYLAR.map((ay,mi)=>{
    const tList=aktifTadilatlar.filter(t=>{
      if(!t.tarih) return false;
      const d=new Date(t.tarih);
      return d.getMonth()===mi && d.getFullYear()===mevcutYil;
    });
    const tam=tList.filter(t=>t.durum==='TamamlandÄ±').length;
    const dev=tList.filter(t=>t.durum==='Devam Ediyor').length;
    const bek=tList.filter(t=>t.durum==='Beklemede').length;
    const isNos=new Set(tList.map(t=>t.id));
    const aOdm=DB.odemeler.filter(o=>isNos.has(o.isNo));
    const fat=aOdm.reduce((s,o)=>s+(o.tutar||0),0);
    const tah=aOdm.reduce((s,o)=>s+(o.toplamOdenen||0),0);
    const kal=fat-tah;
    const pct=fat>0?Math.round(tah/fat*100):0;
    labels.push(ay.slice(0,3));isler.push(tList.length);faturalar.push(fat);tahsilatlar.push(tah);
    return `<tr>
      <td class="font-medium">${ay}</td>
      <td style="color:var(--blue)">${tList.length}</td>
      <td style="color:var(--green)">${tam}</td>
      <td style="color:var(--yellow)">${dev}</td>
      <td style="color:var(--text2)">${bek}</td>
      <td class="mono">${fat?fmt(fat):'â€”'}</td>
      <td class="mono" style="color:var(--green)">${tah?fmt(tah):'â€”'}</td>
      <td class="mono" style="color:${kal>0?'var(--red)':'var(--text2)'}">${kal>0?fmt(kal):'â€”'}</td>
      <td class="text-sm">${fat>0?`<div class="progress"><div class="progress-fill" style="width:${pct}%;background:var(--green)"></div></div><div class="text-xs text-muted">${pct}%</div>`:'â€”'}</td>
    </tr>`;
  });
  document.getElementById('aylik-tbody').innerHTML=rows.join('');

  const el=document.getElementById('chart-aylik');
  if(chartAylikOzetInstance){chartAylikOzetInstance.destroy();}
  chartAylikOzetInstance=new Chart(el,{type:'bar',data:{
    labels,
    datasets:[
      {label:'Fatura',data:faturalar,backgroundColor:'rgba(88,166,255,.5)',borderRadius:4},
      {label:'Tahsilat',data:tahsilatlar,backgroundColor:'rgba(63,185,80,.5)',borderRadius:4}
    ]},
    options:{responsive:true,plugins:{legend:{labels:{color:'#8b949e'}}},
      scales:{x:{ticks:{color:'#8b949e'},grid:{color:'#21262d'}},
              y:{ticks:{color:'#8b949e',callback:v=>fmt(v)},grid:{color:'#21262d'}}}}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderVade(){
  document.getElementById('vade-bugun').textContent=fmtDate(today());

  const allVadeEntries=[];
  DB.odemeler.filter(o=>!o.arsiv).forEach(o=>{
    const musteri=o.musteri||getMusteri(o.isNo)||'â€”';
    if(o.vadeler && o.vadeler.length>0){
      o.vadeler.forEach((v,i)=>{
        if(!v.tarih || !v.tutar) return;
        allVadeEntries.push({
          ...o,
          vade: v.tarih,
          kalan: v.tutar,
          _vadeTxt: `${i+1}. vade (${fmt(v.tutar)})`,
          musteri
        });
      });
    } else if(o.vade && o.kalan>0){
      allVadeEntries.push({...o, musteri, _vadeTxt: ''});
    }
    if(o.cek>0 && o.cekTarih && (!o.cekDurum || o.cekDurum==='Beklemede')){
      allVadeEntries.push({
        ...o,
        vade: o.cekTarih,
        kalan: o.cek,
        _vadeTxt: `ğŸ—’ Ã‡ek tahsil${o.cekNo?' (#'+o.cekNo+')':''}`,
        musteri
      });
    }

  });

  const gec=allVadeEntries.filter(o=>diffDays(o.vade)<0).sort((a,b)=>a.vade.localeCompare(b.vade));
  const hft=allVadeEntries.filter(o=>diffDays(o.vade)>=0&&diffDays(o.vade)<=7);
  const ay =allVadeEntries.filter(o=>diffDays(o.vade)>7&&diffDays(o.vade)<=31);
  // TÃ¼m AÃ§Ä±k Vadeler: sadece Ã¼stteki bÃ¶lÃ¼mlerde gÃ¶sterilmeyenler (>31 gÃ¼n sonrasÄ±)
  const tum=allVadeEntries.filter(o=>diffDays(o.vade)>31);

  document.getElementById('badge-vade').textContent=gec.length;
  document.getElementById('badge-vade').style.display=gec.length>0?'':'none';

  const makeSection=(title,list,color,bg)=>{
    if(list.length===0&&color==='red') return `<div class="card mb-16" style="border-color:rgba(63,185,80,.3)">
      <div style="text-align:center;padding:20px;color:var(--green)">âœ“ ${title} â€” GecikmiÅŸ Ã¶deme yok</div></div>`;
    if(list.length===0) return '';
    const rows=list.map(o=>{
      const musteri=o.musteri||getMusteri(o.isNo)||'â€”';
      const tad=DB.tadilatlar.find(t=>t.id===o.isNo);
      return `<tr>
        <td class="mono">#${o.isNo}</td>
        <td><div class="font-medium">${esc(o.musteri)||'â€”'}</div>
          ${o._vadeTxt?`<div class="text-xs" style="color:var(--purple)">${esc(o._vadeTxt)}</div>`:''}</td>
        <td class="mono ${o.kalan>0?'text-red':''}">${fmt(o.kalan)}</td>
        <td>${fmtDate(o.vade)}</td>
        <td>${vadeBadge(o.vade,o.kalan)}</td>
        <td class="text-sm">${esc(tad?.tel)||'â€”'}</td>
        <td class="text-sm text-muted">${esc(o.not)||'â€”'}</td>
      </tr>`;
    }).join('');
    return `<div class="card" style="margin-bottom:16px;border-color:rgba(var(--${color}-rgb),.3)">
      <div class="card-header">
        <div class="card-title" style="color:var(--${color})">${title}</div>
        <span class="badge badge-${color}">${list.length} kayÄ±t</span></div>
      <div class="tbl-wrap"><table>
        <thead><tr><th>No</th><th>MÃ¼ÅŸteri</th><th>Kalan BorÃ§</th><th>Vade</th><th>Durum</th><th>Telefon</th><th>Not</th></tr></thead>
        <tbody>${rows}</tbody></table></div></div>`;
  };

  document.getElementById('vade-sections').innerHTML=
    makeSection('ğŸ”´ GecikmiÅŸ Ã–demeler',gec,'red')+
    makeSection('ğŸŸ¡ Bu Hafta Vadeli',hft,'yellow')+
    makeSection('ğŸŸ¢ Bu Ay Vadeli',ay,'green')+
    (tum.length>0?makeSection('ğŸ“‹ Ä°lerideki Vadeler (31+ gÃ¼n)',tum,'blue'):'');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMusteriKarti(){
  const q=document.getElementById('mk-search')?.value?.trim().toLowerCase()||'';
  const res=document.getElementById('mk-result');
  if(!q){ res.innerHTML='<div style="text-align:center;padding:40px;color:var(--text3)">MÃ¼ÅŸteri adÄ± veya Ä°ÅŸ No yazÄ±n</div>'; return; }
  const showArsiv = document.getElementById('mk-show-arsiv')?.checked||false;
  const isler=DB.tadilatlar.filter(t=>{
    if(!showArsiv && t.arsiv) return false;
    return (t.musteri?.toLowerCase().includes(q))||(t.id+''===q);
  });
  if(isler.length===0){
    res.innerHTML='<div class="card" style="text-align:center;padding:40px;color:var(--text3)">EÅŸleÅŸen kayÄ±t bulunamadÄ±</div>'; return;
  }
  const musteri=isler[0].musteri||'';
  const tad2odm=id=>DB.odemeler.find(o=>o.isNo===id);
  const toplamFat=isler.reduce((s,t)=>{const o=tad2odm(t.id);return s+(o?.tutar||0);},0);
  const toplamKal=isler.reduce((s,t)=>{const o=tad2odm(t.id);return s+(o?.kalan||0);},0);
  const tel=isler[0].tel||'â€”';

  const rows=isler.map(t=>{
    const o=tad2odm(t.id);
    return `<tr>
      <td class="mono">#${t.id}</td><td>${fmtDate(t.tarih)}</td>
      <td>${t.isTipi||'â€”'}</td><td class="text-sm text-muted">${esc(t.marka)||''} ${esc(t.model)||''}</td>
      <td>${(t.ustalar||[{usta:t.usta||'â€”'}]).map(u=>esc(u.usta)).filter(Boolean).join(', ')||'â€”'}</td><td>${durum2badge(t.durum)}</td>
      <td class="mono">${o?fmt(o.tutar):'â€”'}</td>
      <td class="mono ${o?.kalan>0?'text-red':'text-green'}">${o?fmt(o.kalan):'â€”'}</td>
    </tr>`;
  }).join('');

  res.innerHTML=`
    <div class="card" style="margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:16px">
        <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--navy),var(--blue));
          display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">ğŸ‘¤</div>
        <div style="flex:1">
          <div style="font-size:18px;font-weight:700">${musteri}</div>
          <div class="text-sm text-muted">ğŸ“ ${tel}</div>
        </div>
        <div style="display:flex;gap:12px">
          <div style="text-align:center;padding:12px 20px;background:var(--surface2);border-radius:var(--r8)">
            <div class="text-xs text-muted">Toplam Ä°ÅŸ</div>
            <div style="font-size:22px;font-weight:700;color:var(--blue)">${isler.length}</div></div>
          <div style="text-align:center;padding:12px 20px;background:var(--surface2);border-radius:var(--r8)">
            <div class="text-xs text-muted">Toplam Fatura</div>
            <div style="font-size:18px;font-weight:700;color:var(--green)">${fmt(toplamFat)}</div></div>
          <div style="text-align:center;padding:12px 20px;background:var(--surface2);border-radius:var(--r8)">
            <div class="text-xs text-muted">Kalan BorÃ§</div>
            <div style="font-size:18px;font-weight:700;color:${toplamKal>0?'var(--red)':'var(--green)'}">${fmt(toplamKal)}</div></div>
        </div>
      </div>
    </div>
    <div class="card" style="padding:0"><div class="tbl-wrap"><table>
      <thead><tr><th>#</th><th>Tarih</th><th>Ä°ÅŸ</th><th>Kombi</th><th>Usta</th><th>Durum</th><th>Fatura</th><th>Kalan</th></tr></thead>
      <tbody>${rows}</tbody></table></div></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFiyatListesi(){
  const ustalar=DB.tanimlar.ustalar;
  const isTipleri=DB.tanimlar.isTipleri;
  document.getElementById('fiyat-thead').innerHTML=
    `<tr><th>Ä°ÅŸ Tipi</th>${ustalar.map(u=>`<th>${u.replace(' Usta','')}</th>`).join('')}</tr>`;
  document.getElementById('fiyat-tbody').innerHTML=isTipleri.map((it,ri)=>
    `<tr><td class="text-sm">${it}</td>${ustalar.map(u=>`<td>
      <input type="number" value="${DB.fiyatlar[u]?.[it]||''}" placeholder="0"
        class="form-input" style="padding:4px 8px;font-size:12px;font-family:var(--mono)"
        data-usta="${u}" data-is="${it}" onchange="fiyatChange(this)">
    </td>`).join('')}</tr>`
  ).join('');
}

function fiyatChange(el){
  const usta=el.dataset.usta, is=el.dataset.is;
  if(!DB.fiyatlar[usta]) DB.fiyatlar[usta]={};
  const v=parseFloat(el.value)||0;
  if(v>0) DB.fiyatlar[usta][is]=v;
  else delete DB.fiyatlar[usta][is];
  saveDB();
  const ind=document.getElementById('fiyat-kayit-ind');
  if(ind){
    ind.textContent='âœ“ Otomatik kaydedildi';
    ind.style.opacity='1';
    clearTimeout(ind._t);
    ind._t=setTimeout(()=>{ ind.style.opacity='0'; }, 2000);
  }
}

function saveFiyat(){ saveDBNow(); toast('Fiyat listesi kaydedildi','success'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTanimlar(){
  document.getElementById('tanim-ustalar').value=DB.tanimlar.ustalar.join('\n');
  document.getElementById('tanim-is').value=DB.tanimlar.isTipleri.join('\n');
  document.getElementById('tanim-gider-kat').value=(DB.giderKategorileri||[]).join('\n');
  const me=document.getElementById('marka-editor');
  me.innerHTML='';
  Object.entries(DB.tanimlar.markalar).forEach(([marka,modeller])=>{
    const d=document.createElement('div');
    d.style.marginBottom='12px';
    d.innerHTML=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
      <input type="text" class="form-input" value="${marka}" data-marka-name="${marka}"
        style="font-weight:600" oninput="markaRename(this,'${marka}')">
      <button class="btn-icon btn-sm" onclick="deleteMarka('${marka}')" style="color:var(--red)">ğŸ—‘</button>
    </div>
    <textarea class="form-textarea" data-marka="${marka}" style="min-height:100px;font-size:12px">${modeller.join('\n')}</textarea>`;
    me.appendChild(d);
  });
}

function markaRename(el,eskiIsim){
  const yeni=el.value.trim();
  if(!yeni||yeni===eskiIsim) return;
  const modeller=DB.tanimlar.markalar[eskiIsim];
  delete DB.tanimlar.markalar[eskiIsim];
  DB.tanimlar.markalar[yeni]=modeller;
}

async function deleteMarka(marka){
  const ok = await customConfirm(`"${marka}" markasÄ±nÄ± silmek istiyor musunuz?`, 'Marka Sil', 'ğŸ—‘ Sil', true);
  if(!ok) return;
  delete DB.tanimlar.markalar[marka];
  saveDB(); renderTanimlar();
}

function addMarka(){
  DB.tanimlar.markalar['Yeni Marka']=['Model 1'];
  saveDB(); renderTanimlar();
}

function saveTanimlar(){
  DB.tanimlar.ustalar=document.getElementById('tanim-ustalar').value.split('\n').map(s=>s.trim()).filter(Boolean);
  DB.tanimlar.isTipleri=document.getElementById('tanim-is').value.split('\n').map(s=>s.trim()).filter(Boolean);
  DB.giderKategorileri=document.getElementById('tanim-gider-kat').value.split('\n').map(s=>s.trim()).filter(Boolean);
  // FIX3: Marka adi degistiginde eski data-marka attribute gecersiz kalir.
  // Her div icindeki input'tan guncel adi oku.
  const yeniMarkalar = {};
  document.querySelectorAll('#marka-editor > div').forEach(div=>{
    const nameInput = div.querySelector('input[data-marka-name]');
    const ta = div.querySelector('textarea[data-marka]');
    if(!nameInput || !ta) return;
    const yeniAd = nameInput.value.trim();
    if(!yeniAd) return;
    yeniMarkalar[yeniAd] = ta.value.split('\n').map(s=>s.trim()).filter(Boolean);
  });
  DB.tanimlar.markalar = yeniMarkalar;
  saveDB(); toast('TanÄ±mlar kaydedildi','success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WIDGET_DEFS=[
  {key:'son_isler',label:'Son Ä°ÅŸ Emirleri',icon:'ğŸ”§'},
  {key:'gecikmiÅŸ_odemeler',label:'GecikmiÅŸ Ã–demeler',icon:'âš ï¸'},
  {key:'aylik_trend',label:'AylÄ±k Trend GrafiÄŸi',icon:'ğŸ“ˆ'},
  {key:'odeme_dagilim',label:'Ã–deme DaÄŸÄ±lÄ±mÄ±',icon:'ğŸ¥§'},
  {key:'usta_performans',label:'Usta PerformansÄ±',icon:'ğŸ‘·'},
];

function openWidgetSettings(){
  const body=document.getElementById('widget-settings-body');
  body.innerHTML=`<div style="display:flex;flex-direction:column;gap:12px">
    ${WIDGET_DEFS.map(w=>`
    <label style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface2);
      border-radius:var(--r8);cursor:pointer;border:1px solid var(--border)">
      <input type="checkbox" id="wck-${w.key}" ${DB.widgets[w.key]?'checked':''} style="width:16px;height:16px;accent-color:var(--blue)">
      <span style="font-size:18px">${w.icon}</span>
      <span class="font-medium">${w.label}</span>
    </label>`).join('')}
  </div>`;
  openModal('modal-widgets');
}

function applyWidgets(){
  WIDGET_DEFS.forEach(w=>{
    DB.widgets[w.key]=document.getElementById('wck-'+w.key)?.checked||false;
  });
  saveDB(); closeModal('modal-widgets'); renderDashboard();
  toast('Widget ayarlarÄ± gÃ¼ncellendi','success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let haftaOffset = 0;

function haftaDegistir(offset){
  if(offset===0){ haftaOffset=0; }
  else{
    haftaOffset+=offset;
    haftaOffset=Math.max(-52,Math.min(52,haftaOffset));
  }
  renderUstaProgrami();
}

function haftaBaslangic(offset=0){
  const d=new Date();
  const gun=d.getDay();
  const diff=d.getDate()-(gun===0?6:gun-1);
  const pts=new Date(d.setDate(diff));
  pts.setDate(pts.getDate()+offset*7);
  return pts;
}

function renderUstaProgrami(){
  const pts=haftaBaslangic(haftaOffset);
  const gunler=[];
  for(let i=0;i<7;i++){
    const g=new Date(pts);
    g.setDate(pts.getDate()+i);
    gunler.push(g);
  }
  const gunAdlari=['Pzt','Sal','Ã‡ar','Per','Cum','Cmt','Paz'];
  const isoGunler=gunler.map(g=>g.toISOString().slice(0,10));
  const haftaSonu=`${gunler[0].toLocaleDateString('tr-TR',{day:'numeric',month:'long'})} â€“ ${gunler[6].toLocaleDateString('tr-TR',{day:'numeric',month:'long',year:'numeric'})}`;
  document.getElementById('up-hafta-label').textContent=haftaSonu;

  const ustalar=DB.tanimlar.ustalar;

  const showArsiv = document.getElementById('prog-show-arsiv')?.checked||false;
  const islerHaftada=DB.tadilatlar.filter(t=>{
    if(!showArsiv && t.arsiv) return false;
    const aktifTarih = t.baslama || t.tarih;
    return isoGunler.includes(aktifTarih);
  });

  const toplamIs=islerHaftada.length;
  const tamIs=islerHaftada.filter(t=>t.durum==='TamamlandÄ±').length;
  const devamIs=islerHaftada.filter(t=>t.durum==='Devam Ediyor').length;
  const ustaSayisi=new Set(islerHaftada.flatMap(t=>(t.ustalar||[{usta:t.usta}]).map(u=>u.usta).filter(Boolean))).size;

  const kpiHTML=`<div class="kpi-grid" style="margin-bottom:20px">
    <div class="kpi-card blue"><div class="kpi-icon">ğŸ”§</div>
      <div class="kpi-label">Bu Hafta Ä°ÅŸ</div><div class="kpi-value">${toplamIs}</div></div>
    <div class="kpi-card green"><div class="kpi-icon">âœ…</div>
      <div class="kpi-label">Tamamlanan</div><div class="kpi-value">${tamIs}</div></div>
    <div class="kpi-card yellow"><div class="kpi-icon">âš™ï¸</div>
      <div class="kpi-label">Devam Eden</div><div class="kpi-value">${devamIs}</div></div>
    <div class="kpi-card purple"><div class="kpi-icon">ğŸ‘·</div>
      <div class="kpi-label">Aktif Usta</div><div class="kpi-value">${ustaSayisi}</div></div>
  </div>`;

  const gunBasliklari=gunler.map((g,i)=>{
    const iso=isoGunler[i];
    const isToday=iso===today();
    const gunIsler=islerHaftada.filter(t=>(t.baslama||t.tarih)===iso);
    return `<th style="text-align:center;${isToday?'color:var(--green);background:rgba(63,185,80,.08)':''}">
      <div style="font-size:13px;font-weight:700">${gunAdlari[i]}</div>
      <div style="font-size:11px;color:var(--text2)">${g.toLocaleDateString('tr-TR',{day:'numeric',month:'short'})}</div>
      ${gunIsler.length>0?`<div style="font-size:10px;color:var(--blue);margin-top:2px">${gunIsler.length} iÅŸ</div>`:''}
    </th>`;
  }).join('');

  // HÄ±zlandÄ±rma: gÃ¼nlÃ¼k iÅŸ Map'i Ã¶nceden oluÅŸtur
  const gunIsleriMap = {};
  islerHaftada.forEach(t=>{
    const tarih = t.baslama||t.tarih;
    if(!gunIsleriMap[tarih]) gunIsleriMap[tarih]=[];
    gunIsleriMap[tarih].push(t);
  });

  // #2 FIX: ustaHaftaIsMap'i ustaRows'tan Ã–NCE oluÅŸtur
  const ustaHaftaIsMap = {};
  ustalar.forEach(usta=>{
    ustaHaftaIsMap[usta] = islerHaftada.filter(t=>(t.ustalar||[{usta:t.usta}]).some(u=>u.usta===usta));
  });

  const ustaRows=ustalar.map(usta=>{
    const gunHucreleri=gunler.map((g,i)=>{
      const iso=isoGunler[i];
      const isToday=iso===today();
      const gunIsler=(gunIsleriMap[iso]||[]).filter(t=>
        (t.ustalar||[{usta:t.usta}]).some(u=>u.usta===usta));

      if(gunIsler.length===0) return `<td style="padding:8px;${isToday?'background:rgba(63,185,80,.04)':''}">
        <div style="color:var(--text3);font-size:11px;text-align:center">â€”</div></td>`;

      const kartlar=gunIsler.map(t=>{
        const buUstaIsler=(t.ustalar||[{usta:t.usta,isTipi:t.isTipi,fiyat:0}]).filter(u=>u.usta===usta);
        const renkMap={'TamamlandÄ±':'green','Devam Ediyor':'yellow','Beklemede':'blue','Ä°ptal':'red'};
        const renk=renkMap[t.durum]||'gray';
        return `<div style="background:var(--surface2);border:1px solid rgba(var(--${renk}-rgb),.3);
          border-left:3px solid var(--${renk});border-radius:var(--r8);padding:6px 8px;margin-bottom:4px;cursor:pointer"
          onclick="editTadilat(${t.id});navigate('tadilatlar')">
          <div style="font-size:12px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.musteri)||'â€”'}</div>
          ${buUstaIsler.map(u=>`<div style="font-size:11px;color:var(--text2)">${esc(u.isTipi)||''}</div>`).join('')}
          ${t.tel ? '<div style="font-size:10px;color:var(--blue);margin-top:1px">ğŸ“ '+esc(t.tel)+'</div>' : ''}
          <div style="font-size:10px;color:var(--text3);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(t.adres)||''}</div>
          ${t.aciklama ? '<div style="font-size:10px;color:var(--text2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">ğŸ“ '+esc(t.aciklama)+'</div>' : ''}
        </div>`;
      }).join('');

      return `<td style="padding:6px;vertical-align:top;min-width:120px;${isToday?'background:rgba(63,185,80,.04)':''}">
        ${kartlar}</td>`;
    }).join('');

    const haftaIsler=ustaHaftaIsMap[usta]||[];
    const tamPct=haftaIsler.length>0?Math.round(haftaIsler.filter(t=>t.durum==='TamamlandÄ±').length/haftaIsler.length*100):0;

    return `<tr>
      <td style="padding:10px 12px;border-right:1px solid var(--border);background:var(--surface2);
        white-space:nowrap;position:sticky;left:0;z-index:1">
        <div style="font-weight:600;font-size:13px">${usta}</div>
        <div style="font-size:11px;color:var(--text2)">${haftaIsler.length} iÅŸ</div>
        ${haftaIsler.length>0?`<div class="progress" style="margin-top:4px;width:80px">
          <div class="progress-fill" style="width:${tamPct}%;background:var(--green)"></div></div>
          <div style="font-size:10px;color:var(--text3)">${tamPct}%</div>`:''}
      </td>
      ${gunHucreleri}
    </tr>`;
  }).join('');

  const yuklOzet=ustalar.map(usta=>{
    const haftaIsler=ustaHaftaIsMap[usta]||[];
    if(haftaIsler.length===0) return '';
    const tam=haftaIsler.filter(t=>t.durum==='TamamlandÄ±').length;
    const dev=haftaIsler.filter(t=>t.durum==='Devam Ediyor').length;
    const bek=haftaIsler.filter(t=>t.durum==='Beklemede').length;
    const hakediÅŸ=haftaIsler.reduce((s,t)=>{
      const uIsler=(t.ustalar||[{usta:t.usta,isTipi:t.isTipi,fiyat:0}]).filter(u=>u.usta===usta);
      return s+uIsler.reduce((ss,u)=>ss+(u.fiyat||getFiyat(usta,u.isTipi)||0),0);
    },0);
    return `<div style="padding:12px;background:var(--surface2);border:1px solid var(--border);
      border-radius:var(--r8)">
      <div style="font-weight:700;margin-bottom:8px">${usta}</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px">
        <div><div class="text-xs text-muted">Toplam</div><div style="font-size:18px;font-weight:700;color:var(--blue)">${haftaIsler.length}</div></div>
        <div><div class="text-xs text-muted">Tamam</div><div style="font-size:18px;font-weight:700;color:var(--green)">${tam}</div></div>
        <div><div class="text-xs text-muted">Devam</div><div style="font-size:18px;font-weight:700;color:var(--yellow)">${dev}</div></div>
        <div><div class="text-xs text-muted">HakediÅŸ</div><div style="font-size:14px;font-weight:700;color:var(--purple)">${hakediÅŸ>0?fmt(hakediÅŸ):'â€”'}</div></div>
      </div>
    </div>`;
  }).filter(Boolean).join('');

  document.getElementById('up-content').innerHTML=`
    ${kpiHTML}
    <div class="card" style="padding:0;margin-bottom:16px;overflow-x:auto">
      <table style="min-width:900px">
        <thead><tr>
          <th style="position:sticky;left:0;background:var(--surface2);z-index:2;min-width:120px">Usta</th>
          ${gunBasliklari}
        </tr></thead>
        <tbody>${ustaRows}</tbody>
      </table>
    </div>
    ${yuklOzet?`<div class="section-title">Bu Hafta Usta YÃ¼k Ã–zeti</div>
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px">${yuklOzet}</div>`:''}
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let hdChartKat = null, hdChartAylik = null;

function updateHdKategori(){
  const tip = document.getElementById('f-hd-tip')?.value;
  const sel = document.getElementById('f-hd-kategori');
  if(!sel) return;
  const gelirKat = ['MÃ¼ÅŸteri Ã–demesi','Avans','DiÄŸer Gelir'];
  const giderKat = DB.giderKategorileri||[];
  const list = tip==='gelir' ? gelirKat : giderKat;
  sel.innerHTML = list.map(k=>`<option>${k}</option>`).join('');
}

function saveHdManuel(){
  const g = id => document.getElementById(id)?.value?.trim();
  const tutar = parseFloat(g('f-hd-tutar'))||0;
  if(!tutar){ toast('Tutar zorunlu','error'); return; }
  DB.hesapDefteri.push({
    id: Date.now()+'',
    tarih: g('f-hd-tarih')||today(),
    tip:   g('f-hd-tip'),
    kategori: g('f-hd-kategori'),
    tutar,
    aciklama: g('f-hd-aciklama'),
    otomatik: false
  });
  saveDB(); closeModal('modal-hd'); renderHesapDefteri();
  toast('KayÄ±t eklendi','success');
}

function hdOtomatikGelirEkle(odeme, eskiToplamOdenen){
  // Ã–nce bu Ã¶demeye ait TÃœM eski otomatik kayÄ±tlarÄ± sil (ÅŸiÅŸme Ã¶nleme)
  DB.hesapDefteri = DB.hesapDefteri.filter(h => h.kaynakId !== odeme.id+'');

  const yeniToplam = odeme.toplamOdenen || 0;
  if(yeniToplam <= 0) return; // Ã–deme sÄ±fÄ±rlandÄ±ysa kayÄ±t ekleme

  const musteri = odeme.musteri || getMusteri(odeme.isNo) || 'MÃ¼ÅŸteri';
  const detaylar = [];
  if(odeme.nakit>0)  detaylar.push('Nakit: '+fmt(odeme.nakit));
  if(odeme.kart>0)   detaylar.push('Kart: '+fmt(odeme.kart));
  if(odeme.havale>0) detaylar.push('Havale: '+fmt(odeme.havale));
  if(odeme.cek>0)    detaylar.push('Ã‡ek: '+fmt(odeme.cek));
  const aciklama = musteri+' â€” Ä°ÅŸ #'+odeme.isNo+(detaylar.length?' ('+detaylar.join(', ')+')':'');

  // GÃ¼ncel toplam tutarÄ± tek kayÄ±t olarak ekle
  // FIX4: Bugunun tarihi degil, is emrinin tarihini kullan
  const _ilgiliIs = DB.tadilatlar.find(t=>t.id===odeme.isNo);
  const _odTarih = _ilgiliIs ? (_ilgiliIs.tarih||today()) : today();
  DB.hesapDefteri.push({
    id: (typeof crypto!=='undefined'&&crypto.randomUUID) ? crypto.randomUUID() : Date.now()+'',
    tarih: _odTarih,
    tip: 'gelir',
    kategori: 'MÃ¼ÅŸteri Ã–demesi',
    tutar: yeniToplam,
    aciklama,
    kaynakId: odeme.id+'',
    otomatik: true
  });
}

function renderHesapDefteri(){
  const search = document.getElementById('hd-search')?.value?.toLowerCase()||'';
  const fTip   = document.getElementById('hd-filter-tip')?.value||'';
  const fAy    = document.getElementById('hd-filter-ay')?.value||'';

  const ayEl = document.getElementById('hd-filter-ay');
  if(ayEl){
    const mevcutSecim = ayEl.value;
    ayEl.innerHTML = '<option value="">TÃ¼m Aylar</option>';
    const aylar = [...new Set(DB.hesapDefteri.map(h=>h.tarih?.slice(0,7)).filter(Boolean))].sort().reverse();
    aylar.forEach(a=>{
      const o=document.createElement('option');
      o.value=o.textContent=a;
      if(a===mevcutSecim) o.selected=true;
      ayEl.appendChild(o);
    });
  }

  let list = [...DB.hesapDefteri].sort((a,b)=>b.tarih?.localeCompare(a.tarih||'')||0);
  if(search) list=list.filter(h=>(h.aciklama+h.kategori).toLowerCase().includes(search));
  if(fTip)   list=list.filter(h=>h.tip===fTip);
  if(fAy)    list=list.filter(h=>h.tarih?.startsWith(fAy));

  // DÃœZELTME #1: KPI artÄ±k liste ile aynÄ± filtreyi kullanÄ±yor (search dahil)
  const kpiList = list;
  const tumGelir = kpiList.filter(h=>h.tip==='gelir').reduce((s,h)=>s+(h.tutar||0),0);
  const tumGider = kpiList.filter(h=>h.tip==='gider').reduce((s,h)=>s+(h.tutar||0),0);
  const bakiye   = tumGelir - tumGider;
  const kpiBolum = [fAy, search?'Arama':'', fTip==='gelir'?'Gelirler':fTip==='gider'?'Giderler':''].filter(Boolean);
  const kpiBaslik = kpiBolum.length ? kpiBolum.join(' Â· ') : 'TÃ¼m zamanlar';
  document.getElementById('hd-kpi').innerHTML=`
    <div class="kpi-card green"><div class="kpi-icon">ğŸ“ˆ</div>
      <div class="kpi-label">Gelir <span style="font-size:10px;opacity:.7">${kpiBaslik}</span></div>
      <div class="kpi-value" style="font-size:20px">${fmt(tumGelir)}</div></div>
    <div class="kpi-card red"><div class="kpi-icon">ğŸ“‰</div>
      <div class="kpi-label">Gider <span style="font-size:10px;opacity:.7">${kpiBaslik}</span></div>
      <div class="kpi-value" style="font-size:20px">${fmt(tumGider)}</div></div>
    <div class="kpi-card ${bakiye>=0?'blue':'orange'}"><div class="kpi-icon">ğŸ’°</div>
      <div class="kpi-label">Net Bakiye</div>
      <div class="kpi-value" style="font-size:20px;color:var(--${bakiye>=0?'blue':'red'})">${fmt(Math.abs(bakiye))}</div>
      <div class="kpi-sub">${bakiye>=0?'KÃ¢r':'Zarar'}</div></div>
    <div class="kpi-card purple"><div class="kpi-icon">ğŸ“‹</div>
      <div class="kpi-label">KayÄ±t SayÄ±sÄ±</div>
      <div class="kpi-value">${kpiList.length}</div></div>
  `;

  document.getElementById('hd-sub').textContent=`${list.length} kayÄ±t gÃ¶steriliyor`;

  const tbody = document.getElementById('hd-tbody');
  tbody.innerHTML = list.length===0
    ? `<tr><td colspan="6" class="tbl-empty">KayÄ±t bulunamadÄ±</td></tr>`
    : list.map(h=>`<tr>
        <td class="text-sm">${fmtDate(h.tarih)}</td>
        <td>${h.tip==='gelir'
          ?'<span class="badge badge-green">ğŸ“ˆ Gelir</span>'
          :'<span class="badge badge-red">ğŸ“‰ Gider</span>'}</td>
        <td class="text-sm">${esc(h.kategori)||'â€”'}</td>
        <td class="text-sm">${esc(h.aciklama)||'â€”'} ${h.otomatik?'<span class="badge badge-blue" style="font-size:9px">Otomatik</span>':''}</td>
        <td class="mono font-bold ${h.tip==='gelir'?'text-green':'text-red'}">${h.tip==='gelir'?'+':'-'}${fmt(h.tutar)}</td>
        <td>${!h.otomatik?`<button class="btn-icon" onclick="deleteHdKayit('${h.id}')" style="color:var(--red)">ğŸ—‘</button>`:'â€”'}</td>
      </tr>`).join('');

  // DÃœZELTME #2: Kategori grafiÄŸi artÄ±k aktif filtreyi (ay, tip, arama) yansÄ±tÄ±yor
  const katGiderler = kpiList.filter(h=>h.tip==='gider');
  const katMap = {};
  katGiderler.forEach(h=>{ katMap[h.kategori||'DiÄŸer']=(katMap[h.kategori||'DiÄŸer']||0)+(h.tutar||0); });
  const katLabels = Object.keys(katMap);
  const katData   = Object.values(katMap);
  const el1 = document.getElementById('chart-hd-kategori');
  if(el1){
    const katHash = katLabels.join(',')+katData.join(',');
    if(katHash !== el1._lastHash){
      el1._lastHash = katHash;
      if(hdChartKat){hdChartKat.destroy();hdChartKat=null;}
      if(katLabels.length>0){
        hdChartKat=new Chart(el1,{type:'doughnut',data:{
          labels:katLabels,datasets:[{data:katData,
            backgroundColor:['rgba(255,123,114,.7)','rgba(255,166,87,.7)','rgba(227,179,65,.7)',
              'rgba(188,140,255,.7)','rgba(88,166,255,.7)','rgba(63,185,80,.7)','rgba(139,148,158,.7)'],
            borderWidth:0}]},
          options:{responsive:true,plugins:{legend:{position:'bottom',labels:{color:'#8b949e',font:{size:10}}}},cutout:'60%'}
        });
      }
    }
  }

  // DÃœZELTME #3: AylÄ±k grafik yÄ±l seÃ§icisi ile Ã§alÄ±ÅŸÄ±yor, yÄ±llar karÄ±ÅŸmÄ±yor
  const yilEl = document.getElementById('hd-chart-yil');
  const mevcutYillar = [...new Set(DB.hesapDefteri.map(h=>h.tarih?.slice(0,4)).filter(Boolean))].sort().reverse();
  if(yilEl){
    const mevcutSecimYil = yilEl.value || new Date().getFullYear()+'';
    yilEl.innerHTML = mevcutYillar.map(y=>`<option value="${y}" ${y===mevcutSecimYil?'selected':''}>${y}</option>`).join('');
  }
  const chartYil = yilEl?.value || new Date().getFullYear()+'';

  const el2 = document.getElementById('chart-hd-aylik');
  if(el2){
    const gelirAy=new Array(12).fill(0), giderAy=new Array(12).fill(0);
    DB.hesapDefteri.forEach(h=>{
      if(!h.tarih || h.tarih.slice(0,4) !== chartYil) return;
      const mi = new Date(h.tarih).getMonth();
      if(h.tip==='gelir') gelirAy[mi]+=(h.tutar||0);
      else if(h.tip==='gider') giderAy[mi]+=(h.tutar||0);
    });
    const ayHash = chartYil + gelirAy.join(',') + giderAy.join(',');
    if(ayHash !== el2._lastHash){
      el2._lastHash = ayHash;
      if(hdChartAylik){hdChartAylik.destroy();hdChartAylik=null;}
      hdChartAylik=new Chart(el2,{type:'bar',data:{
        labels:AYLAR.map(a=>a.slice(0,3)),
        datasets:[
          {label:'Gelir',data:gelirAy,backgroundColor:'rgba(63,185,80,.6)',borderRadius:4},
          {label:'Gider',data:giderAy,backgroundColor:'rgba(255,123,114,.6)',borderRadius:4}
        ]},
        options:{responsive:true,plugins:{legend:{labels:{color:'#8b949e',font:{size:10}}}},
          scales:{x:{ticks:{color:'#8b949e'},grid:{color:'#21262d'}},
                  y:{ticks:{color:'#8b949e',callback:v=>fmt(v)},grid:{color:'#21262d'}}}}
      });
    }
  }
}

async function deleteHdKayit(id){
  const kayit = DB.hesapDefteri.find(h=>h.id===id);
  if(!kayit) return;
  let msg = 'Bu kaydÄ± silmek istiyor musunuz?';
  if(kayit.otomatik) msg = 'Bu kayÄ±t bir Ã¶deme iÅŸleminden otomatik oluÅŸturulmuÅŸ. Silmek muhasebe tutarsÄ±zlÄ±ÄŸÄ±na yol aÃ§abilir. Yine de silinsin mi?';
  const ok = await customConfirm(msg, 'KaydÄ± Sil', 'ğŸ—‘ Sil', true);
  if(!ok) return;
  DB.hesapDefteri=DB.hesapDefteri.filter(h=>h.id!==id);
  saveDB(); renderHesapDefteri(); toast('KayÄ±t silindi');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  // Aktif sayfayÄ± _activePage cache'inden al (querySelectorAll yok)
  const active = _activePage || document.querySelector('.page.active')?.id?.replace('page-','');
  const renders={
    dashboard:renderDashboard, tadilatlar:renderTadilatlar,
    odemeler:renderOdemeler, ustalar:renderUstalar,
    aylik:renderAylik, vade:renderVade,
    'musteri-karti':renderMusteriKarti,
    'usta-programi':renderUstaProgrami,
    'tadilatlar-arsiv':renderTadilatlarArsiv,
    'odemeler-arsiv':renderOdemelerArsiv,
    'ustalar-arsiv':renderUstalarArsiv,
    'hesap-defteri':renderHesapDefteri,
    'fiyat-listesi':renderFiyatListesi,
    tanimlar:renderTanimlar,
    personel:renderPersonel,
    cari:renderCari
  };
  if(active && renders[active]) renders[active]();
  updateBadges();
}

function updateYedekGostergesi(){
  const el = document.getElementById('yedek-gosterge');
  if(!el) return;
  const sonYedek = localStorage.getItem('royal_son_yedek');
  if(!sonYedek){ el.textContent='Yedek alÄ±nmadÄ±'; el.style.color='var(--red)'; return; }
  const fark = Math.floor((new Date(today())-new Date(sonYedek))/(1000*60*60*24));
  if(fark===0){ el.textContent='âœ“ BugÃ¼n yedeklendi'; el.style.color='var(--green)'; }
  else if(fark<7){ el.textContent=`${fark}g Ã¶nce yedeklendi`; el.style.color='var(--text2)'; }
  else { el.textContent=`âš  ${fark}g Ã¶nce yedeklendi`; el.style.color='var(--yellow)'; }
}

function toggleSidebar(){
  const sb = document.getElementById('sidebar');
  const ov = document.getElementById('sidebar-overlay');
  const isOpen = sb.classList.toggle('mobile-open');
  ov.classList.toggle('mobile-open', isOpen);
}

function toggleTheme(){
  document.body.classList.add('theme-transitioning');
  const isLight = document.body.classList.toggle('light-mode');
  document.getElementById('theme-icon').textContent = isLight ? 'ğŸŒ™' : 'â˜€ï¸';
  document.getElementById('theme-label').textContent = isLight ? 'Gece' : 'GÃ¼ndÃ¼z';
  localStorage.setItem('royal_theme', isLight ? 'light' : 'dark');
  setTimeout(()=>document.body.classList.remove('theme-transitioning'), 300);
}

function applyTheme(){
  const saved = localStorage.getItem('royal_theme');
  if(saved === 'light'){
    document.body.classList.add('light-mode');
    const icon = document.getElementById('theme-icon');
    const label = document.getElementById('theme-label');
    if(icon) icon.textContent = 'ğŸŒ™';
    if(label) label.textContent = 'Gece';
  }
}

function updateBadges(){
  // Vade badge â€” filter yerine for loop (daha hÄ±zlÄ±, ilk eÅŸleÅŸmede sayÄ±m)
  let gec=0;
  const odms = DB.odemeler;
  for(let i=0,l=odms.length;i<l;i++){
    const o=odms[i];
    if(o.vade && o.kalan>0 && diffDays(o.vade)<0) gec++;
  }
  const badge=document.getElementById('badge-vade');
  if(badge){ badge.textContent=gec; badge.style.display=gec>0?'':'none'; }

  // Cari badge â€” O(nÂ²) yerine O(n): Ã¶nce firma baÅŸÄ±na bakiye Map'i oluÅŸtur
  const badgeCari = document.getElementById('badge-cari');
  if(badgeCari){
    const bakiyeMap = {};
    (DB.cariFirmalar||[]).forEach(f=>{ bakiyeMap[f.id]=0; });
    (DB.cariHareketler||[]).forEach(h=>{
      if(bakiyeMap[h.firmaId]===undefined) return;
      bakiyeMap[h.firmaId] += h.tip==='borc' ? (h.tutar||0) : -(h.tutar||0);
    });
    const acikFirma = Object.values(bakiyeMap).filter(v=>Math.abs(v)>0.01).length;
    badgeCari.textContent=acikFirma;
    badgeCari.style.display=acikFirma>0?'':'none';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded',()=>{
  applyTheme();
  _fsUpdateUI();

  window.addEventListener('beforeunload', ()=>{ saveDBNow(); });
  document.querySelectorAll('.modal-overlay').forEach(overlay=>{
    overlay.addEventListener('click', e=>{
      if(e.target===overlay) closeModal(overlay.id);
    });
  });
  document.getElementById('sb-date').textContent=new Date().toLocaleDateString('tr-TR',
    {weekday:'short',day:'numeric',month:'short',year:'numeric'});
  document.getElementById('vade-bugun').textContent=fmtDate(today());

  // Supabase auth kontrolÃ¼
  _supabase.auth.getSession().then(({ data: { session } }) => {
    if (session) {
      _showApp();
    } else {
      document.getElementById('login-screen').classList.remove('hidden');
    }
  });

  _supabase.auth.onAuthStateChange((_event, session) => {
    if (session) {
      _showApp();
    } else {
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('app').style.display = 'none';
    }
  });

  setTimeout(()=>{ updateYedekGostergesi(); }, 1200);
});


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// USTA HAKEDÄ°Å EXCEL EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openUstaExportModal(){
  const sel = document.getElementById('exp-usta-sec');
  sel.innerHTML = '<option value="__tumustalar__">ğŸ‘· TÃ¼m Ustalar</option>';
  (DB.tanimlar.ustalar||[]).forEach(u=>{
    const o = document.createElement('option');
    o.value = u; o.textContent = u;
    sel.appendChild(o);
  });
  const bugun = today();
  const ayBasi = bugun.substring(0,7)+'-01';
  document.getElementById('exp-is-bas').value = ayBasi;
  document.getElementById('exp-is-bit').value = bugun;
  document.getElementById('exp-odm-bas').value = ayBasi;
  document.getElementById('exp-odm-bit').value = bugun;
  document.getElementById('exp-is-filtre-ac').checked = true;
  document.getElementById('exp-odm-filtre-ac').checked = true;
  document.getElementById('exp-onizleme').style.display='none';
  toggleExportFilter('is');
  toggleExportFilter('odm');
  openModal('modal-usta-export');
}

function toggleExportFilter(tip){
  const isAc = document.getElementById('exp-is-filtre-ac').checked;
  const odmAc = document.getElementById('exp-odm-filtre-ac').checked;
  ['exp-is-bas','exp-is-bit'].forEach(id=>document.getElementById(id).disabled = !isAc);
  ['exp-odm-bas','exp-odm-bit'].forEach(id=>document.getElementById(id).disabled = !odmAc);
}

function _getExportParams(){
  const ustaVal = document.getElementById('exp-usta-sec').value;
  const ustalar2 = ustaVal === '__tumustalar__' ? (DB.tanimlar.ustalar||[]) : [ustaVal];
  const isFiltre = document.getElementById('exp-is-filtre-ac').checked;
  const odmFiltre = document.getElementById('exp-odm-filtre-ac').checked;
  const isBas = isFiltre ? document.getElementById('exp-is-bas').value : '';
  const isBit = isFiltre ? document.getElementById('exp-is-bit').value : '';
  const odmBas = odmFiltre ? document.getElementById('exp-odm-bas').value : '';
  const odmBit = odmFiltre ? document.getElementById('exp-odm-bit').value : '';
  const sheetTip = document.querySelector('input[name="exp-sheet-tip"]:checked').value;
  return {ustalar: ustalar2, isFiltre, odmFiltre, isBas, isBit, odmBas, odmBit, sheetTip};
}

function _buildUstaData(usta, params){
  const {isFiltre, isBas, isBit, odmFiltre, odmBas, odmBit} = params;

  let isler = DB.tadilatlar.filter(t=>
    (t.ustalar||[{usta:t.usta}]).some(u=>u.usta===usta)
  );
  if(isFiltre && (isBas || isBit)){
    isler = isler.filter(t=>{
      const d = t.baslama||t.tarih||'';
      return (!isBas || d >= isBas) && (!isBit || d <= isBit);
    });
  }

  const hakedisRows = isler.slice().sort((a,b)=>{
    const da=a.baslama||a.tarih||'', db=b.baslama||b.tarih||'';
    return da < db ? -1 : da > db ? 1 : 0;
  }).map(t=>{
    const uIsler = (t.ustalar||[{usta:t.usta,isTipi:t.isTipi,fiyat:0}]).filter(u=>u.usta===usta);
    const isHak = uIsler.reduce((s,u)=>s+(u.fiyat||getFiyat(usta,u.isTipi)||0),0);
    const isAdlari = uIsler.map(u=>u.isTipi||'').filter(Boolean).join(', ');
    return {
      tarih: fmtDate(t.baslama||t.tarih),
      isNo: '#'+t.id,
      musteri: t.musteri||'â€”',
      adres: t.adres||'',
      isler: isAdlari||'â€”',
      hakedis: isHak,
      durum: t.durum||''
    };
  });

  let odmler = (DB.ustaOdemeleri[usta]||[]).filter(o=>!o.arsiv);
  if(odmFiltre && (odmBas || odmBit)){
    odmler = odmler.filter(o=>{
      const d = o.tarih||'';
      return (!odmBas || d >= odmBas) && (!odmBit || d <= odmBit);
    });
  }
  const odmRows = odmler.slice().sort((a,b)=> a.tarih < b.tarih ? -1 : 1).map(o=>({
    tarih: fmtDate(o.tarih),
    aciklama: o.aciklama||'Ã–deme',
    tur: o.tur||'Nakit',
    tutar: o.tutar||0
  }));

  const topHakedis = hakedisRows.reduce((s,r)=>s+r.hakedis,0);
  const topOdenen = odmRows.reduce((s,r)=>s+r.tutar,0);

  return {hakedisRows, odmRows, topHakedis, topOdenen};
}

function ustaExportOnizle(){
  const params = _getExportParams();
    let html = '<div style="font-weight:700;margin-bottom:8px">ğŸ“Š Ã–nizleme:</div>';
  params.ustalar.forEach(usta=>{
    const {hakedisRows, odmRows, topHakedis, topOdenen} = _buildUstaData(usta, params);
    const kalan = topHakedis - topOdenen;
    html += `<div style="margin-bottom:8px;padding:8px;background:var(--surface);border-radius:6px;border:1px solid var(--border2)">
      <div style="font-weight:700;color:var(--blue)">${usta}</div>
      <div>ğŸ“‹ ${hakedisRows.length} iÅŸ kaydÄ± â€” HakediÅŸ: <b>${fmtN(topHakedis)} â‚º</b></div>
      <div>ğŸ’³ ${odmRows.length} Ã¶deme â€” Ã–denen: <b style="color:var(--green)">${fmtN(topOdenen)} â‚º</b></div>
      <div>â³ Kalan: <b style="color:${kalan>0?'var(--red)':'var(--green)'}">${fmtN(kalan)} â‚º</b></div>
    </div>`;
  });
  const d = document.getElementById('exp-onizleme');
  d.innerHTML = html;
  d.style.display = 'block';
}

function ustaExportExcel(){
  if(typeof XLSX === 'undefined'){
    toast('SheetJS yÃ¼klenemedi, internet baÄŸlantÄ±sÄ±nÄ± kontrol edin.','error');
    return;
  }
  const params = _getExportParams();
  const {ustalar, sheetTip} = params;
  const wb = XLSX.utils.book_new();
  const fn = n => Math.round((n||0)*100)/100;

  function buildAyriSheet(usta){
    const {hakedisRows, odmRows, topHakedis, topOdenen} = _buildUstaData(usta, params);
    const kalan = topHakedis - topOdenen;
    const pct = topHakedis>0 ? Math.round(topOdenen/topHakedis*100) : 0;
    const rows = [];
    rows.push([`USTA: ${usta} â€” HAKEDÄ°Å RAPORU`,'','','','','','','']);
    rows.push([`OluÅŸturma: ${new Date().toLocaleDateString('tr-TR',{day:'2-digit',month:'2-digit',year:'numeric'})}`,'','','','','','','']);
    rows.push([]);
    rows.push(['ğŸ“‹ Ä°Å KAYITLARI','','','','','','','']);
    rows.push(['Tarih','Ä°ÅŸ No','MÃ¼ÅŸteri','Adres','YapÄ±lan Ä°ÅŸler','HakediÅŸ (â‚º)','Ä°ÅŸ Durumu','']);
    if(hakedisRows.length===0){
      rows.push(['Filtre kriterlerine uygun iÅŸ kaydÄ± bulunamadÄ±.']);
    } else {
      hakedisRows.forEach(r=>rows.push([r.tarih,r.isNo,r.musteri,r.adres,r.isler,fn(r.hakedis),r.durum,'']));
    }
    rows.push(['','','','','','TOPLAM HAKEDÄ°Å:',fn(topHakedis),'']);
    rows.push([]);
    rows.push(['ğŸ’³ Ã–DEME GEÃ‡MÄ°ÅÄ°','','','']);
    rows.push(['Tarih','AÃ§Ä±klama','TÃ¼r','Ã–deme (â‚º)']);
    if(odmRows.length===0){
      rows.push(['Filtre kriterlerine uygun Ã¶deme bulunamadÄ±.']);
    } else {
      odmRows.forEach(r=>rows.push([r.tarih,r.aciklama,r.tur,fn(r.tutar)]));
    }
    rows.push(['','','TOPLAM Ã–DENEN:',fn(topOdenen)]);
    rows.push([]);
    rows.push(['ğŸ“Š Ã–ZET','','','']);
    rows.push(['Toplam HakediÅŸ (â‚º)','Toplam Ã–denen (â‚º)','Kalan Bakiye (â‚º)','Ã–deme OranÄ± (%)']);
    rows.push([fn(topHakedis), fn(topOdenen), fn(kalan), pct+'%']);
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [{wch:14},{wch:10},{wch:22},{wch:28},{wch:30},{wch:16},{wch:14},{wch:8}];
    return ws;
  }

  function buildTekSheet(){
    const rows = [];
    rows.push(['USTA HAKEDÄ°Å RAPORU â€” TÃœM USTALAR','','','','','']);
    rows.push([`OluÅŸturma: ${new Date().toLocaleDateString('tr-TR',{day:'2-digit',month:'2-digit',year:'numeric'})}`]);
    rows.push([]);
    rows.push(['ğŸ‘· Ã–ZET TABLO','','','','','']);
    rows.push(['Usta','Toplam HakediÅŸ (â‚º)','Toplam Ã–denen (â‚º)','Kalan Bakiye (â‚º)','Ã–deme OranÄ± (%)','']);
    let genelHak=0, genelOde=0;
    ustalar.forEach(usta=>{
      const {topHakedis,topOdenen} = _buildUstaData(usta, params);
      const kalan = topHakedis - topOdenen;
      const pct = topHakedis>0?Math.round(topOdenen/topHakedis*100):0;
      rows.push([usta, fn(topHakedis), fn(topOdenen), fn(kalan), pct+'%','']);
      genelHak+=topHakedis; genelOde+=topOdenen;
    });
    rows.push(['GENEL TOPLAM', fn(genelHak), fn(genelOde), fn(genelHak-genelOde), '','']);
    rows.push([]);
    ustalar.forEach(usta=>{
      const {hakedisRows, odmRows, topHakedis, topOdenen} = _buildUstaData(usta, params);
      rows.push([`â”€â”€ ${usta.toUpperCase()} â”€â”€`,'','','','','']);
      rows.push(['ğŸ“‹ Ä°ÅŸ KayÄ±tlarÄ±','','','','','']);
      rows.push(['Tarih','Ä°ÅŸ No','MÃ¼ÅŸteri','YapÄ±lan Ä°ÅŸler','HakediÅŸ (â‚º)','Ä°ÅŸ Durumu']);
      if(hakedisRows.length===0){ rows.push(['KayÄ±t yok']); }
      else { hakedisRows.forEach(r=>rows.push([r.tarih,r.isNo,r.musteri,r.isler,fn(r.hakedis),r.durum])); }
      rows.push(['','','','Toplam HakediÅŸ:',fn(topHakedis),'']);
      rows.push(['ğŸ’³ Ã–deme GeÃ§miÅŸi','','','']);
      rows.push(['Tarih','AÃ§Ä±klama','TÃ¼r','Ã–deme (â‚º)']);
      if(odmRows.length===0){ rows.push(['Ã–deme yok']); }
      else { odmRows.forEach(r=>rows.push([r.tarih,r.aciklama,r.tur,fn(r.tutar)])); }
      rows.push(['','','Toplam Ã–denen:',fn(topOdenen)]);
      rows.push([]);
    });
    const ws = XLSX.utils.aoa_to_sheet(rows);
    ws['!cols'] = [{wch:22},{wch:10},{wch:22},{wch:30},{wch:16},{wch:14}];
    return ws;
  }

  if(sheetTip === 'ayri' || sheetTip === 'her-ikisi'){
    ustalar.forEach(usta=>{
      const ws = buildAyriSheet(usta);
      const nm = usta.replace(/[\\\/\[\]\*\?:]/g,'').substring(0,31);
      XLSX.utils.book_append_sheet(wb, ws, nm);
    });
  }
  if(sheetTip === 'tek' || sheetTip === 'her-ikisi'){
    const ws = buildTekSheet();
    XLSX.utils.book_append_sheet(wb, ws, 'Tum Ustalar');
  }

  const tarih = today().replace(/-/g,'');
  const uAdSuffix = ustalar.length===1 ? '_'+ustalar[0].replace(/\s+/g,'') : '_TumUstalar';
  XLSX.writeFile(wb, `UstaHakedis${uAdSuffix}_${tarih}.xlsx`);
  closeModal('modal-usta-export');
  toast('âœ… Excel dosyasÄ± indirildi!', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HESAP DEFTERÄ° EXCEL EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openHdExportModal(){
  // Tarih varsayÄ±lanlarÄ±: bu ay
  const bugun = today();
  const ayBasi = bugun.substring(0,7)+'-01';
  document.getElementById('hd-exp-bas').value = ayBasi;
  document.getElementById('hd-exp-bit').value = bugun;
  document.getElementById('hd-exp-tarih-ac').checked = true;
  document.getElementById('hd-exp-tip').value = '';
  document.getElementById('hd-exp-otomatik').checked = true;
  document.getElementById('hd-exp-ozet').checked = true;
  document.getElementById('hd-exp-onizleme').style.display = 'none';
  hdExpToggleTarih();

  // Kategorileri doldur
  const katSel = document.getElementById('hd-exp-kategori');
  const katlar = [...new Set((DB.hesapDefteri||[]).map(h=>h.kategori).filter(Boolean))].sort();
  katSel.innerHTML = '<option value="">TÃ¼m Kategoriler</option>';
  katlar.forEach(k=>{ const o=document.createElement('option'); o.value=o.textContent=k; katSel.appendChild(o); });

  openModal('modal-hd-export');
}

function hdExpToggleTarih(){
  const ac = document.getElementById('hd-exp-tarih-ac').checked;
  document.getElementById('hd-exp-bas').disabled = !ac;
  document.getElementById('hd-exp-bit').disabled = !ac;
}

function _getHdExportData(){
  const tarihAc  = document.getElementById('hd-exp-tarih-ac').checked;
  const bas      = tarihAc ? document.getElementById('hd-exp-bas').value : '';
  const bit      = tarihAc ? document.getElementById('hd-exp-bit').value : '';
  const tip      = document.getElementById('hd-exp-tip').value;
  const kategori = document.getElementById('hd-exp-kategori').value;
  const otoDahil = document.getElementById('hd-exp-otomatik').checked;

  let list = [...(DB.hesapDefteri||[])].sort((a,b)=>(a.tarih||'').localeCompare(b.tarih||''));
  if(bas) list = list.filter(h=>(h.tarih||'') >= bas);
  if(bit) list = list.filter(h=>(h.tarih||'') <= bit);
  if(tip) list = list.filter(h=>h.tip === tip);
  if(kategori) list = list.filter(h=>h.kategori === kategori);
  if(!otoDahil) list = list.filter(h=>!h.otomatik);

  const topGelir = list.filter(h=>h.tip==='gelir').reduce((s,h)=>s+(h.tutar||0),0);
  const topGider = list.filter(h=>h.tip==='gider').reduce((s,h)=>s+(h.tutar||0),0);

  return {list, topGelir, topGider, bas, bit};
}

function hdExportOnizle(){
  const {list, topGelir, topGider, bas, bit} = _getHdExportData();
    const net = topGelir - topGider;
  const d = document.getElementById('hd-exp-onizleme');
  d.innerHTML = `
    <div style="font-weight:700;margin-bottom:8px">ğŸ“Š Ã–nizleme:</div>
    <div style="padding:8px;background:var(--surface);border-radius:6px;border:1px solid var(--border2)">
      <div>ğŸ“‹ <b>${list.length}</b> kayÄ±t export edilecek${bas?' ('+fmtDate(bas)+' â€” '+fmtDate(bit)+')':''}</div>
      <div style="margin-top:6px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">
        <div style="text-align:center;padding:6px;background:var(--surface2);border-radius:4px">
          <div style="font-size:10px;color:var(--text3)">Gelir</div>
          <div style="font-weight:700;color:var(--green)">${fmtN(topGelir)} â‚º</div>
        </div>
        <div style="text-align:center;padding:6px;background:var(--surface2);border-radius:4px">
          <div style="font-size:10px;color:var(--text3)">Gider</div>
          <div style="font-weight:700;color:var(--red)">${fmtN(topGider)} â‚º</div>
        </div>
        <div style="text-align:center;padding:6px;background:var(--surface2);border-radius:4px">
          <div style="font-size:10px;color:var(--text3)">Net Bakiye</div>
          <div style="font-weight:700;color:${net>=0?'var(--blue)':'var(--red)'}">${fmtN(Math.abs(net))} â‚º</div>
        </div>
      </div>
    </div>`;
  d.style.display = 'block';
}

function hdExportExcel(){
  if(typeof XLSX === 'undefined'){
    toast('SheetJS yÃ¼klenemedi, internet baÄŸlantÄ±sÄ±nÄ± kontrol edin.','error');
    return;
  }
  const {list, topGelir, topGider, bas, bit} = _getHdExportData();
  const ozetAc = document.getElementById('hd-exp-ozet').checked;
  const fn = n => Math.round((n||0)*100)/100;
  const wb = XLSX.utils.book_new();

  // â”€â”€ ANA SHEET: TÃ¼m KayÄ±tlar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rows = [];
  const donem = bas ? (fmtDate(bas) + ' â€” ' + fmtDate(bit)) : 'TÃ¼m Zamanlar';
  rows.push([`HESAP DEFTERÄ° RAPORU`, '', '', '', '']);
  rows.push([`DÃ¶nem: ${donem}`, '', '', '', '']);
  rows.push([`OluÅŸturma: ${new Date().toLocaleDateString('tr-TR',{day:'2-digit',month:'2-digit',year:'numeric'})}`, '', '', '', '']);
  rows.push([]);

  // Tablo baÅŸlÄ±ÄŸÄ±
  rows.push(['Tarih', 'TÃ¼r', 'Kategori', 'AÃ§Ä±klama', 'Tutar (â‚º)', 'Kaynak']);

  if(list.length === 0){
    rows.push(['Filtre kriterlerine uygun kayÄ±t bulunamadÄ±.']);
  } else {
    list.forEach(h=>{
      rows.push([
        fmtDate(h.tarih),
        h.tip === 'gelir' ? 'Gelir' : 'Gider',
        h.kategori || 'â€”',
        h.aciklama || 'â€”',
        h.tip === 'gelir' ? fn(h.tutar) : -fn(h.tutar),
        h.otomatik ? 'Otomatik' : 'Manuel'
      ]);
    });
  }

  // Ã–zet satÄ±rlarÄ±
  if(ozetAc){
    rows.push([]);
    rows.push(['', '', '', 'TOPLAM GELÄ°R:', fn(topGelir), '']);
    rows.push(['', '', '', 'TOPLAM GÄ°DER:', fn(topGider), '']);
    rows.push(['', '', '', 'NET BAKÄ°YE:', fn(topGelir - topGider), '']);
  }

  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:14},{wch:10},{wch:20},{wch:40},{wch:16},{wch:12}];

  // Tutar sÃ¼tununu sayÄ±sal biÃ§imlendir
  const range = XLSX.utils.decode_range(ws['!ref']||'A1');
  for(let r=5; r<=range.e.r; r++){
    const cell = ws[XLSX.utils.encode_cell({r,c:4})];
    if(cell && typeof cell.v === 'number') cell.t = 'n';
  }

  XLSX.utils.book_append_sheet(wb, ws, 'Hesap Defteri');

  // â”€â”€ KATEGORÄ° Ã–ZET SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const katMap = {};
  list.forEach(h=>{
    const k = (h.kategori||'DiÄŸer') + '|' + (h.tip||'');
    if(!katMap[k]) katMap[k] = {kategori: h.kategori||'DiÄŸer', tip: h.tip, toplam: 0, adet: 0};
    katMap[k].toplam += (h.tutar||0);
    katMap[k].adet++;
  });
  const katRows = [['Kategori', 'TÃ¼r', 'Ä°ÅŸlem Adedi', 'Toplam (â‚º)']];
  Object.values(katMap)
    .sort((a,b)=>b.toplam-a.toplam)
    .forEach(k=>katRows.push([k.kategori, k.tip==='gelir'?'Gelir':'Gider', k.adet, fn(k.toplam)]));
  const ws2 = XLSX.utils.aoa_to_sheet(katRows);
  ws2['!cols'] = [{wch:24},{wch:10},{wch:14},{wch:16}];
  XLSX.utils.book_append_sheet(wb, ws2, 'Kategori Ã–zeti');

  // Dosya adÄ±
  const tarihSuffix = bas ? ('_'+bas.replace(/-/g,'')+'_'+bit.replace(/-/g,'')) : ('_'+today().replace(/-/g,''));
  XLSX.writeFile(wb, `HesapDefteri${tarihSuffix}.xlsx`);
  closeModal('modal-hd-export');
  toast('âœ… Excel dosyasÄ± indirildi!', 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ä°Å EMÄ°RLERÄ° EXCEL EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openTadExportModal(){
  const bugun = today(), ayBasi = bugun.substring(0,7)+'-01';
  document.getElementById('tad-exp-bas').value = ayBasi;
  document.getElementById('tad-exp-bit').value = bugun;
  document.getElementById('tad-exp-tarih-ac').checked = true;
  document.getElementById('tad-exp-durum').value = '';
  document.getElementById('tad-exp-arsiv').checked = false;
  document.getElementById('tad-exp-ozet').checked = true;
  document.getElementById('tad-exp-onizleme').style.display = 'none';
  tadExpToggle();
  const uSel = document.getElementById('tad-exp-usta');
  uSel.innerHTML = '<option value="">TÃ¼m Ustalar</option>';
  (DB.tanimlar.ustalar||[]).forEach(u=>{ const o=document.createElement('option'); o.value=o.textContent=u; uSel.appendChild(o); });
  openModal('modal-tad-export');
}

function tadExpToggle(){
  const ac = document.getElementById('tad-exp-tarih-ac').checked;
  ['tad-exp-bas','tad-exp-bit'].forEach(id=>document.getElementById(id).disabled=!ac);
}

function _getTadExportData(){
  const tarihAc = document.getElementById('tad-exp-tarih-ac').checked;
  const bas  = tarihAc ? document.getElementById('tad-exp-bas').value : '';
  const bit  = tarihAc ? document.getElementById('tad-exp-bit').value : '';
  const dur  = document.getElementById('tad-exp-durum').value;
  const usta = document.getElementById('tad-exp-usta').value;
  const arsivDahil = document.getElementById('tad-exp-arsiv').checked;

  let list = [...DB.tadilatlar];
  if(!arsivDahil) list = list.filter(t=>!t.arsiv);
  if(bas) list = list.filter(t=>(t.baslama||t.tarih||'') >= bas);
  if(bit) list = list.filter(t=>(t.baslama||t.tarih||'') <= bit);
  if(dur) list = list.filter(t=>t.durum===dur);
  if(usta) list = list.filter(t=>(t.ustalar||[{usta:t.usta}]).some(u=>u.usta===usta));
  list.sort((a,b)=>(a.baslama||a.tarih||'').localeCompare(b.baslama||b.tarih||''));
  return {list, bas, bit};
}

function tadExportOnizle(){
  const {list, bas, bit} = _getTadExportData();
  const tamam = list.filter(t=>t.durum==='TamamlandÄ±').length;
  const devam = list.filter(t=>t.durum==='Devam Ediyor').length;
  const bekle = list.filter(t=>t.durum==='Beklemede').length;
  const d = document.getElementById('tad-exp-onizleme');
  d.innerHTML = `<div style="font-weight:700;margin-bottom:6px">ğŸ“Š Ã–nizleme:</div>
    <div style="padding:8px;background:var(--surface);border-radius:6px;border:1px solid var(--border2)">
      <div>ğŸ“‹ <b>${list.length}</b> iÅŸ emri${bas?' ('+fmtDate(bas)+' â€” '+fmtDate(bit)+')':''}</div>
      <div style="margin-top:4px;display:flex;gap:8px;flex-wrap:wrap">
        <span class="badge badge-green">âœ… ${tamam} TamamlandÄ±</span>
        <span class="badge badge-blue">ğŸ”„ ${devam} Devam</span>
        <span class="badge badge-yellow">â³ ${bekle} Beklemede</span>
      </div>
    </div>`;
  d.style.display = 'block';
}

function tadExportExcel(){
  if(typeof XLSX==='undefined'){ toast('SheetJS yÃ¼klenemedi','error'); return; }
  const {list, bas, bit} = _getTadExportData();
  const ozetAc = document.getElementById('tad-exp-ozet').checked;
  const fn = n => Math.round((n||0)*100)/100;
  const wb = XLSX.utils.book_new();

  // â”€â”€ ANA SHEET â”€â”€
  const donem = bas ? fmtDate(bas)+' â€” '+fmtDate(bit) : 'TÃ¼m Zamanlar';
  const rows = [];
  rows.push([`Ä°Å EMÄ°RLERÄ° RAPORU`,'','','','','','','','']);
  rows.push([`DÃ¶nem: ${donem}`,'','','','','','','','']);
  rows.push([`OluÅŸturma: ${new Date().toLocaleDateString('tr-TR',{day:'2-digit',month:'2-digit',year:'numeric'})}`]);
  rows.push([]);
  rows.push(['Ä°ÅŸ No','Tarih','MÃ¼ÅŸteri','Tel','Adres','Usta / Ä°ÅŸler','HakediÅŸ (â‚º)','Ã–deme Durumu','Ä°ÅŸ Durumu','ArÅŸiv']);

  list.forEach(t=>{
    const ustalar = (t.ustalar||[{usta:t.usta||'â€”',isTipi:t.isTipi||'',fiyat:0}]);
    const ustaTxt = ustalar.map(u=>[u.usta, u.isTipi].filter(Boolean).join(' / ')).join(' | ');
    const topHak  = ustalar.reduce((s,u)=>s+(u.fiyat||getFiyat(u.usta,u.isTipi)||0),0);
    const odm = DB.odemeler.find(o=>o.isNo===t.id);
    const odmDur = odm ? (odm.kalan>0 ? `Kalan: ${fn(odm.kalan)} â‚º` : 'âœ“ Ã–dendi') : 'Ã–deme KaydÄ± Yok';
    rows.push([
      '#'+t.id,
      fmtDate(t.baslama||t.tarih),
      t.musteri||'â€”',
      t.tel||'',
      t.adres||'',
      ustaTxt,
      fn(topHak),
      odmDur,
      t.durum||'',
      t.arsiv?'ArÅŸiv':'Aktif'
    ]);
  });

  if(ozetAc){
    rows.push([]);
    const tamam=list.filter(t=>t.durum==='TamamlandÄ±').length;
    const devam=list.filter(t=>t.durum==='Devam Ediyor').length;
    const bekle=list.filter(t=>t.durum==='Beklemede').length;
    const iptal=list.filter(t=>t.durum==='Ä°ptal').length;
    const topHak=list.reduce((s,t)=>{
      const ustalar=(t.ustalar||[{usta:t.usta||'',isTipi:t.isTipi||'',fiyat:0}]);
      return s+ustalar.reduce((ss,u)=>ss+(u.fiyat||getFiyat(u.usta,u.isTipi)||0),0);
    },0);
    rows.push(['Ã–ZET','','','','','','','','','']);
    rows.push(['Toplam Ä°ÅŸ Emri','TamamlandÄ±','Devam Ediyor','Beklemede','Ä°ptal','Toplam HakediÅŸ (â‚º)']);
    rows.push([list.length, tamam, devam, bekle, iptal, fn(topHak)]);
  }

  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:8},{wch:12},{wch:22},{wch:14},{wch:30},{wch:35},{wch:14},{wch:20},{wch:14},{wch:8}];
  XLSX.utils.book_append_sheet(wb, ws, 'Ä°ÅŸ Emirleri');

  const tarihSuffix = bas ? '_'+bas.replace(/-/g,'')+'_'+bit.replace(/-/g,'') : '_'+today().replace(/-/g,'');
  XLSX.writeFile(wb, `IsEmirleri${tarihSuffix}.xlsx`);
  closeModal('modal-tad-export');
  toast('âœ… Excel dosyasÄ± indirildi!','success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃœÅTERÄ° Ã–DEMELERÄ° EXCEL EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function openOdmExportModal(){
  const bugun = today(), ayBasi = bugun.substring(0,7)+'-01';
  document.getElementById('odm-exp-bas').value = ayBasi;
  document.getElementById('odm-exp-bit').value = bugun;
  document.getElementById('odm-exp-tarih-ac').checked = true;
  document.getElementById('odm-exp-durum').value = '';
  document.getElementById('odm-exp-arsiv').checked = false;
  document.getElementById('odm-exp-ozet').checked = true;
  document.getElementById('odm-exp-onizleme').style.display = 'none';
  odmExpToggle();
  openModal('modal-odm-export');
}

function odmExpToggle(){
  const ac = document.getElementById('odm-exp-tarih-ac').checked;
  ['odm-exp-bas','odm-exp-bit'].forEach(id=>document.getElementById(id).disabled=!ac);
}

function _getOdmExportData(){
  const tarihAc = document.getElementById('odm-exp-tarih-ac').checked;
  const bas  = tarihAc ? document.getElementById('odm-exp-bas').value : '';
  const bit  = tarihAc ? document.getElementById('odm-exp-bit').value : '';
  const dur  = document.getElementById('odm-exp-durum').value;
  const arsivDahil = document.getElementById('odm-exp-arsiv').checked;

  let list = [...DB.odemeler];
  if(!arsivDahil) list = list.filter(o=>!o.arsiv);
  // Tarih filtresi: Ã¶demenin baÄŸlÄ± olduÄŸu iÅŸ emrinin tarihine gÃ¶re
  if(bas || bit){
    list = list.filter(o=>{
      const tad = DB.tadilatlar.find(t=>t.id===o.isNo);
      const d = tad ? (tad.baslama||tad.tarih||'') : '';
      return (!bas||d>=bas) && (!bit||d<=bit);
    });
  }
  if(dur) list = list.filter(o=>o.durum===dur);
  list.sort((a,b)=>{
    const ta=DB.tadilatlar.find(t=>t.id===a.isNo), tb=DB.tadilatlar.find(t=>t.id===b.isNo);
    const da=ta?(ta.baslama||ta.tarih||''):'', db=tb?(tb.baslama||tb.tarih||''):'';
    return da.localeCompare(db);
  });
  return {list, bas, bit};
}

function odmExportOnizle(){
  const {list, bas, bit} = _getOdmExportData();
    const topFatura = list.reduce((s,o)=>s+(o.tutar||0),0);
  const topTahsil = list.reduce((s,o)=>s+(o.toplamOdenen||0),0);
  const topKalan  = list.reduce((s,o)=>s+(o.kalan||0),0);
  const d = document.getElementById('odm-exp-onizleme');
  d.innerHTML = `<div style="font-weight:700;margin-bottom:6px">ğŸ“Š Ã–nizleme:</div>
    <div style="padding:8px;background:var(--surface);border-radius:6px;border:1px solid var(--border2)">
      <div>ğŸ’³ <b>${list.length}</b> Ã¶deme kaydÄ±${bas?' ('+fmtDate(bas)+' â€” '+fmtDate(bit)+')':''}</div>
      <div style="margin-top:6px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">
        <div style="text-align:center;padding:6px;background:var(--surface2);border-radius:4px">
          <div style="font-size:10px;color:var(--text3)">Toplam Fatura</div>
          <div style="font-weight:700;color:var(--blue)">${fmtN(topFatura)} â‚º</div>
        </div>
        <div style="text-align:center;padding:6px;background:var(--surface2);border-radius:4px">
          <div style="font-size:10px;color:var(--text3)">Tahsil Edilen</div>
          <div style="font-weight:700;color:var(--green)">${fmtN(topTahsil)} â‚º</div>
        </div>
        <div style="text-align:center;padding:6px;background:var(--surface2);border-radius:4px">
          <div style="font-size:10px;color:var(--text3)">Kalan BorÃ§</div>
          <div style="font-weight:700;color:var(--red)">${fmtN(topKalan)} â‚º</div>
        </div>
      </div>
    </div>`;
  d.style.display = 'block';
}

function odmExportExcel(){
  if(typeof XLSX==='undefined'){ toast('SheetJS yÃ¼klenemedi','error'); return; }
  const {list, bas, bit} = _getOdmExportData();
  const ozetAc = document.getElementById('odm-exp-ozet').checked;
  const fn = n => Math.round((n||0)*100)/100;
  const wb = XLSX.utils.book_new();

  // â”€â”€ ANA SHEET â”€â”€
  const donem = bas ? fmtDate(bas)+' â€” '+fmtDate(bit) : 'TÃ¼m Zamanlar';
  const rows = [];
  rows.push([`MÃœÅTERÄ° Ã–DEMELERÄ° RAPORU`,'','','','','','','','','','','']);
  rows.push([`DÃ¶nem: ${donem}`]);
  rows.push([`OluÅŸturma: ${new Date().toLocaleDateString('tr-TR',{day:'2-digit',month:'2-digit',year:'numeric'})}`]);
  rows.push([]);
  rows.push(['Ä°ÅŸ No','MÃ¼ÅŸteri','Fatura (â‚º)','Nakit (â‚º)','Kart (â‚º)','Taksit','Havale (â‚º)','Ã‡ek (â‚º)','Vadeli','Toplam Ã–denen (â‚º)','Kalan (â‚º)','Durum','ArÅŸiv']);

  list.forEach(o=>{
    const taksitTxt = o.taksit>0 ? `${o.taksitOdenen||0}/${o.taksit} taksit` : 'â€”';
    const vadelerTxt = (o.vadeler&&o.vadeler.length>0)
      ? o.vadeler.map(v=>fn(v.tutar)+'â‚º '+fmtDate(v.tarih)).join(' / ')
      : (o.vade ? fmtDate(o.vade) : 'â€”');
    rows.push([
      '#'+o.isNo,
      o.musteri||getMusteri(o.isNo)||'â€”',
      fn(o.tutar),
      fn(o.nakit),
      fn(o.kart),
      taksitTxt,
      fn(o.havale),
      fn(o.cek),
      vadelerTxt,
      fn(o.toplamOdenen),
      fn(o.kalan),
      o.durum||'',
      o.arsiv?'ArÅŸiv':'Aktif'
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(rows);
  ws['!cols'] = [{wch:8},{wch:22},{wch:14},{wch:12},{wch:12},{wch:16},{wch:12},{wch:12},{wch:24},{wch:16},{wch:12},{wch:14},{wch:8}];
  // SayÄ±sal sÃ¼tunlarÄ± iÅŸaretle
  const sayisalKollar = [2,3,4,6,7,9,10];
  const range = XLSX.utils.decode_range(ws['!ref']||'A1');
  for(let r=5; r<=range.e.r; r++){
    sayisalKollar.forEach(c=>{ const cell=ws[XLSX.utils.encode_cell({r,c})]; if(cell&&typeof cell.v==='number') cell.t='n'; });
  }
  XLSX.utils.book_append_sheet(wb, ws, 'MÃ¼ÅŸteri Ã–demeleri');

  // â”€â”€ TAHSÄ°LAT Ã–ZET SHEET â”€â”€
  if(ozetAc){
    const topFatura  = list.reduce((s,o)=>s+fn(o.tutar),0);
    const topNakit   = list.reduce((s,o)=>s+fn(o.nakit),0);
    const topKart    = list.reduce((s,o)=>s+fn(o.kart),0);
    const topHavale  = list.reduce((s,o)=>s+fn(o.havale),0);
    const topCek     = list.reduce((s,o)=>s+fn(o.cek),0);
    const topOdenen  = list.reduce((s,o)=>s+fn(o.toplamOdenen),0);
    const topKalan   = list.reduce((s,o)=>s+fn(o.kalan),0);
    const pct = topFatura>0 ? Math.round(topOdenen/topFatura*100) : 0;

    const ozRows = [];
    ozRows.push(['TAHSÄ°LAT Ã–ZET RAPORU','']);
    ozRows.push([`DÃ¶nem: ${donem}`,`${list.length} kayÄ±t`]);
    ozRows.push([]);
    ozRows.push(['Kalem','Tutar (â‚º)','Oran (%)']);
    ozRows.push(['Toplam Fatura', fn(topFatura), '100%']);
    ozRows.push(['Toplam Tahsilat', fn(topOdenen), pct+'%']);
    ozRows.push(['Kalan BorÃ§', fn(topKalan), (100-pct)+'%']);
    ozRows.push([]);
    ozRows.push(['TAHSÄ°LAT KANALI DAÄILIMI','','']);
    ozRows.push(['Kanal','Tutar (â‚º)','Oran (%)']);
    const kanallar = [['ğŸ’µ Nakit',topNakit],['ğŸ’³ Kart',topKart],['ğŸ¦ Havale',topHavale],['ğŸ“„ Ã‡ek',topCek]];
    kanallar.forEach(([k,v])=>{
      const oran = topOdenen>0 ? Math.round(v/topOdenen*100) : 0;
      ozRows.push([k, fn(v), oran+'%']);
    });
    ozRows.push([]);
    ozRows.push(['DURUM DAÄILIMI','','']);
    ozRows.push(['Durum','KayÄ±t Adedi','Kalan Toplam (â‚º)']);
    ['Ã–dendi','KÄ±smi Ã–deme','Ã–denmedi'].forEach(d=>{
      const gr = list.filter(o=>o.durum===d);
      ozRows.push([d, gr.length, fn(gr.reduce((s,o)=>s+fn(o.kalan),0))]);
    });
    const ws2 = XLSX.utils.aoa_to_sheet(ozRows);
    ws2['!cols'] = [{wch:28},{wch:16},{wch:12}];
    XLSX.utils.book_append_sheet(wb, ws2, 'Tahsilat Ã–zeti');
  }

  const tarihSuffix = bas ? '_'+bas.replace(/-/g,'')+'_'+bit.replace(/-/g,'') : '_'+today().replace(/-/g,'');
  XLSX.writeFile(wb, `MusteriOdemeleri${tarihSuffix}.xlsx`);
  closeModal('modal-odm-export');
  toast('âœ… Excel dosyasÄ± indirildi!','success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARÄ° HESAPLAR â€” TAM MODÃœL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let secilenCariFirmaId = null;

// â”€â”€ KPI & FIRMA LÄ°STESÄ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCari(){
  const firmalar = DB.cariFirmalar || [];
  const hareketler = DB.cariHareketler || [];
  const search = (document.getElementById('cari-search')?.value||'').toLowerCase();
  const arsivGoster = document.getElementById('cari-arsiv-toggle')?.checked || false;

  // KPI hesapla (sadece aktif firmalar)
  const aktifFirmalar = firmalar.filter(f=>!f.arsivlendi);
  let topBorc=0, topAlacak=0;
  aktifFirmalar.forEach(f=>{
    const fh = hareketler.filter(h=>h.firmaId===f.id);
    topBorc   += fh.filter(h=>h.tip==='borc').reduce((s,h)=>s+(h.tutar||0),0);
    topAlacak += fh.filter(h=>h.tip==='alacak').reduce((s,h)=>s+(h.tutar||0),0);
  });
  const netPozisyon = topAlacak - topBorc;
  const arsivSayisi = firmalar.filter(f=>f.arsivlendi).length;

  document.getElementById('cari-kpi').innerHTML=`
    <div class="kpi-card blue"><div class="kpi-icon">ğŸ¢</div>
      <div class="kpi-label">Aktif Firma</div>
      <div class="kpi-value">${aktifFirmalar.length}</div>
      ${arsivSayisi>0?`<div class="kpi-sub">${arsivSayisi} arÅŸivde</div>`:''}</div>
    <div class="kpi-card red"><div class="kpi-icon">ğŸ“¤</div>
      <div class="kpi-label">Toplam BorÃ§</div>
      <div class="kpi-value" style="font-size:18px">${fmt(topBorc)}</div>
      <div class="kpi-sub">Firmalara Ã¶dedik</div></div>
    <div class="kpi-card green"><div class="kpi-icon">ğŸ“¥</div>
      <div class="kpi-label">Toplam Alacak</div>
      <div class="kpi-value" style="font-size:18px">${fmt(topAlacak)}</div>
      <div class="kpi-sub">Firmalardan tahsil</div></div>
    <div class="kpi-card ${netPozisyon>=0?'green':'orange'}"><div class="kpi-icon">âš–ï¸</div>
      <div class="kpi-label">Net Pozisyon</div>
      <div class="kpi-value" style="font-size:18px;color:var(--${netPozisyon>=0?'green':'red'})">${fmt(Math.abs(netPozisyon))}</div>
      <div class="kpi-sub">${netPozisyon>=0?'Lehimize':'Aleyhimize'}</div></div>`;

  document.getElementById('cari-sub').textContent = `${aktifFirmalar.length} aktif firma â€” ${hareketler.length} hareket`;

  // Firma listesi â€” arÅŸiv filtresi
  let gorunenFirmalar = arsivGoster ? firmalar : aktifFirmalar;

  // Arama filtresi
  const filtreliFirmalar = search
    ? gorunenFirmalar.filter(f=>(f.ad+f.sektor+f.yetkili).toLowerCase().includes(search))
    : gorunenFirmalar;

  document.getElementById('cari-firma-count').textContent = filtreliFirmalar.length + ' firma';

  const listEl = document.getElementById('cari-firma-list');
  if(filtreliFirmalar.length===0){
    listEl.innerHTML = `<div style="text-align:center;padding:24px;color:var(--text3);font-size:13px">${firmalar.length===0?'HenÃ¼z firma eklenmedi<br><br><button class="btn btn-primary btn-sm" onclick="openCariFirmaModal()">+ Firma Ekle</button>':'Arama sonucu bulunamadÄ±'}</div>`;
    return;
  }

  listEl.innerHTML = filtreliFirmalar.map(f=>{
    const fh = hareketler.filter(h=>h.firmaId===f.id);
    let borc=0,alacak=0;
    fh.forEach(h=>{ if(h.tip==='borc') borc+=(h.tutar||0); else alacak+=(h.tutar||0); });
    const net    = alacak - borc;
    const secili = String(secilenCariFirmaId) === String(f.id); // #17 fix
    const renk   = net > 0 ? 'var(--green)' : net < 0 ? 'var(--red)' : 'var(--text3)';
    const netTxt = net > 0 ? `+${fmt(net)}` : net < 0 ? `-${fmt(Math.abs(net))}` : '0 â‚º';
    const arsivli = f.arsivlendi ? true : false;
    return `<div onclick="selectCariFirma('${f.id}')" data-firma-id="${f.id}"
        class="cari-firma-item${arsivli?' firma-arsivlendi':''}"
        style="padding:10px 12px;border-radius:var(--r8);cursor:pointer;margin-bottom:4px;position:relative;
        border:1px solid ${secili?'var(--blue)':'var(--border)'};
        background:${secili?'var(--surface2)':'transparent'}">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:3px">
        <div style="font-weight:700;font-size:13px;color:var(--text);display:flex;align-items:center;gap:6px">
          ${esc(f.ad)}
          ${arsivli?'<span class="badge-arsiv">ğŸ“¦ ArÅŸiv</span>':''}
        </div>
        <div style="display:flex;align-items:center;gap:6px">
          <div style="font-size:12px;font-weight:700;font-family:var(--mono);color:${renk}">${netTxt}</div>
          <div class="cari-item-menu" onclick="event.stopPropagation()">
            <button class="cari-item-menu-btn" onclick="toggleCariItemMenu(event,'menu-${f.id}')">â‹¯</button>
            <div class="cari-item-dropdown" id="menu-${f.id}">
              <button onclick="openCariFirmaModal('${f.id}');closeCariItemMenu()">âœ DÃ¼zenle</button>
              <button onclick="openCariHareketModal('${f.id}');closeCariItemMenu()">+ Hareket Ekle</button>
              <button onclick="openCariExportModal('${f.id}');closeCariItemMenu()">ğŸ“¥ Excel</button>
              <div class="menu-sep"></div>
              <button onclick="archiveCariFirma('${f.id}');closeCariItemMenu()">${arsivli?'ğŸ“¤ ArÅŸivden Ã‡Ä±kar':'ğŸ“¦ ArÅŸivle'}</button>
              <button class="danger" onclick="deleteCariFirma('${f.id}');closeCariItemMenu()">ğŸ—‘ Sil</button>
            </div>
          </div>
        </div>
      </div>
      <div style="display:flex;align-items:center;justify-content:space-between">
        <span style="font-size:10px;background:var(--surface2);padding:2px 6px;border-radius:4px;color:var(--text2)">${esc(f.sektor)||'â€”'}</span>
        <span style="font-size:10px;color:var(--text3)">${fh.length} hareket</span>
      </div>
    </div>`;
  }).join('');

  // SeÃ§ili firmayÄ± gÃ¼ncelle
  if(secilenCariFirmaId){
    const halaVar = filtreliFirmalar.find(f=>f.id===secilenCariFirmaId);
    if(halaVar) renderCariDetay(secilenCariFirmaId);
    else renderCariDetay(null);
  }
}

function selectCariFirma(id){
  secilenCariFirmaId = String(id); // #17: her zaman string
  // #5: DetayÄ± render et
  renderCariDetay(secilenCariFirmaId);
  // Sadece highlight gÃ¼ncelle â€” full renderCari() Ã‡AÄIRMA
  document.querySelectorAll('#cari-firma-list .cari-firma-item').forEach(el=>{
    const isSelected = el.dataset.firmaId === secilenCariFirmaId;
    el.style.borderColor = isSelected ? 'var(--blue)' : 'var(--border)';
    el.style.background  = isSelected ? 'var(--surface2)' : 'transparent';
  });
}

// â”€â”€ DETAY SAYFASI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCariDetay(firmaId){
  const detayEl = document.getElementById('cari-detay');
  if(!firmaId){ detayEl.innerHTML='<div class="card" style="text-align:center;padding:48px;color:var(--text3)"><div style="font-size:48px">ğŸ¢</div><div style="margin-top:12px">Sol listeden firma seÃ§in</div></div>'; return; }

  const firma = (DB.cariFirmalar||[]).find(f=>f.id===firmaId);
  if(!firma){ detayEl.innerHTML=''; return; }

  const hareketler = (DB.cariHareketler||[]).filter(h=>h.firmaId===firmaId).slice().reverse();
  // Virman kayÄ±tlarÄ±nÄ± da hareket listesine ekle (hedef veya kaynak firma)
  const virmanHareketler = (DB.virmanlar||[]).filter(v=>v.hedefFirmaId===firmaId||v.kaynakId===firmaId).map(v=>{
    const isHedef = v.hedefFirmaId===firmaId;
    return {
      _virman: true, id: v.id, tarih: v.tarih,
      tip: isHedef ? 'alacak' : 'borc',
      tutar: v.tutar,
      aciklama: isHedef
        ? `â‡„ Virman: ${esc(v.kaynakAd)||'?'} â†’ bu firma`
        : `â‡„ Virman: bu firma â†’ ${esc(v.hedefFirmaAd)||'?'}`,
      yontem: v.odemeYontemi,
      virmanRef: v
    };
  });
  const tumHareketler = [...hareketler, ...virmanHareketler].sort((a,b)=>(b.tarih||'').localeCompare(a.tarih||''));
  const topBorc   = tumHareketler.filter(h=>h.tip==='borc').reduce((s,h)=>s+(h.tutar||0),0);
  const topAlacak = tumHareketler.filter(h=>h.tip==='alacak').reduce((s,h)=>s+(h.tutar||0),0);
  const net       = topAlacak - topBorc;

  const hareketHTML = tumHareketler.length === 0
    ? `<div style="text-align:center;padding:32px;color:var(--text3)">HenÃ¼z hareket kaydÄ± yok</div>`
    : tumHareketler.map(h=>{
        const isEmri = h.isEmriId ? DB.tadilatlar.find(t=>t.id===parseInt(h.isEmriId)) : null;
        return `<div style="display:flex;gap:12px;align-items:flex-start;padding:12px 16px;border-bottom:1px solid var(--border2);transition:background .1s;${h._virman?'background:rgba(188,140,255,.04)':''}" class="musteri-secim-item">
          <div style="width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;background:${h._virman?'rgba(188,140,255,.15)':h.tip==='borc'?'rgba(255,123,114,.15)':'rgba(63,185,80,.15)'}">
            ${h._virman?'â‡„':h.tip==='borc'?'ğŸ“¤':'ğŸ“¥'}
          </div>
          <div style="flex:1;min-width:0">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:3px">
              <div style="font-weight:600;font-size:13px">${esc(h.aciklama)||'â€”'}</div>
              ${h.belgeNo?`<span style="font-size:10px;background:var(--surface2);padding:1px 6px;border-radius:4px;color:var(--text3)">${esc(h.belgeNo)}</span>`:''}
              ${h.hdYansitildi?'<span style="font-size:10px;color:var(--blue)">ğŸ“’ HD</span>':''}
            </div>
            <div style="display:flex;gap:12px;font-size:11px;color:var(--text3)">
              <span>ğŸ“… ${fmtDate(h.tarih)}</span>
              <span>ğŸ’³ ${esc(h.yontem)||'â€”'}</span>
              ${isEmri?`<span>ğŸ”§ #${isEmri.id} ${esc(isEmri.musteri)||''}</span>`:''}
            </div>
          </div>
          <div style="text-align:right;flex-shrink:0">
            <div style="font-weight:700;font-family:var(--mono);font-size:15px;color:${h.tip==='borc'?'var(--red)':'var(--green)'}">
              ${h.tip==='borc'?'-':'+'}${fmt(h.tutar)}
            </div>
            <div style="display:flex;gap:4px;justify-content:flex-end;margin-top:4px">
              ${h._virman
                ? `<button class="btn-icon btn-sm" onclick="deleteVirman('${h.id}')" title="VirmanÄ± Sil" style="color:var(--red);font-size:13px">ğŸ—‘</button>`
                : `<button class="btn-icon btn-sm" onclick="editCariHareket('${firmaId}','${h.id}')" title="DÃ¼zenle" style="font-size:13px">âœ</button>
                   <button class="btn-icon btn-sm" onclick="deleteCariHareket('${firmaId}','${h.id}')" title="Sil" style="color:var(--red);font-size:13px">ğŸ—‘</button>`
              }
            </div>
          </div>
        </div>`;
      }).join('');

  detayEl.innerHTML = `
    <div>
      <!-- Firma BaÅŸlÄ±k KartÄ± -->
      <div class="card" style="margin-bottom:14px">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:16px">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
              <div style="font-size:22px;font-weight:800">${esc(firma.ad)}</div>
              <span style="font-size:11px;background:var(--surface2);padding:3px 8px;border-radius:6px;color:var(--text2)">${esc(firma.sektor)||'â€”'}</span>
            </div>
            <div style="display:flex;gap:16px;flex-wrap:wrap;font-size:12px;color:var(--text3)">
              ${firma.yetkili?`<span>ğŸ‘¤ ${esc(firma.yetkili)}</span>`:''}
              ${firma.tel?`<span>ğŸ“ ${esc(firma.tel)}</span>`:''}
              ${firma.email?`<span>âœ‰ï¸ ${esc(firma.email)}</span>`:''}
            </div>
            ${firma.not?`<div style="margin-top:6px;font-size:12px;color:var(--text2);font-style:italic">${esc(firma.not)}</div>`:''}
          </div>
          <div style="display:flex;gap:6px;flex-shrink:0">
            <button class="btn btn-secondary btn-sm" onclick="openCariFirmaModal('${firmaId}')" title="DÃ¼zenle">âœ DÃ¼zenle</button>
            <button class="btn btn-secondary btn-sm" onclick="openCariExportModal('${firmaId}')" title="Excel">ğŸ“¥</button>
            <button class="btn btn-secondary btn-sm" onclick="archiveCariFirma('${firmaId}')" title="${firma.arsivlendi?'ArÅŸivden Ã‡Ä±kar':'ArÅŸivle'}" style="${firma.arsivlendi?'color:var(--yellow);border-color:rgba(227,179,65,.4)':''}">
              ${firma.arsivlendi?'ğŸ“¤ Aktife Al':'ğŸ“¦ ArÅŸivle'}
            </button>
            <button class="btn btn-danger btn-sm" onclick="deleteCariFirma('${firmaId}')">ğŸ—‘ Sil</button>
            <button class="btn btn-primary" onclick="openCariHareketModal('${firmaId}')">+ Hareket Ekle</button>
            <button class="btn btn-secondary" onclick="openVirmanModal('firma','${firmaId}')" style="color:var(--purple);border-color:rgba(188,140,255,.4)">â‡„ Virman</button>
          </div>
        </div>

        <!-- Bakiye Ã–zeti -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-top:16px">
          <div style="padding:10px;background:var(--surface2);border-radius:var(--r8);text-align:center">
            <div style="font-size:10px;color:var(--text3);margin-bottom:4px">Toplam BorÃ§</div>
            <div style="font-weight:700;color:var(--red);font-family:var(--mono)">${fmt(topBorc)}</div>
          </div>
          <div style="padding:10px;background:var(--surface2);border-radius:var(--r8);text-align:center">
            <div style="font-size:10px;color:var(--text3);margin-bottom:4px">Toplam Alacak</div>
            <div style="font-weight:700;color:var(--green);font-family:var(--mono)">${fmt(topAlacak)}</div>
          </div>
          <div style="padding:10px;background:var(--surface2);border-radius:var(--r8);text-align:center">
            <div style="font-size:10px;color:var(--text3);margin-bottom:4px">Net Bakiye</div>
            <div style="font-weight:700;color:${net>=0?'var(--green)':'var(--red)'};font-family:var(--mono)">${net>=0?'+':''}${fmt(net)}</div>
          </div>
          <div style="padding:10px;background:var(--surface2);border-radius:var(--r8);text-align:center">
            <div style="font-size:10px;color:var(--text3);margin-bottom:4px">Hareket</div>
            <div style="font-weight:700;color:var(--blue)">${hareketler.length}</div>
          </div>
        </div>
      </div>

      <!-- Hareket GeÃ§miÅŸi -->
      <div class="card" style="padding:0">
        <div style="padding:12px 16px;border-bottom:1px solid var(--border2);display:flex;align-items:center;justify-content:space-between">
          <div style="font-weight:700">Hareket GeÃ§miÅŸi</div>
          <div style="display:flex;gap:8px;align-items:center">
            <span class="badge badge-blue">${tumHareketler.length} kayÄ±t</span>
          </div>
        </div>
        ${hareketHTML}
      </div>
    </div>`;
}

// â”€â”€ FÄ°RMA EKLE/DÃœZENLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCariFirmaModal(firmaId=null){
  const firma = firmaId ? (DB.cariFirmalar||[]).find(f=>f.id===firmaId) : null;
  document.getElementById('modal-cari-firma-title').textContent = firma ? 'âœ Firma DÃ¼zenle' : 'ğŸ¢ Firma Ekle';
  document.getElementById('f-cari-ad').value      = firma?.ad||'';
  document.getElementById('f-cari-sektor').value  = firma?.sektor||'TedarikÃ§i';
  document.getElementById('f-cari-yetkili').value = firma?.yetkili||'';
  document.getElementById('f-cari-tel').value     = firma?.tel||'';
  document.getElementById('f-cari-email').value   = firma?.email||'';
  document.getElementById('f-cari-not').value     = firma?.not||'';
  document.getElementById('modal-cari-firma')._editId = firmaId;
  openModal('modal-cari-firma');
  setTimeout(()=>document.getElementById('f-cari-ad').focus(),100);
}

function saveCariFirma(){
  const ad = document.getElementById('f-cari-ad').value.trim();
  if(!ad){ toast('Firma adÄ± zorunlu','error'); return; }
  const editId = document.getElementById('modal-cari-firma')._editId;
  const obj = {
    ad,
    sektor:  document.getElementById('f-cari-sektor').value,
    yetkili: document.getElementById('f-cari-yetkili').value.trim(),
    tel:     document.getElementById('f-cari-tel').value.trim(),
    email:   document.getElementById('f-cari-email').value.trim(),
    not:     document.getElementById('f-cari-not').value.trim()
  };
  if(editId){
    const idx = (DB.cariFirmalar||[]).findIndex(f=>f.id===editId);
    if(idx>=0) DB.cariFirmalar[idx] = {...DB.cariFirmalar[idx], ...obj};
    toast('Firma gÃ¼ncellendi','success');
  } else {
    obj.id = (typeof crypto!=='undefined'&&crypto.randomUUID)?crypto.randomUUID():Date.now()+'';
    obj.eklenme = today();
    if(!DB.cariFirmalar) DB.cariFirmalar=[];
    DB.cariFirmalar.push(obj);
    secilenCariFirmaId = obj.id;
    toast('Firma eklendi','success');
  }
  saveDB(); closeModal('modal-cari-firma'); renderCari();
}

async function deleteCariFirma(firmaId){
  const firma = (DB.cariFirmalar||[]).find(f=>f.id===firmaId);
  if(!firma) return;
  const hCount = (DB.cariHareketler||[]).filter(h=>h.firmaId===firmaId).length;
  const msg = `"${firma.ad}" firmasÄ± silinsin mi?${hCount>0?' Bu firmaya ait '+hCount+' hareket kaydÄ± da silinecek.':''}`;
  const ok = await customConfirm(msg,'Firma Sil','ğŸ—‘ Sil',true);
  if(!ok) return;
  DB.cariFirmalar    = (DB.cariFirmalar||[]).filter(f=>f.id!==firmaId);
  DB.cariHareketler  = (DB.cariHareketler||[]).filter(h=>h.firmaId!==firmaId);
  if(secilenCariFirmaId===firmaId) secilenCariFirmaId=null;
  saveDB(); renderCari(); toast('Firma silindi');
}

// â”€â”€ ARÅÄ°VLE / AKTÄ°FE AL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function archiveCariFirma(firmaId){
  const idx = (DB.cariFirmalar||[]).findIndex(f=>f.id===firmaId);
  if(idx<0) return;
  const firma = DB.cariFirmalar[idx];
  const yeniDurum = !firma.arsivlendi;
  DB.cariFirmalar[idx] = {...firma, arsivlendi: yeniDurum};
  if(yeniDurum && secilenCariFirmaId===firmaId){
    // ArÅŸivlenince detayÄ± gÃ¼ncelle ama seÃ§imi koru
  }
  saveDB();
  renderCari();
  if(secilenCariFirmaId===firmaId) renderCariDetay(firmaId);
  toast(yeniDurum ? 'ğŸ“¦ Firma arÅŸivlendi' : 'ğŸ“¤ Firma aktife alÄ±ndÄ±', yeniDurum ? 'warning' : 'success');
}

// â”€â”€ DROPDOWN MENÃœ YÃ–NETÄ°MÄ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleCariItemMenu(e, menuId){
  e.stopPropagation();
  const allMenus = document.querySelectorAll('.cari-item-dropdown');
  const target = document.getElementById(menuId);
  const isOpen = target?.classList.contains('open');
  allMenus.forEach(m=>m.classList.remove('open'));
  if(!isOpen && target) target.classList.add('open');
}
function closeCariItemMenu(){
  document.querySelectorAll('.cari-item-dropdown').forEach(m=>m.classList.remove('open'));
}
// Sayfa tÄ±klamasÄ±nda dropdown kapat
document.addEventListener('click', ()=>closeCariItemMenu());
// â”€â”€ HAREKET EKLE/DÃœZENLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCariHareketModal(firmaId, hareketId=null){
  const firma = (DB.cariFirmalar||[]).find(f=>f.id===firmaId);
  if(!firma) return;
  const hareket = hareketId ? (DB.cariHareketler||[]).find(h=>h.id===hareketId) : null;

  document.getElementById('modal-cari-hareket-title').textContent =
    (hareket?'âœ Hareket DÃ¼zenle':'+ Hareket Ekle') + ' â€” ' + firma.ad;
  document.getElementById('f-ch-firma-id').value  = firmaId;
  document.getElementById('f-ch-id').value        = hareketId||'';
  document.getElementById('f-ch-tutar').value     = hareket?.tutar||'';
  document.getElementById('f-ch-tarih').value     = hareket?.tarih||today();
  document.getElementById('f-ch-yontem').value    = hareket?.yontem||'Nakit';
  document.getElementById('f-ch-belge').value     = hareket?.belgeNo||'';
  document.getElementById('f-ch-aciklama').value  = hareket?.aciklama||'';
  document.getElementById('f-ch-hd-yansit').checked = hareket ? false : true;

  // Radyo butonu
  const tip = hareket?.tip||'borc';
  document.querySelector(`input[name="ch-tip"][value="${tip}"]`).checked = true;
  chTipChange();

  // Ä°ÅŸ emirleri listesi
  const isSel = document.getElementById('f-ch-is-emri');
  isSel.innerHTML = '<option value="">â€” BaÄŸlantÄ±sÄ±z â€”</option>';
  [...DB.tadilatlar].filter(t=>!t.arsiv).slice().reverse().forEach(t=>{
    const o=document.createElement('option');
    o.value=t.id; o.textContent=`#${t.id} â€” ${t.musteri||'?'} (${fmtDate(t.tarih||t.baslama)})`;
    if(hareket?.isEmriId==t.id) o.selected=true;
    isSel.appendChild(o);
  });

  // HD preview gÃ¼ncelle
  updateChHdPreview(firma.ad);
  openModal('modal-cari-hareket');
  setTimeout(()=>document.getElementById('f-ch-tutar').focus(),100);
}

function editCariHareket(firmaId, hareketId){
  openCariHareketModal(firmaId, hareketId);
}

function chTipChange(){
  const tip = document.querySelector('input[name="ch-tip"]:checked')?.value;
  document.getElementById('lbl-ch-borc').style.borderColor    = tip==='borc'   ? 'var(--red)'   : 'var(--border)';
  document.getElementById('lbl-ch-alacak').style.borderColor  = tip==='alacak' ? 'var(--green)' : 'var(--border)';
  const firmaId = document.getElementById('f-ch-firma-id').value;
  const firma   = (DB.cariFirmalar||[]).find(f=>f.id===firmaId);
  updateChHdPreview(firma?.ad||'Firma');
}

function updateChHdPreview(firmaAd){
  const tip = document.querySelector('input[name="ch-tip"]:checked')?.value;
  const prev = document.getElementById('ch-hd-aciklama-preview');
  if(!prev) return;
  if(tip==='borc')   prev.textContent = `ğŸ“‰ Gider â€” "Cari Ã–deme: ${firmaAd}" kategorisiyle kaydedilecek`;
  else               prev.textContent = `ğŸ“ˆ Gelir â€” "Cari Tahsilat: ${firmaAd}" kategorisiyle kaydedilecek`;
}

function saveCariHareket(){
  const firmaId    = document.getElementById('f-ch-firma-id').value;
  const hareketId  = document.getElementById('f-ch-id').value;
  const tip        = document.querySelector('input[name="ch-tip"]:checked')?.value;
  const tutar      = parseFloat(document.getElementById('f-ch-tutar').value)||0;
  const tarih      = document.getElementById('f-ch-tarih').value||today();
  const yontem     = document.getElementById('f-ch-yontem').value;
  const belgeNo    = document.getElementById('f-ch-belge').value.trim();
  const aciklama   = document.getElementById('f-ch-aciklama').value.trim();
  const isEmriId   = document.getElementById('f-ch-is-emri').value||null;
  const hdYansit   = document.getElementById('f-ch-hd-yansit').checked;

  if(!tutar){ toast('Tutar zorunlu','error'); return; }
  if(!aciklama){ toast('AÃ§Ä±klama zorunlu','error'); return; }

  const firma = (DB.cariFirmalar||[]).find(f=>f.id===firmaId);
  if(!firma){ toast('Firma bulunamadÄ±','error'); return; }

  if(!DB.cariHareketler) DB.cariHareketler=[];

  // Eski HD kaydÄ±nÄ± temizle (edit durumunda)
  if(hareketId){
    const eskiH = DB.cariHareketler.find(h=>h.id===hareketId);
    if(eskiH?.hdKaynakId) DB.hesapDefteri = (DB.hesapDefteri||[]).filter(h=>h.id!==eskiH.hdKaynakId);
  }

  const yeniId = hareketId || ((typeof crypto!=='undefined'&&crypto.randomUUID)?crypto.randomUUID():Date.now()+'');
  const obj = { id:yeniId, firmaId, tip, tutar, tarih, yontem, belgeNo, aciklama, isEmriId, hdYansitildi:false };

  // HD'ye yansÄ±t
  if(hdYansit){
    const hdId = (typeof crypto!=='undefined'&&crypto.randomUUID)?crypto.randomUUID():Date.now()+'_ch';
    if(!DB.hesapDefteri) DB.hesapDefteri=[];
    DB.hesapDefteri.push({
      id: hdId,
      tarih,
      tip:      tip==='borc' ? 'gider' : 'gelir',
      kategori: tip==='borc' ? `Cari Ã–deme: ${firma.ad}` : `Cari Tahsilat: ${firma.ad}`,
      tutar,
      aciklama: `${firma.ad} â€” ${aciklama}${belgeNo?' ['+belgeNo+']':''}`,
      kaynakId: yeniId,
      otomatik: false
    });
    obj.hdYansitildi = true;
    obj.hdKaynakId   = hdId;
  }

  if(hareketId){
    const idx = DB.cariHareketler.findIndex(h=>h.id===hareketId);
    if(idx>=0) DB.cariHareketler[idx]=obj;
    toast('Hareket gÃ¼ncellendi','success');
  } else {
    DB.cariHareketler.push(obj);
    toast('Hareket eklendi','success');
  }

  saveDB(); closeModal('modal-cari-hareket');
  renderCariDetay(firmaId); renderCari();
}

async function deleteCariHareket(firmaId, hareketId){
  const h = (DB.cariHareketler||[]).find(x=>x.id===hareketId);
  if(!h) return;
  const ok = await customConfirm(
    `"${h.aciklama}" hareketi silinsin mi?${h.hdYansitildi?' Ä°liÅŸkili Hesap Defteri kaydÄ± da silinecek.':''}`,
    'Hareketi Sil','ğŸ—‘ Sil',true
  );
  if(!ok) return;
  if(h.hdKaynakId) DB.hesapDefteri=(DB.hesapDefteri||[]).filter(x=>x.id!==h.hdKaynakId);
  DB.cariHareketler=(DB.cariHareketler||[]).filter(x=>x.id!==hareketId);
  saveDB(); renderCariDetay(firmaId); renderCari(); toast('Hareket silindi');
}

// â”€â”€ EXCEL EXPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCariExportModal(firmaId=null){
  const bugun=today(), ayBasi=bugun.substring(0,7)+'-01';
  document.getElementById('cari-exp-bas').value=ayBasi;
  document.getElementById('cari-exp-bit').value=bugun;
  document.getElementById('cari-exp-tarih-ac').checked=true;
  document.getElementById('cari-exp-tip').value='';
  document.getElementById('cari-exp-ozet').checked=true;
  document.getElementById('cari-exp-onizleme').style.display='none';
  cariExpToggle();

  const sel=document.getElementById('cari-exp-firma');
  sel.innerHTML='<option value="__tumfirmalar__">ğŸ¢ TÃ¼m Firmalar</option>';
  (DB.cariFirmalar||[]).forEach(f=>{
    const o=document.createElement('option'); o.value=f.id; o.textContent=f.ad;
    if(f.id===firmaId) o.selected=true;
    sel.appendChild(o);
  });
  openModal('modal-cari-export');
}

function cariExpToggle(){
  const ac=document.getElementById('cari-exp-tarih-ac').checked;
  ['cari-exp-bas','cari-exp-bit'].forEach(id=>document.getElementById(id).disabled=!ac);
}

function _getCariExportData(){
  const firmaVal=document.getElementById('cari-exp-firma').value;
  const tarihAc=document.getElementById('cari-exp-tarih-ac').checked;
  const bas=tarihAc?document.getElementById('cari-exp-bas').value:'';
  const bit=tarihAc?document.getElementById('cari-exp-bit').value:'';
  const tip=document.getElementById('cari-exp-tip').value;
  const firmalar=(DB.cariFirmalar||[]);
  const secilenFirmalar=firmaVal==='__tumfirmalar__'?firmalar:firmalar.filter(f=>f.id===firmaVal);
  let hareketler=[...(DB.cariHareketler||[])];
  if(bas) hareketler=hareketler.filter(h=>(h.tarih||'')>=bas);
  if(bit) hareketler=hareketler.filter(h=>(h.tarih||'')<=bit);
  if(tip) hareketler=hareketler.filter(h=>h.tip===tip);
  return {secilenFirmalar,hareketler,bas,bit};
}

function cariExportOnizle(){
  const {secilenFirmalar,hareketler,bas,bit}=_getCariExportData();
    const topBorc=hareketler.filter(h=>h.tip==='borc').reduce((s,h)=>s+(h.tutar||0),0);
  const topAlacak=hareketler.filter(h=>h.tip==='alacak').reduce((s,h)=>s+(h.tutar||0),0);
  const d=document.getElementById('cari-exp-onizleme');
  d.innerHTML=`<div style="font-weight:700;margin-bottom:6px">ğŸ“Š Ã–nizleme:</div>
    <div style="padding:8px;background:var(--surface);border-radius:6px;border:1px solid var(--border2)">
      <div>ğŸ¢ <b>${secilenFirmalar.length}</b> firma â€” <b>${hareketler.length}</b> hareket${bas?' ('+fmtDate(bas)+' â€” '+fmtDate(bit)+')':''}</div>
      <div style="margin-top:6px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px">
        <div style="text-align:center;padding:6px;background:var(--surface2);border-radius:4px">
          <div style="font-size:10px;color:var(--text3)">BorÃ§</div>
          <div style="font-weight:700;color:var(--red)">${fmtN(topBorc)} â‚º</div>
        </div>
        <div style="text-align:center;padding:6px;background:var(--surface2);border-radius:4px">
          <div style="font-size:10px;color:var(--text3)">Alacak</div>
          <div style="font-weight:700;color:var(--green)">${fmtN(topAlacak)} â‚º</div>
        </div>
        <div style="text-align:center;padding:6px;background:var(--surface2);border-radius:4px">
          <div style="font-size:10px;color:var(--text3)">Net</div>
          <div style="font-weight:700;color:${topAlacak-topBorc>=0?'var(--green)':'var(--red)'}">${fmtN(topAlacak-topBorc)} â‚º</div>
        </div>
      </div>
    </div>`;
  d.style.display='block';
}

function cariExportExcel(){
  if(typeof XLSX==='undefined'){toast('SheetJS yÃ¼klenemedi','error');return;}
  const {secilenFirmalar,hareketler,bas,bit}=_getCariExportData();
  const ozetAc=document.getElementById('cari-exp-ozet').checked;
  const fn=n=>Math.round((n||0)*100)/100;
  const wb=XLSX.utils.book_new();
  const donem=bas?fmtDate(bas)+' â€” '+fmtDate(bit):'TÃ¼m Zamanlar';

  // Her firma iÃ§in ayrÄ± sheet
  secilenFirmalar.forEach(firma=>{
    const fh=hareketler.filter(h=>h.firmaId===firma.id).slice().sort((a,b)=>(a.tarih||'').localeCompare(b.tarih||''));
    const topBorc=fh.filter(h=>h.tip==='borc').reduce((s,h)=>s+(h.tutar||0),0);
    const topAlacak=fh.filter(h=>h.tip==='alacak').reduce((s,h)=>s+(h.tutar||0),0);
    const rows=[];
    rows.push([`${firma.ad} â€” CARÄ° HESAP`,'','','','','','']);
    rows.push([`DÃ¶nem: ${donem}`,'SektÃ¶r: '+firma.sektor,'','','','','']);
    if(firma.yetkili) rows.push([`Yetkili: ${firma.yetkili}`,firma.tel||'','','','','','']);
    rows.push([]);
    rows.push(['Tarih','Tip','AÃ§Ä±klama','Ã–deme YÃ¶ntemi','Belge No','BorÃ§ (â‚º)','Alacak (â‚º)','Ä°ÅŸ Emri','HD']);
    fh.forEach(h=>{
      const isE=h.isEmriId?DB.tadilatlar.find(t=>t.id==h.isEmriId):null;
      rows.push([
        fmtDate(h.tarih),
        h.tip==='borc'?'BorÃ§':'Alacak',
        h.aciklama||'â€”',h.yontem||'â€”',h.belgeNo||'â€”',
        h.tip==='borc'?fn(h.tutar):0,
        h.tip==='alacak'?fn(h.tutar):0,
        isE?'#'+isE.id+' '+isE.musteri:'â€”',
        h.hdYansitildi?'Evet':'â€”'
      ]);
    });
    rows.push([]);
    rows.push(['','','','','TOPLAM:',fn(topBorc),fn(topAlacak),'','']);
    rows.push(['','','','','NET BAKÄ°YE:','',fn(topAlacak-topBorc),'','']);
    const ws=XLSX.utils.aoa_to_sheet(rows);
    ws['!cols']=[{wch:12},{wch:10},{wch:35},{wch:15},{wch:14},{wch:14},{wch:14},{wch:22},{wch:6}];
    const nm=firma.ad.replace(/[\\\/\[\]\*\?:]/g,'').substring(0,31);
    XLSX.utils.book_append_sheet(wb,ws,nm);
  });

  // Ã–zet sheet
  if(ozetAc){
    const ozRows=[['CARÄ° HESAPLAR â€” Ã–ZET RAPORU','','','',''],['DÃ¶nem: '+donem,'','','',''],[]];
    ozRows.push(['Firma','SektÃ¶r','Toplam BorÃ§ (â‚º)','Toplam Alacak (â‚º)','Net Bakiye (â‚º)']);
    let gBorc=0,gAlacak=0;
    secilenFirmalar.forEach(firma=>{
      const fh=hareketler.filter(h=>h.firmaId===firma.id);
      const b=fh.filter(h=>h.tip==='borc').reduce((s,h)=>s+(h.tutar||0),0);
      const a=fh.filter(h=>h.tip==='alacak').reduce((s,h)=>s+(h.tutar||0),0);
      ozRows.push([firma.ad,firma.sektor||'â€”',fn(b),fn(a),fn(a-b)]);
      gBorc+=b; gAlacak+=a;
    });
    ozRows.push([]);
    ozRows.push(['GENEL TOPLAM','',fn(gBorc),fn(gAlacak),fn(gAlacak-gBorc)]);
    const ws2=XLSX.utils.aoa_to_sheet(ozRows);
    ws2['!cols']=[{wch:28},{wch:16},{wch:16},{wch:16},{wch:16}];
    XLSX.utils.book_append_sheet(wb,ws2,'Ã–zet');
  }

  const tarihSuffix=bas?'_'+bas.replace(/-/g,'')+'_'+bit.replace(/-/g,''):'_'+today().replace(/-/g,'');
  XLSX.writeFile(wb,`CariHesaplar${tarihSuffix}.xlsx`);
  closeModal('modal-cari-export');
  toast('âœ… Excel dosyasÄ± indirildi!','success');
}

</script>
<script>
// â”€â”€ PASSIVE SCROLL OPTÄ°MÄ°ZASYONU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Touch ve wheel event'leri passive yap â€” scroll jank'i Ã¶nle
['touchstart','touchmove','wheel'].forEach(evt=>{
  document.addEventListener(evt, ()=>{}, {passive:true});
});

// â”€â”€ SERVICE WORKER KAYDI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if('serviceWorker' in navigator){
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => {
        console.log('[SW] KayÄ±t baÅŸarÄ±lÄ±:', reg.scope);
        // GÃ¼ncelleme geldiÄŸinde kullanÄ±cÄ±ya bildir
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if(newWorker.state === 'installed' && navigator.serviceWorker.controller){
              toast('ğŸ”„ Uygulama gÃ¼ncellendi â€” sayfayÄ± yenileyebilirsiniz', 'info');
            }
          });
        });
      })
      .catch(err => console.warn('[SW] KayÄ±t baÅŸarÄ±sÄ±z:', err));
  });
}

// â”€â”€ PWA YÃœKLEME BUTONU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _pwaInstallPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  _pwaInstallPrompt = e;
  // Kurulum butonunu gÃ¶ster
  const btn = document.getElementById('pwa-install-btn');
  if(btn) btn.style.display = 'flex';
});

window.addEventListener('appinstalled', () => {
  _pwaInstallPrompt = null;
  const btn = document.getElementById('pwa-install-btn');
  if(btn) btn.style.display = 'none';
  toast('âœ… Royal Muhasebe masaÃ¼stÃ¼ne yÃ¼klendi!', 'success');
});

function pwaInstall(){
  if(!_pwaInstallPrompt) return;
  _pwaInstallPrompt.prompt();
  _pwaInstallPrompt.userChoice.then(choice => {
    if(choice.outcome === 'accepted') _pwaInstallPrompt = null;
  });
}
</script>
</body>
</html>
